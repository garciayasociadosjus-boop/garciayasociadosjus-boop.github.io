<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fondo de Reparo - Estudio Jurídico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        h1 {
            text-align: center;
            color: #1a237e;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 700px;
        }
        th {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #0d47a1;
            font-weight: bold;
            font-size: 0.9em;
        }
        td {
            padding: 8px 6px;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: middle;
        }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f0f8ff; }
        .mes-column { text-align: left; font-weight: bold; }
        .input-field {
            width: 100%; padding: 6px 4px; border: 1px solid #ccc;
            border-radius: 4px; text-align: right; font-size: 13px;
            box-sizing: border-box; min-width: 80px;
        }
        .calculated-field {
            background-color: #f8f8f8; color: #333; font-weight: bold;
            min-height: 20px; padding: 8px; border-radius: 4px; font-size: 13px;
        }
        .liberable { color: #388e3c; }
        .no-liberable { color: #d32f2f; }
        .year-section { margin: 20px 0; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; }
        .year-title {
            background-color: #1a237e; color: white; padding: 10px;
            margin: -10px -10px 15px -10px; border-radius: 6px 6px 0 0;
            font-size: 16px; font-weight: bold; display: flex;
            justify-content: space-between; align-items: center;
        }
        .controls {
            text-align: center; margin-top: 20px; display: flex;
            flex-wrap: wrap; justify-content: center; gap: 10px;
        }
        .controls button, .delete-year-btn {
            background-color: #1a237e; color: white; padding: 10px 15px;
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 13px; transition: background-color 0.3s;
        }
        .controls button:hover, .delete-year-btn:hover { background-color: #0d47a1; }
        .delete-year-btn { padding: 6px 12px; font-size: 11px; background-color: #c62828; }
        .delete-year-btn:hover { background-color: #b71c1c; }
        .save-indicator {
            position: fixed; top: 10px; right: 10px; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; font-weight: bold;
            opacity: 0; transition: opacity 0.3s ease; z-index: 1000;
        }
        .save-indicator.saving { background: #ffeaa7; color: #2d3436; opacity: 1; }
        .save-indicator.saved { background: #00b894; color: white; opacity: 1; }
        .percentage-cell { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .percentage-cell .input-field { width: 50px; min-width: 50px; }
        .data-status {
            background: #d4edda; border: 1px solid #c3e6cb; color: #155724;
            padding: 10px; border-radius: 8px; margin: 20px 0;
            text-align: center; font-size: 14px;
        }
        .btn-drive {
            background: linear-gradient(135deg, #4285F4, #357ae8); color: white;
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 14px; transition: all 0.3s ease; margin: 5px;
        }
        .btn-drive:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(66, 133, 244, 0.4); }
        .btn-drive-success { background: linear-gradient(135deg, #34A853, #2e964a); }
        .btn-drive-warning { background: linear-gradient(135deg, #FBBC05, #f2a600); }
        @media (max-width: 768px) {
            .container { padding: 10px; } h1 { font-size: 1.5em; }
            table { font-size: 12px; min-width: 650px; }
            th { padding: 8px 4px; font-size: 11px; }
            td { padding: 6px 3px; }
            .input-field { min-width: 70px; }
            .year-title { flex-direction: column; gap: 10px; align-items: stretch; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator"></div>
    <div class="container">
        <h1>FONDO DE REPARO</h1>
        <div id="years-container"></div>
        <div class="controls">
            <button id="syncDataBtn" style="background: linear-gradient(135deg, #6a1b9a, #4a148c);">🔄 Sincronizar Datos</button>
            <button id="addMonthBtn">Agregar Mes</button>
            <button id="addYearBtn">Agregar Año</button>
            <button id="exportCsvBtn">Exportar a CSV</button>
            <button id="clearDataBtn" style="background-color: #e74c3c;">Limpiar Datos Locales</button>
        </div>
        
        <div id="driveStatus" class="data-status" style="display: none;"></div>
        <section style="text-align: center; margin-top: 30px; border-top: 1px solid #ddd; padding-top: 20px;">
            <button id="connectDriveBtn" class="btn-drive">🔗 Conectar a Drive</button>
            <button id="saveToDriveBtn" class="btn-drive btn-drive-success" style="display:none;">📤 Guardar en Drive</button>
            <button id="loadFromDriveBtn" class="btn-drive btn-drive-warning" style="display:none;">📥 Cargar de Drive</button>
        </section>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            let yearsData = [];
            let allData = [];

            function initializeApp() {
                loadFromLocalStorage();
                recalculateAll();
                renderTables();
                setupEventListeners();
            }

            // =================================================================================
            // FUNCIÓN DE SINCRONIZACIÓN DIRECTA
            // =================================================================================
            function syncAllData() {
                try {
                    let abonosSynced = false;
                    let egresosSynced = false;

                    const abonosDataRaw = localStorage.getItem('abonosData');
                    if (abonosDataRaw) {
                        const abonosData = JSON.parse(abonosDataRaw);
                        const monthlyHonorarios = {};
                        abonosData.forEach(abono => {
                            let monthKey = null;
                            if (abono.mesServicio) {
                                monthKey = `${abono.mesServicio.year}-${String(abono.mesServicio.month + 1).padStart(2, '0')}`;
                            } else if (abono.fechaPago) {
                                const d = new Date(abono.fechaPago + 'T00:00:00');
                                monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            }
                            if (!monthKey) return;

                            const esHonorario = abono.tipo !== 'Pago de Bonos y AP';
                            const esCobrado = ['Pagado', 'Terminado', 'Pago Parcial'].includes(abono.estado);
                            if (esHonorario && esCobrado) {
                                if (!monthlyHonorarios[monthKey]) monthlyHonorarios[monthKey] = 0;
                                const monto = abono.estado === 'Pago Parcial' ? (parseFloat(abono.montoPagado) || 0) : (parseFloat(abono.monto) || 0);
                                monthlyHonorarios[monthKey] += monto;
                            }
                        });
                        
                        yearsData.forEach(yearData => {
                            yearData.months.forEach((monthData, monthIndex) => {
                                const monthKey = `${yearData.year}-${String(monthIndex + 1).padStart(2, '0')}`;
                                monthData.ingreso = monthlyHonorarios[monthKey] || 0;
                            });
                        });
                        abonosSynced = true;
                    }

                    const egresosDataRaw = localStorage.getItem('ingresosEgresosData');
                     if (egresosDataRaw) {
                        const egresosData = JSON.parse(egresosDataRaw);
                        const monthlyGastos = {};
                        Object.keys(egresosData).forEach(monthKey => {
                            const monthTransactions = egresosData[monthKey].transactions || [];
                            let totalEgresos = 0;
                            monthTransactions.forEach(t => {
                                if (t.categoria === 'egreso') {
                                    totalEgresos += parseFloat(t.monto) || 0;
                                }
                            });
                            monthlyGastos[monthKey] = totalEgresos;
                        });

                        yearsData.forEach(yearData => {
                            yearData.months.forEach((monthData, monthIndex) => {
                                const monthKey = `${yearData.year}-${String(monthIndex + 1).padStart(2, '0')}`;
                                monthData.gasto = monthlyGastos[monthKey] || 0;
                            });
                        });
                        egresosSynced = true;
                    }

                    if(abonosSynced || egresosSynced) {
                        recalculateAll();
                        renderTables();
                        saveToLocalStorage();
                        alert('✅ Sincronización completada.');
                    } else {
                        alert('No se encontraron datos en las otras planillas para sincronizar.');
                    }

                } catch (error) {
                    alert('Ocurrió un error durante la sincronización: ' + error.message);
                }
            }
            
            function setupEventListeners() {
                document.getElementById('syncDataBtn').addEventListener('click', syncAllData);
                document.getElementById('addMonthBtn').addEventListener('click', addMonth);
                document.getElementById('addYearBtn').addEventListener('click', addYear);
                document.getElementById('exportCsvBtn').addEventListener('click', exportData);
                document.getElementById('clearDataBtn').addEventListener('click', clearLocalData);
            }
            
            function saveToLocalStorage() {
                try {
                    showSaveIndicator('saving');
                    localStorage.setItem('fondoReparoData', JSON.stringify(yearsData));
                    setTimeout(() => showSaveIndicator('saved'), 200);
                } catch (error) { console.error('Error al guardar:', error); }
            }
            function loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('fondoReparoData');
                    if (saved && JSON.parse(saved).length > 0) {
                        yearsData = JSON.parse(saved);
                    } else {
                        yearsData = [{ year: new Date().getFullYear(), months: meses.map(m => ({ mes: m, ingreso: 0, gasto: 0, porcentaje: 7 })) }];
                    }
                } catch (error) {
                    yearsData = [{ year: new Date().getFullYear(), months: meses.map(m => ({ mes: m, ingreso: 0, gasto: 0, porcentaje: 7 })) }];
                }
            }
            function clearLocalData() {
                if (confirm('¿Está seguro? Se borrarán todos los datos locales.')) {
                    localStorage.removeItem('fondoReparoData');
                    yearsData = [{ year: new Date().getFullYear(), months: meses.map(m => ({ mes: m, ingreso: 0, gasto: 0, porcentaje: 7 })) }];
                    recalculateAll(); renderTables();
                }
            }
            function showSaveIndicator(status) {
                const indicator = document.getElementById('saveIndicator');
                indicator.className = `save-indicator ${status}`;
                if (status === 'saving') indicator.textContent = 'Guardando...';
                else if (status === 'saved') {
                    indicator.textContent = 'Guardado ✓';
                    setTimeout(() => { indicator.className = 'save-indicator'; }, 2000);
                }
            }
            function formatNumber(num) {
                return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0);
            }
            function calculateRetenido(ingreso, porcentaje) { return (parseFloat(ingreso) || 0) * (parseFloat(porcentaje) || 0) / 100; }
            function calculateFondoAcumulado(prevFondo, retenido, gasto) { return (parseFloat(prevFondo) || 0) + (parseFloat(retenido) || 0) - (parseFloat(gasto) || 0); }
            function getFondoClass(fondo) { return fondo < 0 ? 'no-liberable' : 'liberable'; }
            function deleteYear(yearIndex) {
                if (yearsData.length <= 1) { alert('Debe mantener al menos un año.'); return; }
                if (confirm(`¿Eliminar el año ${yearsData[yearIndex].year}?`)) {
                    yearsData.splice(yearIndex, 1);
                    recalculateAll(); renderTables(); saveToLocalStorage();
                }
            }
            function recalculateAll() {
                allData = []; let fondoAcumulado = 0;
                yearsData.forEach(yearData => {
                    yearData.months.forEach(monthData => {
                        const retenido = calculateRetenido(monthData.ingreso, monthData.porcentaje);
                        fondoAcumulado = calculateFondoAcumulado(fondoAcumulado, retenido, monthData.gasto);
                        allData.push({
                            year: yearData.year, mes: monthData.mes, ingreso: monthData.ingreso,
                            porcentaje: monthData.porcentaje, retenido: retenido, gasto: monthData.gasto,
                            fondoAcumulado: fondoAcumulado
                        });
                    });
                });
            }
            function getGlobalIndex(yearIndex, monthIndex) {
                let index = 0;
                for (let i = 0; i < yearIndex; i++) { index += yearsData[i].months.length; }
                return index + monthIndex;
            }
            function createTableRow(yearIndex, monthIndex) {
                const globalIndex = getGlobalIndex(yearIndex, monthIndex);
                const item = allData[globalIndex];
                if (!item) return '';
                const fondoClass = getFondoClass(item.fondoAcumulado);
                return `
                    <tr>
                        <td class="mes-column">${item.mes}</td>
                        <td><div class="calculated-field">${formatNumber(item.ingreso)}</div></td>
                        <td class="percentage-cell">
                            <input type="number" class="input-field" value="${item.porcentaje}" onchange="updatePorcentaje(${yearIndex}, ${monthIndex}, this.value)" step="0.1" min="0" max="100">
                            <span>%</span>
                        </td>
                        <td><div class="calculated-field">${formatNumber(item.retenido)}</div></td>
                        <td><div class="calculated-field">${formatNumber(item.gasto)}</div></td>
                        <td><div class="calculated-field ${fondoClass}">${formatNumber(item.fondoAcumulado)}</div></td>
                    </tr>`;
            }

            function updatePorcentaje(yearIndex, monthIndex, value) {
                yearsData[yearIndex].months[monthIndex].porcentaje = parseFloat(value) || 7;
                recalculateAll(); renderTables(); saveToLocalStorage();
            }

            function renderTables() {
                const container = document.getElementById('years-container');
                container.innerHTML = '';
                yearsData.forEach((yearData, yearIndex) => {
                    const yearSection = document.createElement('div');
                    yearSection.className = 'year-section';
                    yearSection.innerHTML = `
                        <div class="year-title">
                            <span>${yearData.year}</span>
                            ${yearsData.length > 1 ? `<button class="delete-year-btn" onclick="deleteYear(${yearIndex})">Eliminar Año</button>` : ''}
                        </div>
                        <table>
                            <thead><tr>
                                <th style="width: 15%;">Mes</th><th style="width: 20%;">Ingreso</th>
                                <th style="width: 15%;">% Ret.</th><th style="width: 20%;">Retenido</th>
                                <th style="width: 20%;">Gasto</th><th style="width: 25%;">Fondo Acumulado</th>
                            </tr></thead>
                            <tbody id="year${yearIndex}-data"></tbody>
                        </table>`;
                    container.appendChild(yearSection);
                    const tbody = document.getElementById(`year${yearIndex}-data`);
                    yearData.months.forEach((month, monthIndex) => {
                        tbody.innerHTML += createTableRow(yearIndex, monthIndex);
                    });
                });
            }
            
            function addMonth() {
                const lastYear = yearsData[yearsData.length - 1];
                if (lastYear.months.length < 12) {
                    lastYear.months.push({ mes: meses[lastYear.months.length], ingreso: 0, gasto: 0, porcentaje: 7 });
                    recalculateAll(); renderTables(); saveToLocalStorage();
                } else {
                    alert('Este año ya tiene 12 meses. Usa "Agregar Año".');
                }
            }
            function addYear() {
                const newYear = yearsData[yearsData.length - 1].year + 1;
                yearsData.push({ year: newYear, months: [{ mes: 'Enero', ingreso: 0, gasto: 0, porcentaje: 7 }] });
                recalculateAll(); renderTables(); saveToLocalStorage();
            }
            function exportData() {
                recalculateAll();
                const csvContent = [
                    ['Año', 'Mes', 'Ingreso', '% Retención', 'Retenido', 'Gasto', 'Fondo Acumulado'],
                    ...allData.map(item => [item.year, item.mes, item.ingreso, item.porcentaje, item.retenido, item.gasto, item.fondoAcumulado].map(v=>String(v).replace('.',',')).join(';'))
                ].join('\n');
                const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `fondo_reparo_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
            
            initializeApp();
        });
    </script>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded"></script>
    <script>
        // =================================================================================
        // LÓGICA DE GOOGLE DRIVE
        // =================================================================================
        const CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
        const API_KEY = 'YOUR_API_KEY'; // Reemplazar si es necesario
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DATA_FILE_NAME = 'datos_fondo_reparo.json';

        let tokenClient, gapiInited = false, gisInited = false, dataFileId = null;
        
        function gapiLoaded() { gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() { 
            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }).catch(err => console.error("Error initializing GAPI client", err)); 
            gapiInited = true; 
            maybeEnableButtons(); 
        }
        function gisLoaded() { 
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); 
            gisInited = true; 
            maybeEnableButtons(); 
        }
        function maybeEnableButtons() { 
            if (gapiInited && gisInited) {
                document.getElementById('connectDriveBtn').onclick = handleAuthClick;
            }
        }
        function updateDriveStatus(message, isSuccess = false) {
            const driveStatusEl = document.getElementById('driveStatus');
            driveStatusEl.style.display = 'block';
            driveStatusEl.textContent = message;
            driveStatusEl.style.background = isSuccess ? '#d1e7dd' : '#fff3cd';
            driveStatusEl.style.color = isSuccess ? '#0f5132' : '#664d03';
        }

        function handleAuthClick() {
            tokenClient.callback = async (resp) => {
                if (resp.error) {
                    console.error(resp.error);
                    updateDriveStatus('❌ Error de autenticación.', false);
                    return;
                };
                updateDriveStatus('✅ Conectado a Google Drive.', true);
                document.getElementById('connectDriveBtn').style.display = 'none'; 
                document.getElementById('saveToDriveBtn').style.display = 'inline-block'; 
                document.getElementById('loadFromDriveBtn').style.display = 'inline-block';
                document.getElementById('saveToDriveBtn').onclick = saveDataToDrive; 
                document.getElementById('loadFromDriveBtn').onclick = loadDataFromDrive;
                await findDataFile();
            };
            if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'}); 
            else tokenClient.requestAccessToken({prompt: ''});
        }
        async function findDataFile() {
            updateDriveStatus('Buscando archivo de datos en Drive...', false);
            try {
                const response = await gapi.client.drive.files.list({ q: `name='${DATA_FILE_NAME}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
                if (response.result.files.length > 0) { 
                    dataFileId = response.result.files[0].id; 
                    updateDriveStatus('✅ Archivo de datos encontrado. Puede cargar los datos.', true); 
                } else { 
                    updateDriveStatus('⚠️ Archivo no encontrado. Se creará uno nuevo al guardar.', false); 
                    dataFileId = null; 
                }
            } catch (err) { console.error(err); alert('Error al buscar el archivo de datos en Drive.'); }
        }
        async function saveDataToDrive() {
            if (!confirm('¿Guardar los datos actuales en Google Drive?')) return;
            updateDriveStatus('Guardando datos en Drive...', false);
            try {
                const content = JSON.stringify(window.yearsData, null, 2);
                const boundary = '-------314159265358979323846';
                const metadata = { name: DATA_FILE_NAME, mimeType: 'application/json' };
                const requestBody = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${content}\r\n--${boundary}--`;
                
                const request = gapi.client.request({
                    path: dataFileId ? `/upload/drive/v3/files/${dataFileId}` : '/upload/drive/v3/files',
                    method: dataFileId ? 'PATCH' : 'POST',
                    params: { uploadType: 'multipart' },
                    headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
                    body: requestBody
                });

                const response = await request;
                dataFileId = response.result.id;
                updateDriveStatus('✅ ¡Datos guardados en Drive con éxito!', true);
            } catch (err) { 
                console.error(err); 
                updateDriveStatus('❌ Error al guardar en Drive.', false); 
            }
        }

        async function loadDataFromDrive() {
            if (!dataFileId) { alert("No se ha encontrado un archivo de datos. Guarda primero para crear uno."); return; }
            if (!confirm("¿Seguro? Se reemplazarán los datos locales con los de Drive.")) return;
            
            updateDriveStatus('Cargando datos desde Drive...', false);
            try {
                const response = await gapi.client.drive.files.get({ fileId: dataFileId, alt: 'media' });
                const importedData = JSON.parse(response.body);
                
                if (!Array.isArray(importedData)) { throw new Error('El formato de los datos de Drive no es válido.'); }
                
                window.yearsData = importedData;
                window.recalculateAll();
                window.renderTables();
                window.saveToLocalStorage();
                updateDriveStatus('✅ Datos cargados desde Drive con éxito.', true);

            } catch (err) { 
                console.error(err); 
                updateDriveStatus('❌ Error al cargar desde Drive.', false); 
                alert('Error al cargar desde Drive: ' + err.message); 
            }
        }
    </script>
</body>
</html>
