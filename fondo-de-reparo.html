<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fondo de Reparo - Estudio JurÃ­dico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        h1 {
            text-align: center;
            color: #1a237e;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            min-width: 700px;
        }
        th {
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #0d47a1;
            font-weight: bold;
            font-size: 0.9em;
        }
        td {
            padding: 8px 6px;
            border: 1px solid #ddd;
            text-align: center;
            vertical-align: middle;
        }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f0f8ff; }
        .mes-column { text-align: left; font-weight: bold; }
        .input-field {
            width: 100%; padding: 6px 4px; border: 1px solid #ccc;
            border-radius: 4px; text-align: right; font-size: 13px;
            box-sizing: border-box; min-width: 80px;
        }
        .calculated-field {
            background-color: #f8f8f8; color: #333; font-weight: bold;
            min-height: 20px; padding: 8px; border-radius: 4px; font-size: 13px;
        }
        .liberable { color: #388e3c; }
        .no-liberable { color: #d32f2f; }
        .year-section { margin: 20px 0; border: 2px solid #e0e0e0; border-radius: 8px; padding: 10px; }
        .year-title {
            background-color: #1a237e; color: white; padding: 10px;
            margin: -10px -10px 15px -10px; border-radius: 6px 6px 0 0;
            font-size: 16px; font-weight: bold; display: flex;
            justify-content: space-between; align-items: center;
        }
        .controls {
            text-align: center; margin-top: 20px; display: flex;
            flex-wrap: wrap; justify-content: center; gap: 10px;
        }
        .controls button, .delete-year-btn {
            background-color: #1a237e; color: white; padding: 10px 15px;
            border: none; border-radius: 5px; cursor: pointer;
            font-size: 13px; transition: background-color 0.3s;
        }
        .controls button:hover, .delete-year-btn:hover { background-color: #0d47a1; }
        .delete-year-btn { padding: 6px 12px; font-size: 11px; background-color: #c62828; }
        .delete-year-btn:hover { background-color: #b71c1c; }
        .save-indicator {
            position: fixed; top: 10px; right: 10px; padding: 8px 16px;
            border-radius: 20px; font-size: 12px; font-weight: bold;
            opacity: 0; transition: opacity 0.3s ease; z-index: 1000;
        }
        .save-indicator.saving { background: #ffeaa7; color: #2d3436; opacity: 1; }
        .save-indicator.saved { background: #00b894; color: white; opacity: 1; }
        .percentage-cell { display: flex; align-items: center; justify-content: center; gap: 4px; }
        .percentage-cell .input-field { width: 50px; min-width: 50px; }
        @media (max-width: 768px) {
            .container { padding: 10px; } h1 { font-size: 1.5em; }
            table { font-size: 12px; min-width: 650px; }
            th { padding: 8px 4px; font-size: 11px; }
            td { padding: 6px 3px; }
            .input-field { min-width: 70px; }
            .year-title { flex-direction: column; gap: 10px; align-items: stretch; }
            .controls { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="save-indicator" id="saveIndicator"></div>
    <div class="container">
        <h1>FONDO DE REPARO</h1>
        <div id="years-container"></div>
        <div class="controls">
            <button id="syncDataBtn" style="background: linear-gradient(135deg, #6a1b9a, #4a148c);">ðŸ”„ Sincronizar Datos</button>
            <button id="addMonthBtn">Agregar Mes</button>
            <button id="addYearBtn">Agregar AÃ±o</button>
            <button id="exportCsvBtn">Exportar a CSV</button>
            <button id="clearDataBtn" style="background-color: #e74c3c;">Limpiar Datos Locales</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            let yearsData = [];
            let allData = [];

            function initializeApp() {
                loadFromLocalStorage();
                recalculateAll();
                renderTables();
                setupEventListeners();
            }

            // =================================================================================
            // FUNCIÃ“N DE SINCRONIZACIÃ“N DIRECTA
            // =================================================================================
            function syncAllData() {
                try {
                    let abonosSynced = false;
                    let egresosSynced = false;

                    // --- 1. Sincronizar Ingresos desde Abonos ---
                    const abonosDataRaw = localStorage.getItem('abonosData');
                    if (!abonosDataRaw) {
                        console.warn('No se encontraron datos de Abonos para sincronizar los Ingresos.');
                    } else {
                        const abonosData = JSON.parse(abonosDataRaw);
                        const monthlyHonorarios = {};
                        abonosData.forEach(abono => {
                            let monthKey = null;
                            if (abono.mesServicio) {
                                monthKey = `${abono.mesServicio.year}-${String(abono.mesServicio.month + 1).padStart(2, '0')}`;
                            } else if (abono.fechaPago) {
                                const d = new Date(abono.fechaPago + 'T00:00:00');
                                monthKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                            }
                            if (!monthKey) return;

                            const esHonorario = abono.tipo !== 'Pago de Bonos y AP';
                            const esCobrado = ['Pagado', 'Terminado', 'Pago Parcial'].includes(abono.estado);
                            if (esHonorario && esCobrado) {
                                if (!monthlyHonorarios[monthKey]) monthlyHonorarios[monthKey] = 0;
                                const monto = abono.estado === 'Pago Parcial' ? (parseFloat(abono.montoPagado) || 0) : (parseFloat(abono.monto) || 0);
                                monthlyHonorarios[monthKey] += monto;
                            }
                        });
                        
                        yearsData.forEach(yearData => {
                            yearData.months.forEach((monthData, monthIndex) => {
                                const monthKey = `${yearData.year}-${String(monthIndex + 1).padStart(2, '0')}`;
                                // Se asegura de que si no hay ingresos para un mes, se ponga 0.
                                monthData.ingreso = monthlyHonorarios[monthKey] || 0;
                            });
                        });
                        abonosSynced = true;
                    }

                    // --- 2. Sincronizar Gastos desde Egresos ---
                    const egresosDataRaw = localStorage.getItem('ingresosEgresosData');
                     if (!egresosDataRaw) {
                        console.warn('No se encontraron datos de Egresos para sincronizar los Gastos.');
                    } else {
                        const egresosData = JSON.parse(egresosDataRaw);
                        const monthlyGastos = {};
                        Object.keys(egresosData).forEach(monthKey => {
                            const monthTransactions = egresosData[monthKey].transactions || [];
                            let totalEgresos = 0;
                            monthTransactions.forEach(t => {
                                if (t.categoria === 'egreso') {
                                    totalEgresos += parseFloat(t.monto) || 0;
                                }
                            });
                            monthlyGastos[monthKey] = totalEgresos;
                        });

                        yearsData.forEach(yearData => {
                            yearData.months.forEach((monthData, monthIndex) => {
                                const monthKey = `${yearData.year}-${String(monthIndex + 1).padStart(2, '0')}`;
                                // Se asegura de que si no hay gastos para un mes, se ponga 0.
                                monthData.gasto = monthlyGastos[monthKey] || 0;
                            });
                        });
                        egresosSynced = true;
                    }

                    // --- 3. Recalcular, guardar y renderizar todo ---
                    if(abonosSynced || egresosSynced) {
                        recalculateAll();
                        renderTables();
                        saveToLocalStorage();
                        alert('âœ… SincronizaciÃ³n completada. Los datos de Ingresos y Gastos han sido actualizados.');
                    } else {
                        alert('No se encontraron datos en las otras planillas para sincronizar. AsegÃºrese de haberlas usado al menos una vez.');
                    }

                } catch (error) {
                    alert('OcurriÃ³ un error durante la sincronizaciÃ³n: ' + error.message);
                    console.error("Error en syncAllData:", error);
                }
            }
            
            function setupEventListeners() {
                document.getElementById('syncDataBtn').addEventListener('click', syncAllData);
                document.getElementById('addMonthBtn').addEventListener('click', addMonth);
                document.getElementById('addYearBtn').addEventListener('click', addYear);
                document.getElementById('exportCsvBtn').addEventListener('click', exportData);
                document.getElementById('clearDataBtn').addEventListener('click', clearLocalData);
            }
            
            function saveToLocalStorage() {
                try {
                    showSaveIndicator('saving');
                    localStorage.setItem('fondoReparoData', JSON.stringify(yearsData));
                    setTimeout(() => showSaveIndicator('saved'), 200);
                } catch (error) { console.error('Error al guardar:', error); }
            }
            function loadFromLocalStorage() {
                try {
                    const saved = localStorage.getItem('fondoReparoData');
                    if (saved && JSON.parse(saved).length > 0) {
                        yearsData = JSON.parse(saved);
                    } else {
                        yearsData = [{ year: new Date().getFullYear(), months: meses.map(m => ({ mes: m, ingreso: 0, gasto: 0, porcentaje: 7 })) }];
                    }
                } catch (error) {
                    console.error('Error al cargar:', error);
                    yearsData = [{ year: new Date().getFullYear(), months: meses.map(m => ({ mes: m, ingreso: 0, gasto: 0, porcentaje: 7 })) }];
                }
            }
            function clearLocalData() {
                if (confirm('Â¿EstÃ¡ seguro? Se borrarÃ¡n todos los datos locales.')) {
                    localStorage.removeItem('fondoReparoData');
                    yearsData = [{ year: new Date().getFullYear(), months: meses.map(m => ({ mes: m, ingreso: 0, gasto: 0, porcentaje: 7 })) }];
                    recalculateAll(); renderTables();
                }
            }
            function showSaveIndicator(status) {
                const indicator = document.getElementById('saveIndicator');
                indicator.className = `save-indicator ${status}`;
                if (status === 'saving') indicator.textContent = 'Guardando...';
                else if (status === 'saved') {
                    indicator.textContent = 'Guardado âœ“';
                    setTimeout(() => { indicator.className = 'save-indicator'; }, 2000);
                }
            }
            function formatNumber(num) {
                return new Intl.NumberFormat('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0);
            }
            function calculateRetenido(ingreso, porcentaje) { return (parseFloat(ingreso) || 0) * (parseFloat(porcentaje) || 0) / 100; }
            function calculateFondoAcumulado(prevFondo, retenido, gasto) { return (parseFloat(prevFondo) || 0) + (parseFloat(retenido) || 0) - (parseFloat(gasto) || 0); }
            function getFondoClass(fondo) { return fondo < 0 ? 'no-liberable' : 'liberable'; }
            function deleteYear(yearIndex) {
                if (yearsData.length <= 1) { alert('Debe mantener al menos un aÃ±o.'); return; }
                if (confirm(`Â¿Eliminar el aÃ±o ${yearsData[yearIndex].year}?`)) {
                    yearsData.splice(yearIndex, 1);
                    recalculateAll(); renderTables(); saveToLocalStorage();
                }
            }
            function recalculateAll() {
                allData = []; let fondoAcumulado = 0;
                yearsData.forEach(yearData => {
                    yearData.months.forEach(monthData => {
                        const retenido = calculateRetenido(monthData.ingreso, monthData.porcentaje);
                        fondoAcumulado = calculateFondoAcumulado(fondoAcumulado, retenido, monthData.gasto);
                        allData.push({
                            year: yearData.year, mes: monthData.mes, ingreso: monthData.ingreso,
                            porcentaje: monthData.porcentaje, retenido: retenido, gasto: monthData.gasto,
                            fondoAcumulado: fondoAcumulado
                        });
                    });
                });
            }
            function getGlobalIndex(yearIndex, monthIndex) {
                let index = 0;
                for (let i = 0; i < yearIndex; i++) { index += yearsData[i].months.length; }
                return index + monthIndex;
            }
            function createTableRow(yearIndex, monthIndex) {
                const globalIndex = getGlobalIndex(yearIndex, monthIndex);
                const item = allData[globalIndex];
                if (!item) return '';
                const fondoClass = getFondoClass(item.fondoAcumulado);
                // Las celdas de Ingreso y Gasto ahora son fijas y no editables
                return `
                    <tr>
                        <td class="mes-column">${item.mes}</td>
                        <td><div class="calculated-field">${formatNumber(item.ingreso)}</div></td>
                        <td class="percentage-cell">
                            <input type="number" class="input-field" value="${item.porcentaje}" onchange="updatePorcentaje(${yearIndex}, ${monthIndex}, this.value)" step="0.1" min="0" max="100">
                            <span>%</span>
                        </td>
                        <td><div class="calculated-field">${formatNumber(item.retenido)}</div></td>
                        <td><div class="calculated-field">${formatNumber(item.gasto)}</div></td>
                        <td><div class="calculated-field ${fondoClass}">${formatNumber(item.fondoAcumulado)}</div></td>
                    </tr>`;
            }

            function updatePorcentaje(yearIndex, monthIndex, value) {
                yearsData[yearIndex].months[monthIndex].porcentaje = parseFloat(value) || 7;
                recalculateAll(); renderTables(); saveToLocalStorage();
            }

            function renderTables() {
                const container = document.getElementById('years-container');
                container.innerHTML = '';
                yearsData.forEach((yearData, yearIndex) => {
                    const yearSection = document.createElement('div');
                    yearSection.className = 'year-section';
                    yearSection.innerHTML = `
                        <div class="year-title">
                            <span>${yearData.year}</span>
                            ${yearsData.length > 1 ? `<button class="delete-year-btn" onclick="deleteYear(${yearIndex})">Eliminar AÃ±o</button>` : ''}
                        </div>
                        <table>
                            <thead><tr>
                                <th style="width: 15%;">Mes</th><th style="width: 20%;">Ingreso</th>
                                <th style="width: 15%;">% Ret.</th><th style="width: 20%;">Retenido</th>
                                <th style="width: 20%;">Gasto</th><th style="width: 25%;">Fondo Acumulado</th>
                            </tr></thead>
                            <tbody id="year${yearIndex}-data"></tbody>
                        </table>`;
                    container.appendChild(yearSection);
                    const tbody = document.getElementById(`year${yearIndex}-data`);
                    yearData.months.forEach((month, monthIndex) => {
                        tbody.innerHTML += createTableRow(yearIndex, monthIndex);
                    });
                });
            }
            
            function addMonth() {
                const lastYear = yearsData[yearsData.length - 1];
                if (lastYear.months.length < 12) {
                    lastYear.months.push({ mes: meses[lastYear.months.length], ingreso: 0, gasto: 0, porcentaje: 7 });
                    recalculateAll(); renderTables(); saveToLocalStorage();
                } else {
                    alert('Este aÃ±o ya tiene 12 meses. Usa "Agregar AÃ±o".');
                }
            }
            function addYear() {
                const newYear = yearsData[yearsData.length - 1].year + 1;
                yearsData.push({ year: newYear, months: [{ mes: 'Enero', ingreso: 0, gasto: 0, porcentaje: 7 }] });
                recalculateAll(); renderTables(); saveToLocalStorage();
            }
            function exportData() {
                recalculateAll();
                const csvContent = [
                    ['AÃ±o', 'Mes', 'Ingreso', '% RetenciÃ³n', 'Retenido', 'Gasto', 'Fondo Acumulado'],
                    ...allData.map(item => [item.year, item.mes, item.ingreso, item.porcentaje, item.retenido, item.gasto, item.fondoAcumulado].map(v=>String(v).replace('.',',')).join(';'))
                ].join('\n');
                const blob = new Blob([`\ufeff${csvContent}`], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `fondo_reparo_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }
            
            initializeApp();
        });
    </script>
</body>
</html>
