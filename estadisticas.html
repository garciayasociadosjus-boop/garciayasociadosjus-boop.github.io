<!DOCTYPE html>
<html lang="es-AR">
<head>
    <meta charset="UTF-8">
    <title>Estad√≠sticas - Garc√≠a & Asociados</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1e3a8a; --secondary-color: #1e293b; --success-color: #059669; --danger-color: #dc2626; --warning-color: #f59e0b; --info-color: #6366f1; --light-bg: #f8fafc; --text-dark: #1e293b; --text-light: #f1f5f9;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f1f5f9; min-height: 100vh; padding: 20px; color: var(--text-dark); }
        .container { max-width: 1600px; margin: 0 auto; background: #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,.1); overflow: hidden; }
        .header { background: linear-gradient(135deg, var(--secondary-color), var(--primary-color)); color: var(--text-light); padding: 30px; text-align: center; border-bottom: 5px solid var(--primary-color); }
        .header h1 { font-size: 2.2em; margin-bottom: 8px; }
        .main-content { padding: 30px; }
        .controls { background: var(--light-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-weight: 600; font-size: .85em; }
        .form-group select { padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: .9em; }
        .btn { background: var(--primary-color); color: var(--text-light); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: .9em; transition: .25s; font-weight: 600; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(30,58,138,.3); }
        .btn-success { background: var(--success-color); }
        .btn-warning { background: var(--warning-color); }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; }
        .chart-container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,.07); border: 1px solid #e2e8f0; }
        .chart-container h3 { text-align: center; margin-bottom: 20px; color: var(--secondary-color); }
        .data-status { text-align: center; padding: 10px; border-radius: 8px; margin: 10px 0 20px 0; font-weight: bold; }
        .status-success { background: #d1e7dd; color: #0f5132; }
        .status-warning { background: #fff3cd; color: #664d03; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--light-bg); border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,.07); border-left: 5px solid var(--primary-color); }
        .card h3 { color: var(--secondary-color); margin-bottom: 10px; font-size: 0.9em; text-transform: uppercase; }
        .card .value { font-size: 1.5em; font-weight: 700; color: var(--primary-color); }
        .card .value.positive { color: var(--success-color); }
        .card .value.negative { color: var(--danger-color); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìä Estad√≠sticas y Gr√°ficos</h1>
            <p>Portal de Visualizaci√≥n de Datos del Estudio</p>
        </header>

        <main class="main-content">
            <div id="dataStatus" class="data-status" style="display:none;"></div>

            <div class="controls">
                <button class="btn btn-success" id="syncButton">üîÑ Sincronizar Datos (Local)</button>
                <div class="form-group">
                    <label for="yearFilter">A√±o:</label>
                    <select id="yearFilter"></select>
                </div>
                <div class="form-group">
                    <label for="monthFilter">Mes:</label>
                    <select id="monthFilter"></select>
                </div>
                 <div class="form-group">
                    <label for="chartTypeSelector">Tipo de Gr√°fico:</label>
                    <select id="chartTypeSelector">
                        <option value="bar">Barras</option>
                        <option value="line">L√≠neas</option>
                    </select>
                </div>
            </div>
             <div style="text-align:center;margin-bottom:30px;border-top:1px solid #ddd;padding-top:20px;">
                <button id="connectDriveBtn" class="btn">üîó Conectar a Drive</button>
                <button id="saveToDriveBtn" class="btn btn-success" style="display:none;">üì§ Guardar Respaldo en Drive</button>
                <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;">üì• Cargar Respaldo de Drive</button>
            </div>
            
            <div id="dashboard" class="dashboard">
                 <div class="card"><h3 id="kpiTitle">Resumen del Per√≠odo</h3><div class="value" id="kpiPeriodo"></div></div>
                 <div class="card"><h3>Total Ingresos</h3><div class="value positive" id="kpiIngresos"></div></div>
                 <div class="card"><h3>Total Egresos</h3><div class="value negative" id="kpiEgresos"></div></div>
                 <div class="card"><h3>Balance</h3><div class="value" id="kpiBalance"></div></div>
                 <div class="card"><h3>Casos Activos</h3><div class="value" id="kpiCasos"></div></div>
                 <div class="card"><h3>Ingreso / Caso</h3><div class="value" id="kpiIngresoPorCaso"></div></div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Ingresos vs. Egresos Mensuales (A√±o Completo)</h3>
                    <canvas id="ingresosEgresosChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Distribuci√≥n de Ingresos (A√±o Completo)</h3>
                    <canvas id="distribucionIngresosChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Volumen de Casos (Actividad Mensual - A√±o Completo)</h3>
                    <canvas id="casosChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const allData = { siniestros: [], juridica: [], abonos: [], egresos: {} };
            const charts = {};
            const statusEl = document.getElementById('dataStatus');
            const yearFilterEl = document.getElementById('yearFilter');
            const monthFilterEl = document.getElementById('monthFilter');
            const chartTypeSelectorEl = document.getElementById('chartTypeSelector');
            const mesesLabels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];

            function updateStatus(message, type = 'success') {
                statusEl.textContent = message;
                statusEl.className = `data-status status-${type}`;
                statusEl.style.display = 'block';
                setTimeout(() => { statusEl.style.display = 'none'; }, 4000);
            }

            function sincronizarDatos() {
                try {
                    allData.siniestros = JSON.parse(localStorage.getItem('planilla_siniestros_data')) || [];
                    allData.juridica = JSON.parse(localStorage.getItem('planilla_juridica_data')) || [];
                    allData.abonos = JSON.parse(localStorage.getItem('abonosData')) || [];
                    allData.egresos = JSON.parse(localStorage.getItem('ingresosEgresosData')) || {};
                    updateStatus('‚úÖ Datos locales sincronizados correctamente.');
                    poblarSelectores();
                    render();
                } catch (error) {
                    console.error("Error al sincronizar:", error);
                    updateStatus('‚ùå Error al sincronizar los datos. Verifique la consola.', 'warning');
                }
            }

            function poblarSelectores() {
                const years = new Set();
                [...allData.siniestros, ...allData.juridica, ...allData.abonos].forEach(item => {
                    const date = item.fechaRevision || item.proximaRevision || item.fechaPago || (item.mesServicio ? `${item.mesServicio.year}-${item.mesServicio.month + 1}-01` : null);
                    if (date) years.add(new Date(date + 'T00:00:00Z').getFullYear());
                });
                Object.keys(allData.egresos).forEach(monthKey => years.add(parseInt(monthKey.split('-')[0])));

                const currentYear = yearFilterEl.value;
                yearFilterEl.innerHTML = '';
                const sortedYears = Array.from(years).sort((a, b) => b - a);
                sortedYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearFilterEl.appendChild(option);
                });
                if(sortedYears.includes(parseInt(currentYear))) yearFilterEl.value = currentYear;

                monthFilterEl.innerHTML = '<option value="todos">A√±o Completo</option>';
                mesesLabels.forEach((mes, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = mes;
                    monthFilterEl.appendChild(option);
                });
            }

            function procesarDatos(year) {
                const dataTemplate = () => ({
                    ingresos: { total: 0, abonos: 0, siniestros: 0 },
                    egresos: 0,
                    casos: { juridica: 0, siniestros: 0, total: 0 }
                });
                const monthlyData = Array.from({ length: 12 }, dataTemplate);

                const parseDate = (dateStr) => dateStr ? new Date(dateStr + 'T00:00:00Z') : null;

                allData.abonos.forEach(abono => {
                    const fecha = parseDate(abono.fechaPago);
                    if (fecha && fecha.getFullYear() === year && (abono.estado === 'Pagado' || abono.estado === 'Pago Parcial')) {
                        const month = fecha.getMonth();
                        const monto = parseFloat(abono.estado === 'Pago Parcial' ? abono.montoPagado : abono.monto) || 0;
                        if (abono.tipo !== 'Pago de Bonos y AP') monthlyData[month].ingresos.abonos += monto;
                    }
                });

                allData.siniestros.forEach(s => {
                    const fechaPago = parseDate(s.fechaPago);
                    const honorarios = parseFloat(s.honorarios) || 0;
                    if (honorarios > 0 && fechaPago && fechaPago.getFullYear() === year) {
                        monthlyData[fechaPago.getMonth()].ingresos.siniestros += honorarios;
                    }
                    const fechaActividad = parseDate(s.fechaRevision) || parseDate(s.proximaRevision);
                    if (fechaActividad && fechaActividad.getFullYear() === year) {
                        monthlyData[fechaActividad.getMonth()].casos.siniestros++;
                    }
                });

                allData.juridica.forEach(c => {
                    const fechaActividad = parseDate(c.proximaRevision);
                    if (fechaActividad && fechaActividad.getFullYear() === year) {
                        monthlyData[fechaActividad.getMonth()].casos.juridica++;
                    }
                });

                Object.keys(allData.egresos).forEach(monthKey => {
                    const [dataYear, dataMonth] = monthKey.split('-').map(Number);
                    if (dataYear === year) {
                        const monthIndex = dataMonth - 1;
                        allData.egresos[monthKey].transactions?.forEach(t => {
                            if (t.categoria === 'egreso') monthlyData[monthIndex].egresos += parseFloat(t.monto) || 0;
                        });
                    }
                });

                monthlyData.forEach(data => {
                    data.ingresos.total = data.ingresos.abonos + data.ingresos.siniestros;
                    data.casos.total = data.casos.juridica + data.casos.siniestros;
                });

                return monthlyData;
            }
            
            function formatCurrency(value) {
                return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(value);
            }

            function renderizarDashboard(data) {
                const selectedMonth = monthFilterEl.value;
                let kpis;

                if (selectedMonth === 'todos') {
                    document.getElementById('kpiTitle').textContent = 'Resumen Anual';
                    document.getElementById('kpiPeriodo').textContent = yearFilterEl.value;
                    kpis = data.reduce((acc, monthData) => {
                        acc.ingresos += monthData.ingresos.total;
                        acc.egresos += monthData.egresos;
                        acc.casos += monthData.casos.total;
                        return acc;
                    }, { ingresos: 0, egresos: 0, casos: 0 });
                } else {
                    const monthIndex = parseInt(selectedMonth);
                    document.getElementById('kpiTitle').textContent = 'Resumen Mensual';
                    document.getElementById('kpiPeriodo').textContent = `${mesesLabels[monthIndex]}, ${yearFilterEl.value}`;
                    const monthKpis = data[monthIndex];
                    kpis = {
                        ingresos: monthKpis.ingresos.total,
                        egresos: monthKpis.egresos,
                        casos: monthKpis.casos.total
                    };
                }

                const balance = kpis.ingresos - kpis.egresos;
                document.getElementById('kpiIngresos').textContent = formatCurrency(kpis.ingresos);
                document.getElementById('kpiEgresos').textContent = formatCurrency(kpis.egresos);
                document.getElementById('kpiBalance').textContent = formatCurrency(balance);
                document.getElementById('kpiBalance').className = `value ${balance >= 0 ? 'positive' : 'negative'}`;
                document.getElementById('kpiCasos').textContent = kpis.casos;
                document.getElementById('kpiIngresoPorCaso').textContent = kpis.casos > 0 ? formatCurrency(kpis.ingresos / kpis.casos) : formatCurrency(0);
            }

            function renderizarGraficos(processedData) {
                Object.values(charts).forEach(chart => chart.destroy());

                const ctx1 = document.getElementById('ingresosEgresosChart').getContext('2d');
                charts.ingresosEgresos = new Chart(ctx1, {
                    type: chartTypeSelectorEl.value,
                    data: {
                        labels: mesesLabels,
                        datasets: [
                            { label: 'Ingresos', data: processedData.map(d => d.ingresos.total), backgroundColor: 'rgba(5, 150, 105, 0.7)', borderColor: 'rgba(5, 150, 105, 1)', borderWidth: 1 },
                            { label: 'Egresos', data: processedData.map(d => d.egresos), backgroundColor: 'rgba(220, 38, 38, 0.7)', borderColor: 'rgba(220, 38, 38, 1)', borderWidth: 1 }
                        ]
                    },
                    options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }
                });

                const totalAbonos = processedData.reduce((s, d) => s + d.ingresos.abonos, 0);
                const totalSiniestros = processedData.reduce((s, d) => s + d.ingresos.siniestros, 0);
                const ctx2 = document.getElementById('distribucionIngresosChart').getContext('2d');
                charts.distribucion = new Chart(ctx2, {
                    type: 'pie',
                    data: {
                        labels: ['Abonos', 'Honorarios Siniestros'],
                        datasets: [{ data: [totalAbonos, totalSiniestros], backgroundColor: ['rgba(99, 102, 241, 0.8)', 'rgba(245, 158, 11, 0.8)'], borderColor: '#fff', borderWidth: 2 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                const ctx3 = document.getElementById('casosChart').getContext('2d');
                charts.casos = new Chart(ctx3, {
                    type: 'line',
                    data: {
                        labels: mesesLabels,
                        datasets: [
                            { label: 'Casos Jur√≠dicos', data: processedData.map(d => d.casos.juridica), borderColor: 'rgba(30, 58, 138, 1)', tension: 0.3 },
                            { label: 'Siniestros', data: processedData.map(d => d.casos.siniestros), borderColor: 'rgba(29, 78, 216, 1)', tension: 0.3 }
                        ]
                    },
                    options: { scales: { y: { beginAtZero: true } }, responsive: true, maintainAspectRatio: false }
                });
            }

            function render() {
                const selectedYear = parseInt(yearFilterEl.value);
                if (isNaN(selectedYear)) {
                    document.getElementById('dashboard').style.display = 'none';
                    document.querySelector('.charts-grid').style.display = 'none';
                    updateStatus('No hay datos para mostrar. Sincroniza o utiliza las otras planillas primero.', 'warning');
                    return;
                }
                document.getElementById('dashboard').style.display = 'grid';
                document.querySelector('.charts-grid').style.display = 'grid';

                const processedData = procesarDatos(selectedYear);
                renderizarDashboard(processedData);
                renderizarGraficos(processedData);
            }

            document.getElementById('syncButton').addEventListener('click', sincronizarDatos);
            yearFilterEl.addEventListener('change', render);
            monthFilterEl.addEventListener('change', render);
            chartTypeSelectorEl.addEventListener('change', render);

            // --- L√≥gica de Google Drive ---
            const DATA_FILE_NAME = 'datos_estadisticas_snapshot.json';
            let tokenClient, gapiInited = false, gisInited = false, dataFileId = null;

            function gapiLoaded() { gapi.load('client', initializeGapiClient); }
            async function initializeGapiClient() {
                await gapi.client.init({
                    apiKey: 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM',
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                gapiInited = true; maybeEnableButtons();
            }
            function gisLoaded() {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    callback: '',
                });
                gisInited = true; maybeEnableButtons();
            }
            
            window.gapiLoaded = gapiLoaded; // Expose to global scope for the script tag
            window.gisLoaded = gisLoaded;   // Expose to global scope

            function maybeEnableButtons() {
                if (gapiInited && gisInited) {
                    document.getElementById('connectDriveBtn').onclick = handleAuthClick;
                }
            }

            function handleAuthClick() {
                tokenClient.callback = async (resp) => {
                    if (resp.error) { throw(resp); }
                    updateStatus('‚úÖ Conectado a Google Drive.', 'success');
                    document.getElementById('connectDriveBtn').style.display = 'none';
                    document.getElementById('saveToDriveBtn').style.display = 'inline-block';
                    document.getElementById('loadFromDriveBtn').style.display = 'inline-block';
                    await findDataFile();
                };
                if (!gapi.client.getToken()) tokenClient.requestAccessToken({prompt: 'consent'});
                else tokenClient.requestAccessToken({prompt: ''});
            }

            async function findDataFile() {
                try {
                    const response = await gapi.client.drive.files.list({ q: `name='${DATA_FILE_NAME}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
                    if (response.result.files.length > 0) {
                        dataFileId = response.result.files[0].id;
                        updateStatus('Archivo de respaldo encontrado en Drive.', 'success');
                    } else {
                        dataFileId = null;
                        updateStatus('No se encontr√≥ respaldo. Se crear√° uno nuevo al guardar.', 'warning');
                    }
                } catch (err) { console.error(err); updateStatus('Error buscando archivo en Drive.', 'warning'); }
            }
            
            async function saveDataToDrive() {
                if (!confirm('¬øGuardar una copia de seguridad de los datos sincronizados en Google Drive?')) return;
                try {
                    const content = JSON.stringify(allData, null, 2);
                    const boundary = '-------314159265358979323846';
                    const metadata = { name: DATA_FILE_NAME, mimeType: 'application/json' };
                    const requestBody = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${content}\r\n--${boundary}--`;
                    const request = gapi.client.request({
                        path: dataFileId ? `/upload/drive/v3/files/${dataFileId}` : '/upload/drive/v3/files',
                        method: dataFileId ? 'PATCH' : 'POST',
                        params: { uploadType: 'multipart' },
                        headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
                        body: requestBody
                    });
                    const response = await request;
                    dataFileId = response.result.id;
                    updateStatus('‚úÖ Respaldo guardado en Drive con √©xito.', 'success');
                } catch (err) { console.error(err); updateStatus('‚ùå Error al guardar en Drive.', 'warning'); }
            }

            async function loadDataFromDrive() {
                if (!dataFileId) return alert("No se encontr√≥ un archivo de respaldo en Drive para cargar.");
                if (!confirm("¬øCargar el respaldo de Drive? Se reemplazar√°n los datos sincronizados localmente.")) return;
                try {
                    const response = await gapi.client.drive.files.get({ fileId: dataFileId, alt: 'media' });
                    const loaded = response.result;
                    allData.siniestros = loaded.siniestros || [];
                    allData.juridica = loaded.juridica || [];
                    allData.abonos = loaded.abonos || [];
                    allData.egresos = loaded.egresos || {};
                    updateStatus('‚úÖ Respaldo cargado desde Drive. Sincronizando con planillas locales...');
                    sincronizarDatos(); // Volver a sincronizar para incorporar cambios locales recientes si los hay
                } catch (err) { console.error(err); updateStatus('‚ùå Error al cargar desde Drive.', 'warning'); }
            }
            
            // Carga inicial
            sincronizarDatos();
        });
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
