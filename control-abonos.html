<script>
    // ====== ESTADO APP ======
    let abonosData = [];
    let currentMonth;
    let signatureImage = null;
    let currentFilter = 'todos';
    let isAmountHidden = false;
    let realAmount = 0;
    let currentObsId = null;
    const TIPO_OPTIONS = ['Abono Mensual','Honorarios Siniestro','Regulación Honorarios'];
    const ESTADO_OPTIONS = ['Pendiente','Pagado','Falta de Pago','Pago Parcial','Ejecución de Honorarios','Terminado'];
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', function() {
      // Botones principales
      document.getElementById('toggleAmountBtn').addEventListener('click', toggleAmountVisibility);
      document.getElementById('btnPrevMonth').addEventListener('click', function(){ changeMonth(-1); });
      document.getElementById('btnNextMonth').addEventListener('click', function(){ changeMonth(1); });
      document.getElementById('add-record-btn').addEventListener('click', openModal);
      document.getElementById('carry-btn').addEventListener('click', carryOverClients);
      document.getElementById('print-btn').addEventListener('click', printTable);
      document.getElementById('export-btn').addEventListener('click', exportToExcel);
      document.getElementById('export-json-btn').addEventListener('click', exportData);
      document.getElementById('import-json-btn').addEventListener('click', function(){ document.getElementById('importInput').click(); });
      document.getElementById('config-btn').addEventListener('click', openConfigModal);
      document.getElementById('btnVerPendientes').addEventListener('click', function(){ filterByStatus('pendientes'); });

      document.getElementById('importInput').addEventListener('change', handleImport);

      // Filtros delegación
      document.getElementById('filtersBar').addEventListener('click', function(e){
        var btn = e.target.closest('.filter-btn');
        if(!btn){ return; }
        document.querySelectorAll('.filter-btn').forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        filterByStatus(btn.getAttribute('data-status'));
      });

      // Tabla delegación
      document.getElementById('abonosTableBody').addEventListener('click', function(event){
        var target = event.target;
        if(target.classList.contains('delete-btn')) {
          deleteAbono(target.getAttribute('data-id'));
        } else if(target.classList.contains('receipt-btn')) {
          generateReceipt(target.getAttribute('data-id'));
        } else if(target.classList.contains('obs-btn')) {
          showObservations(target.getAttribute('data-id'));
        } else {
          var cell = target.closest('.editable');
          if(cell){ handleCellEdit(cell); }
        }
      });

      // Modal Abono
      document.getElementById('abonoModalClose').addEventListener('click', closeModal);
      document.getElementById('abonoModalCancel').addEventListener('click', closeModal);
      document.getElementById('abonoModal').addEventListener('click', function(e){ if(e.target.id === 'abonoModal'){ closeModal(); } });
      document.getElementById('abonoForm').addEventListener('submit', handleFormSubmit);
      
      // Event listener para mostrar/ocultar campo de pago parcial
      document.getElementById('estado').addEventListener('change', function() {
        var div = document.getElementById('pagoMontoParcialDiv');
        if (this.value === 'Pago Parcial') {
          div.style.display = 'block';
        } else {
          div.style.display = 'none';
        }
      });

      // Modal Observaciones
      document.getElementById('obsModalClose').addEventListener('click', closeObsModal);
      document.getElementById('obsEditBtn').addEventListener('click', editObservations);
      document.getElementById('obsSaveBtn').addEventListener('click', saveObservations);
      document.getElementById('obsCancelBtn').addEventListener('click', cancelObsEdit);

      // Modal Recibo
      document.getElementById('receiptClose').addEventListener('click', function(){ document.getElementById('receiptModal').classList.remove('active'); });
      document.getElementById('receiptCancel').addEventListener('click', function(){ document.getElementById('receiptModal').classList.remove('active'); });
      document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);

      // Modal Config
      document.getElementById('configClose').addEventListener('click', closeConfigModal);
      document.getElementById('removeSignatureBtn').addEventListener('click', removeSignature);
      document.getElementById('signatureFile').addEventListener('change', handleSignatureUpload);

      // Datos
      loadData();
      loadSignature();
      initializeMonth();
      setupModal();
      render();
    });

    // ====== UTIL DATOS ======
    function saveData(){ localStorage.setItem('abonosData', JSON.stringify(abonosData)); }
    function loadData(){ var s = localStorage.getItem('abonosData'); abonosData = s ? JSON.parse(s) : []; }

    function saveSignature(){ if(signatureImage){ localStorage.setItem('signatureImage', signatureImage); } else { localStorage.removeItem('signatureImage'); } }
    function loadSignature(){ signatureImage = localStorage.getItem('signatureImage'); updateSignaturePreview(); }
    function updateSignaturePreview(){
      var el = document.getElementById('signaturePreview');
      if(signatureImage){ el.innerHTML = '<img src="'+signatureImage+'" alt="Firma">'; }
      else { el.innerHTML = '<p style="color:#94a3b8;">No hay firma cargada</p>'; }
    }

    /**
     * MODIFICACIÓN 1: Cambiamos la lógica para que filtre por el mes de servicio
     * en lugar de la fecha de pago. Esto asegura que un registro de Julio,
     * pagado en Agosto, siga apareciendo en la lista de Julio.
     */
    function getAbonosForMonth(month, year){
      return abonosData.filter(function(a){
        // Si el registro tiene el nuevo campo 'mesServicio', lo usamos
        if (a.mesServicio) {
          return a.mesServicio.month === month && a.mesServicio.year === year;
        }
        // Si no (para datos antiguos), usamos la fecha de pago como antes para no romper nada
        else if (a.fechaPago) {
          var d = new Date(a.fechaPago + 'T00:00:00');
          return d.getMonth() === month && d.getFullYear() === year;
        }
        return false;
      });
    }

    function addAbono(newAbono){ 
      newAbono.id='abono_'+Date.now(); 
      if(!newAbono.deudaAcumulada) newAbono.deudaAcumulada = 0;
      abonosData.push(newAbono); 
      saveData(); 
      render(); 
    }
    
    function updateAbono(id, updatedData){
      var idx = abonosData.findIndex(function(a){ return a.id===id; });
      if(idx !== -1){ 
        abonosData[idx] = Object.assign({}, abonosData[idx], updatedData); 
        saveData(); 
        render(); 
      }
    }
    
    function deleteAbono(id){
      if(confirm('¿Eliminar este registro?')){
        abonosData = abonosData.filter(function(a){ return a.id !== id; });
        saveData(); render();
      }
    }

    // ====== OBSERVACIONES ======
    function showObservations(id){
      currentObsId = id;
      var abono = abonosData.find(function(a){ return a.id === id; });
      if(!abono) return;
      
      document.getElementById('obsClientName').textContent = abono.cliente || 'Sin nombre';
      document.getElementById('obsContent').textContent = abono.observaciones || 'Sin observaciones';
      document.getElementById('obsContent').style.display = 'block';
      document.getElementById('obsForm').style.display = 'none';
      document.getElementById('obsEditBtn').style.display = 'block';
      document.getElementById('obsModal').classList.add('active');
    }

    function editObservations(){
      var abono = abonosData.find(function(a){ return a.id === currentObsId; });
      if(!abono) return;
      
      document.getElementById('obsTextarea').value = abono.observaciones || '';
      document.getElementById('obsContent').style.display = 'none';
      document.getElementById('obsForm').style.display = 'block';
      document.getElementById('obsEditBtn').style.display = 'none';
      document.getElementById('obsTextarea').focus();
    }

    function saveObservations(){
      var newObs = document.getElementById('obsTextarea').value;
      updateAbono(currentObsId, {observaciones: newObs});
      closeObsModal();
    }

    function cancelObsEdit(){
      document.getElementById('obsContent').style.display = 'block';
      document.getElementById('obsForm').style.display = 'none';
      document.getElementById('obsEditBtn').style.display = 'block';
    }

    function closeObsModal(){
      document.getElementById('obsModal').classList.remove('active');
      currentObsId = null;
    }

    // ====== FILTROS ======
    function filterByStatus(status){
      currentFilter = status;
      var info = document.getElementById('filterInfo');
      if(status === 'todos'){ info.style.display='none'; }
      else {
        info.style.display='block';
        var m = {
          'pendiente':'Mostrando solo registros pendientes',
          'falta-de-pago':'Mostrando solo registros con falta de pago',
          'pagado':'Mostrando solo registros pagados',
          'pago-parcial':'Mostrando solo registros con pago parcial',
          'ejecucion-de-honorarios':'Mostrando solo registros en ejecución de honorarios',
          'terminado':'Mostrando solo registros terminados',
          'pendientes':'Mostrando todos los registros pendientes, con falta de pago y en ejecución'
        };
        info.textContent = m[status] || '';
      }
      render();
    }
    
    function getFilteredAbonos(abonos){
      if(currentFilter==='todos') return abonos;
      if(currentFilter==='pendientes') return abonos.filter(function(a){ 
        return a.estado==='Pendiente'||a.estado==='Falta de Pago'||a.estado==='Ejecución de Honorarios'; 
      });
      return abonos.filter(function(a){
        var estado = (a.estado||'').toLowerCase().replace(/ /g,'-');
        return estado === currentFilter;
      });
    }

    // ====== FUNCIONES AUXILIARES PARA CÁLCULO DE DEUDA ======
    function calcularDeudaCliente(cliente, abonos) {
      var deudaTotal = 0;
      var abonoMensual = 0;
      
      abonos.forEach(function(record) {
        if (record.cliente === cliente) {
          var montoBase = parseFloat(record.montoBase || record.monto) || 0;
          var deudaPrevia = parseFloat(record.deudaAcumulada) || 0;
          
          if (record.tipo === 'Abono Mensual') { abonoMensual = montoBase; }
          
          if (record.estado === 'Pendiente' || record.estado === 'Falta de Pago' || record.estado === 'Ejecución de Honorarios') {
            if (record.tipo !== 'Regulación Honorarios' || record.estado !== 'Falta de Pago') {
              deudaTotal += montoBase + deudaPrevia;
            }
          } else if (record.estado === 'Pago Parcial') {
            if (record.tipo !== 'Regulación Honorarios') {
              var montoTotalRecord = montoBase + deudaPrevia;
              var montoPagado = parseFloat(record.montoPagado) || 0;
              var deudaRestante = montoTotalRecord - montoPagado;
              if (deudaRestante > 0) { deudaTotal += deudaRestante; }
            }
          }
        }
      });
      return { deudaTotal: deudaTotal, abonoMensual: abonoMensual };
    }

    // ====== ARRASTRE CLIENTES CON ACUMULACIÓN DE DEUDA MEJORADO ======
    function carryOverClients(){
      var curr = getAbonosForMonth(currentMonth.month, currentMonth.year);
      if(curr.length===0){ alert('No hay clientes en el mes actual para arrastrar.'); return; }
      
      var nm = currentMonth.month + 1, ny=currentMonth.year;
      if(nm>11){ nm=0; ny++; }
      
      var unique = Array.from(new Set(curr.map(function(a){ return a.cliente; })));
      var next = getAbonosForMonth(nm, ny);
      var existing = new Set(next.map(function(a){ return a.cliente; }));
      var added=0;

      unique.forEach(function(cliente){
        if(!existing.has(cliente)){
          var clienteRecords = curr.filter(function(a){ return a.cliente===cliente; });
          var lastRecord = clienteRecords.sort(function(a,b){ return new Date(b.fechaPago)-new Date(a.fechaPago); })[0];
          
          var dateStr = ny+'-'+String(nm+1).padStart(2,'0')+'-01';
          var observaciones = lastRecord.observaciones || '';
          var registrosAgregados = 0;

          // MODIFICACIÓN 1: Al arrastrar, guardamos el mes de servicio del nuevo registro.
          var mesServicioNuevo = { month: nm, year: ny };
          
          if (lastRecord.estado === 'Terminado') {
            var abonoMensual = clienteRecords.find(function(r){ return r.tipo === 'Abono Mensual'; });
            var montoAbono = abonoMensual ? parseFloat(abonoMensual.montoBase || abonoMensual.monto) || 0 : 0;
            addAbono({ cliente: cliente, tipo: (lastRecord.tipo||'Abono Mensual'), monto: montoAbono, montoBase: montoAbono, deudaAcumulada: 0, fechaPago: '', estado: 'Terminado', observaciones: observaciones, mesServicio: mesServicioNuevo });
            registrosAgregados++;
          } else {
            var abonosmensuales = clienteRecords.filter(function(r){ return r.tipo === 'Abono Mensual'; });
            if (abonosmensuales.length > 0) {
              var calculoDeuda = calcularDeudaCliente(cliente, abonosmensuales);
              var deudaTotal = calculoDeuda.deudaTotal;
              var abonoMensual = calculoDeuda.abonoMensual;
              
              if (deudaTotal > 0) {
                var montoTotal = abonoMensual + deudaTotal;
                var obsAbono = 'Deuda acumulada: ' + formatCurrency(deudaTotal) + ' + Abono: ' + formatCurrency(abonoMensual);
                addAbono({ cliente: cliente, tipo: 'Abono Mensual', monto: montoTotal, montoBase: abonoMensual, deudaAcumulada: deudaTotal, fechaPago: '', estado: 'Pendiente', observaciones: obsAbono, mesServicio: mesServicioNuevo });
              } else {
                addAbono({ cliente: cliente, tipo: 'Abono Mensual', monto: abonoMensual, montoBase: abonoMensual, deudaAcumulada: 0, fechaPago: '', estado: 'Pendiente', observaciones: observaciones, mesServicio: mesServicioNuevo });
              }
              registrosAgregados++;
            }
            
            var regulaciones = clienteRecords.filter(function(r){ return r.tipo === 'Regulación Honorarios'; });
            regulaciones.forEach(function(record) {
              var montoRestante = 0, observacionRegulacion = '';
              if (record.estado === 'Pago Parcial') {
                montoRestante = (parseFloat(record.monto) || 0) - (parseFloat(record.montoPagado) || 0);
                observacionRegulacion = 'Saldo pendiente de regulación anterior: ' + formatCurrency(montoRestante);
              } else if (['Pendiente', 'Ejecución de Honorarios', 'Falta de Pago'].includes(record.estado)) {
                montoRestante = parseFloat(record.monto) || 0;
                observacionRegulacion = 'Regulación de honorarios pendiente: ' + formatCurrency(montoRestante);
              }
              if (montoRestante > 0) {
                addAbono({ cliente: cliente, tipo: 'Regulación Honorarios', monto: montoRestante, montoBase: montoRestante, deudaAcumulada: 0, fechaPago: '', estado: 'Pendiente', observaciones: observacionRegulacion, mesServicio: mesServicioNuevo });
                registrosAgregados++;
              }
            });
          }
          if (registrosAgregados > 0) { added++; }
        }
      });

      if(added>0){
        alert('Se arrastraron '+added+' clientes a '+MONTHS[nm]+' '+ny+'. Cambiando al mes siguiente...');
        currentMonth = { month:nm, year:ny }; updateMonthDisplay(); render();
      } else {
        alert('Todos los clientes ya existen en el próximo mes.');
      }
    }

    // ====== MES ======
    function initializeMonth(){ var t=new Date(); currentMonth = { month:t.getMonth(), year:t.getFullYear() }; updateMonthDisplay(); }
    function changeMonth(dir){
      currentMonth.month += dir;
      if(currentMonth.month>11){ currentMonth.month=0; currentMonth.year++; }
      else if(currentMonth.month<0){ currentMonth.month=11; currentMonth.year--; }
      updateMonthDisplay(); render();
    }
    function updateMonthDisplay(){ document.getElementById('monthDisplay').textContent = MONTHS[currentMonth.month]+' '+currentMonth.year; }

    // ====== FIRMA ======
    function handleSignatureUpload(event){
      var file = event.target.files[0];
      if(file && file.type.startsWith('image/')){
        var reader = new FileReader();
        reader.onload = function(e){ signatureImage = e.target.result; saveSignature(); updateSignaturePreview(); };
        reader.readAsDataURL(file);
      }
    }
    function removeSignature(){
      if(confirm('¿Está seguro de eliminar la firma?')){
        signatureImage = null; saveSignature(); updateSignaturePreview(); document.getElementById('signatureFile').value='';
      }
    }

    // ====== RENDER ======
    function formatCurrency(v){ 
      return new Intl.NumberFormat('es-AR',{
        style:'currency',
        currency:'ARS',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(v||0).replace(/,/g, '.'); 
    }
    
    function toggleAmountVisibility(){
      isAmountHidden = !isAmountHidden;
      var totalCobradoEl = document.getElementById('totalCobrado');
      var toggleIcon = document.getElementById('toggleIcon');
      if(isAmountHidden){ totalCobradoEl.textContent='••••••'; totalCobradoEl.classList.add('hidden-value'); toggleIcon.textContent='👁️‍🗨️'; }
      else { totalCobradoEl.textContent=formatCurrency(realAmount); totalCobradoEl.classList.remove('hidden-value'); toggleIcon.textContent='👁️'; }
    }

    function render(){
      var mes = getAbonosForMonth(currentMonth.month, currentMonth.year);
      var filtered = getFilteredAbonos(mes);
      renderTable(filtered);
      renderDashboard(mes);
      updateFilterCounts(mes);
      updateAlertBanner(mes);
    }

    function renderDashboard(abonos){
      var totalCobrado = abonos.filter(function(a){ return a.estado==='Pagado'; }).reduce(function(s,a){ return s+Number(a.monto||0); },0);
      totalCobrado += abonos.filter(function(a){ return a.estado==='Pago Parcial'; }).reduce(function(s,a){ return s+Number(a.montoPagado||0); },0);
      
      var totalPendientes = abonos.filter(function(a){ return a.estado==='Pendiente'; }).length;
      var totalFaltaPago = abonos.filter(function(a){ return a.estado==='Falta de Pago'; }).length;

      realAmount = totalCobrado;
      var el = document.getElementById('totalCobrado');
      if(isAmountHidden){ el.textContent='••••••'; el.classList.add('hidden-value'); }
      else { el.textContent=formatCurrency(totalCobrado); el.classList.remove('hidden-value'); }

      document.getElementById('totalRegistros').textContent = abonos.length;
      document.getElementById('totalPendientes').textContent = totalPendientes;
      document.getElementById('totalFaltaPago').textContent = totalFaltaPago;
    }

    function updateFilterCounts(abonos){
      var counts = {
        todos: abonos.length,
        pendiente: abonos.filter(function(a){ return a.estado==='Pendiente'; }).length,
        'falta-de-pago': abonos.filter(function(a){ return a.estado==='Falta de Pago'; }).length,
        pagado: abonos.filter(function(a){ return a.estado==='Pagado'; }).length,
        'pago-parcial': abonos.filter(function(a){ return a.estado==='Pago Parcial'; }).length,
        'ejecucion-de-honorarios': abonos.filter(function(a){ return a.estado==='Ejecución de Honorarios'; }).length,
        terminado: abonos.filter(function(a){ return a.estado==='Terminado'; }).length,
        pendientes: abonos.filter(function(a){ 
          return a.estado==='Pendiente'||a.estado==='Falta de Pago'||a.estado==='Ejecución de Honorarios'; 
        }).length
      };
      document.getElementById('countTodos').textContent = counts.todos;
      document.getElementById('countPendiente').textContent = counts.pendiente;
      document.getElementById('countFalta').textContent = counts['falta-de-pago'];
      document.getElementById('countPagado').textContent = counts.pagado;
      document.getElementById('countPagoParcial').textContent = counts['pago-parcial'];
      document.getElementById('countEjecucion').textContent = counts['ejecucion-de-honorarios'];
      document.getElementById('countTerminado').textContent = counts.terminado;
      document.getElementById('countAllPendientes').textContent = counts.pendientes;
    }

    function updateAlertBanner(abonos){
      var n = abonos.filter(function(a){ return a.estado==='Pendiente'||a.estado==='Falta de Pago'; }).length;
      var banner = document.getElementById('alertBanner');
      if(n>0){ banner.classList.add('show'); document.getElementById('alertCount').textContent = n; }
      else { banner.classList.remove('show'); }
    }

    function renderTable(abonos){
      var body = document.getElementById('abonosTableBody');
      body.innerHTML = '';
      if(abonos.length===0){
        var msg = currentFilter==='todos' ? 'No hay registros para este mes.' : 'No hay registros que coincidan con el filtro seleccionado.';
        body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#94a3b8;">'+msg+'</td></tr>';
        return;
      }
      abonos.forEach(function(abono){
        var tr = document.createElement('tr');
        var isPagado = (abono.estado==='Pagado');
        var estadoClass = (abono.estado||'').toLowerCase().replace(/ /g,'-').replace(/ó/g,'o') || 'pendiente';
        if(abono.estado==='Pendiente'){ tr.classList.add('highlight-pending'); }
        else if(abono.estado==='Falta de Pago'){ tr.classList.add('highlight-falta'); }
        if(abono.deudaAcumulada && abono.deudaAcumulada > 0){ tr.classList.add('has-debt'); }

        var montoDisplay = formatCurrency(abono.monto);
        var additionalInfo = '';
        
        if(abono.deudaAcumulada && abono.deudaAcumulada > 0){
          additionalInfo += '<span class="debt-indicator">(Incluye deuda: '+formatCurrency(abono.deudaAcumulada)+')</span>';
        }
        
        if(abono.estado === 'Pago Parcial' && abono.montoPagado){
          var montoRestante = parseFloat(abono.monto) - parseFloat(abono.montoPagado);
          additionalInfo += '<span class="partial-payment-info">(Pagado: '+formatCurrency(abono.montoPagado)+' - Resta: '+formatCurrency(montoRestante)+')</span>';
        }
        
        montoDisplay += additionalInfo;

        tr.innerHTML =
          '<td class="editable" data-id="'+abono.id+'" data-field="cliente" data-type="text">'+(abono.cliente||'')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="tipo" data-type="select" data-options=\''+JSON.stringify(TIPO_OPTIONS)+'\'>'+(abono.tipo||'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="monto" data-type="number">'+montoDisplay+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="fechaPago" data-type="date">'+(abono.fechaPago?new Date(abono.fechaPago+'T00:00:00').toLocaleDateString('es-AR'):'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="formaPago" data-type="text">'+(abono.formaPago||'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="estado" data-type="select" data-options=\''+JSON.stringify(ESTADO_OPTIONS)+'\'><span class="status-span '+estadoClass+'">'+(abono.estado||'')+'</span></td>'+
          '<td class="no-print"><div class="action-buttons">'+
            '<button class="btn btn-small btn-info obs-btn" data-id="'+abono.id+'" title="Ver observaciones">📝</button>'+
            '<button class="btn btn-small btn-success receipt-btn" data-id="'+abono.id+'" '+(isPagado || abono.estado==='Pago Parcial'?'':'disabled')+'>🧾</button>'+
            '<button class="btn btn-small delete-btn" style="background-color:var(--danger-color);" data-id="'+abono.id+'">🗑️</button>'+
          '</div></td>';
        body.appendChild(tr);
      });
    }

    function handleCellEdit(cell){
      if(cell.querySelector('input,select')) return;
      var id = cell.getAttribute('data-id');
      var field = cell.getAttribute('data-field');
      var type = cell.getAttribute('data-type');
      var options = cell.getAttribute('data-options');
      var abono = abonosData.find(function(a){ return a.id===id; });
      if(!abono){ return; }
      var currentValue = abono[field] || '';
      var editor;

      if(type==='select'){
        editor = document.createElement('select');
        JSON.parse(options).forEach(function(opt){
          var o = document.createElement('option');
          o.value = opt; o.textContent = opt;
          if(opt===currentValue){ o.selected = true; }
          editor.appendChild(o);
        });
      } else {
        editor = document.createElement('input');
        editor.type = type;
        if(type==='date' && currentValue){ editor.value = currentValue; }
        else if(type==='number'){ editor.value = parseFloat(currentValue)||''; }
        else { editor.value = currentValue; }
      }

      cell.innerHTML = '';
      cell.appendChild(editor);
      editor.focus();

      var saveChange = function(){
        var newValue = (type==='number') ? (parseFloat(editor.value)||0) : editor.value;
        
        if(field === 'estado' && newValue === 'Pago Parcial'){
          var montoPagado = prompt('Ingrese el monto pagado parcialmente:');
          if(montoPagado && !isNaN(parseFloat(montoPagado))){
            updateAbono(id, {estado: newValue, montoPagado: parseFloat(montoPagado)});
          } else {
            render();
          }
        } else {
          updateAbono(id, (function(o){ o[field]=newValue; return o; })({}));
        }
      };

      editor.addEventListener('blur', saveChange);
      editor.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); editor.blur(); } });
    }

    function setupModal(){
      var tipo = document.getElementById('tipo');
      var estado = document.getElementById('estado');
      tipo.innerHTML=''; estado.innerHTML='';
      TIPO_OPTIONS.forEach(function(opt){ var o=document.createElement('option'); o.value=opt; o.textContent=opt; tipo.appendChild(o); });
      ESTADO_OPTIONS.forEach(function(opt){ var o=document.createElement('option'); o.value=opt; o.textContent=opt; estado.appendChild(o); });
    }

    function openModal(){
      var form = document.getElementById('abonoForm');
      form.reset();
      document.getElementById('fechaPago').value = ''; // La fecha de pago se deja vacía hasta que se pague
      document.getElementById('modalTitle').textContent = 'Agregar Nuevo Registro';
      document.getElementById('pagoMontoParcialDiv').style.display = 'none';
      document.getElementById('abonoModal').classList.add('active');
    }
    function closeModal(){ document.getElementById('abonoModal').classList.remove('active'); }

    function openConfigModal(){ document.getElementById('configModal').classList.add('active'); }
    function closeConfigModal(){ document.getElementById('configModal').classList.remove('active'); }

    function handleFormSubmit(e){
      e.preventDefault();
      var data = {
        cliente: document.getElementById('cliente').value,
        tipo: document.getElementById('tipo').value,
        monto: parseFloat(document.getElementById('monto').value),
        fechaPago: document.getElementById('fechaPago').value,
        formaPago: document.getElementById('formaPago').value,
        estado: document.getElementById('estado').value,
        observaciones: document.getElementById('observaciones').value,
        // MODIFICACIÓN 1: Al crear un registro, le asignamos el mes de servicio actual
        mesServicio: {
          month: currentMonth.month,
          year: currentMonth.year
        }
      };
      
      if(data.estado === 'Pago Parcial') {
        var montoPagado = parseFloat(document.getElementById('montoPagadoParcial').value);
        if(montoPagado && montoPagado > 0) {
          data.montoPagado = montoPagado;
        } else {
          alert('Debe ingresar un monto pagado válido para el pago parcial');
          return;
        }
      }
      
      addAbono(data);
      closeModal();
    }

    function printTable(){
      var ft = (currentFilter==='todos') ? '' : ' ('+currentFilter.replace('-',' ')+')';
      var title = 'Resumen de Abonos - '+MONTHS[currentMonth.month]+' '+currentMonth.year+ft;
      var h = document.getElementById('table-title');
      h.textContent = title; h.style.display='block';
      window.print();
      setTimeout(function(){ h.style.display='none'; }, 100);
    }

    // ====== RECIBOS ======
    /**
     * MODIFICACIÓN 2: Cambiamos la lógica para que el concepto del recibo
     * incluya el mes y año de servicio al que corresponde el pago.
     */
    function generateReceipt(abonoId){
      var abono = abonosData.find(function(a){ return a.id===abonoId; });
      if(!abono){ 
        alert('No se encontró el registro del abono.');
        return; 
      }
      
      if(abono.estado!=='Pagado' && abono.estado!=='Pago Parcial'){ 
        alert('Solo se pueden generar recibos para pagos completos o parciales.');
        return; 
      }

      var receiptDate = new Date().toLocaleDateString('es-AR');
      var receiptNumber = String(Date.now()).slice(-8);
      
      // Obtenemos el mes de servicio para mostrarlo en el recibo
      var mesServicioTexto = '';
      if (abono.mesServicio) {
        mesServicioTexto = MONTHS[abono.mesServicio.month] + ' ' + abono.mesServicio.year;
      } else if (abono.fechaPago) { // Fallback para datos antiguos
        var d = new Date(abono.fechaPago + 'T00:00:00');
        mesServicioTexto = MONTHS[d.getMonth()] + ' ' + d.getFullYear();
      }

      var montoRecibo, conceptoBase;
      
      if (abono.estado === 'Pago Parcial') {
        montoRecibo = parseFloat(abono.montoPagado) || 0;
        conceptoBase = (abono.tipo || 'Abono Mensual') + ' (Pago Parcial)';
        if (montoRecibo <= 0) { alert('El monto pagado debe ser mayor a cero.'); return; }
      } else {
        montoRecibo = parseFloat(abono.monto) || 0;
        conceptoBase = abono.tipo || 'Abono Mensual';
      }

      // Unimos el concepto base con el mes de servicio
      var conceptoRecibo = conceptoBase + (mesServicioTexto ? ' - ' + mesServicioTexto : '');

      var parts = [];
      parts.push(
        '<div class="receipt-header">',
          '<div class="company-name">ESTUDIO GARCÍA Y ASOCIADOS</div>',
          '<h1>RECIBO DE PAGO</h1>',
          '<div class="receipt-info">',
            '<div>Fecha: ', receiptDate, '</div>',
            '<div>Recibo N°: ', receiptNumber, '</div>',
          '</div>',
        '</div>',
        '<div class="receipt-body">',
          '<div class="receipt-detail">',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Cliente:</span><span>', (abono.cliente||'Sin nombre'), '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Concepto:</span><span>', conceptoRecibo, '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Fecha de Pago:</span><span>', (abono.fechaPago? new Date(abono.fechaPago+'T00:00:00').toLocaleDateString('es-AR') : 'Sin fecha'), '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Forma de Pago:</span><span>', (abono.formaPago||'Efectivo'), '</span></div>'
      );
      
      if (abono.estado === 'Pago Parcial') {
        var montoTotal = parseFloat(abono.monto) || 0;
        var montoRestante = montoTotal - montoRecibo;
        parts.push(
          '<div class="receipt-detail-row"><span class="receipt-detail-label">Monto Total Adeudado:</span><span>', formatCurrency(montoTotal), '</span></div>',
          '<div class="receipt-detail-row"><span class="receipt-detail-label">Saldo Pendiente:</span><span>', formatCurrency(montoRestante), '</span></div>'
        );
      }
      
      parts.push(
          '</div>',
          '<div class="receipt-total"><div>TOTAL ABONADO</div><div class="amount">', formatCurrency(montoRecibo), '</div></div>',
        '</div>',
        '<div class="receipt-footer">',
          '<div class="signature-container"><div class="signature-line"></div><p>Firma del Cliente</p></div>',
          '<div class="signature-container">', (signatureImage?('<img src="'+signatureImage+'" alt="Firma">'):'') ,'<div class="signature-line"></div><p>Firma Autorizada</p></div>',
        '</div>'
      );

      document.getElementById('receiptContent').innerHTML = parts.join('');
      document.getElementById('receiptModal').classList.add('active');
    }

    function printReceipt(){
      var content = document.getElementById('receiptContent').innerHTML.replace(/<\/script/gi,'<\\/script');
      var w = window.open('','_blank');
      var html = [];
      html.push('<!doctype html><html><head><meta charset="utf-8"><title>Recibo de Pago - Estudio García y Asociados</title><style>',
        'body{font-family:Arial,sans-serif;margin:0;padding:20px}',
        '.receipt-preview{max-width:700px;margin:0 auto}',
        '.receipt-header{background:linear-gradient(135deg,#1e293b,#1e3a8a);color:#fff;text-align:center;padding:30px}',
        '.receipt-header h1{font-size:1.8em;margin-bottom:10px;font-weight:300;letter-spacing:2px}',
        '.company-name{font-size:1.3em;font-weight:600;margin-bottom:15px}',
        '.receipt-info{display:flex;justify-content:space-between;margin-top:20px;font-size:.9em}',
        '.receipt-body{padding:30px;background:#fafbfc}',
        '.receipt-detail{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0}',
        '.receipt-detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9}',
        '.receipt-detail-row:last-child{border-bottom:none}',
        '.receipt-detail-label{font-weight:600;color:#1e293b}',
        '.receipt-total{background:#1e3a8a;color:#fff;padding:20px;border-radius:8px;text-align:center;margin:20px 0}',
        '.receipt-total .amount{font-size:2em;font-weight:700}',
        '.receipt-footer{padding:30px;display:flex;justify-content:space-between;background:#fff;border-top:2px solid #e2e8f0}',
        '.signature-container{text-align:center;flex:1}',
        '.signature-container img{max-width:150px;height:60px;object-fit:contain;margin-bottom:10px}',
        '.signature-line{border-top:2px solid #1e293b;width:200px;margin:10px auto}',
        '@media print{body{margin:0}}',
      '</style></head><body><div class="receipt-preview">');
      html.push(content);
      html.push('</div></body></html>');
      w.document.write(html.join(''));
      w.document.close();
      w.print();
    }

    // ====== IMPORT/EXPORT ======
    function exportData(){
      var dataStr = JSON.stringify(abonosData, null, 2);
      var uri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      var name = 'control_abonos_'+new Date().toISOString().slice(0,10)+'.json';
      var a = document.createElement('a');
      a.href = uri; a.download = name; a.click();
    }

    function handleImport(event){
      var file = event.target.files[0]; if(!file) return;
      var reader = new FileReader();
      reader.onload = function(e){
        try{
          var imported = JSON.parse(e.target.result);
          if(Array.isArray(imported) && confirm('¿Importar '+imported.length+' registros? Esto sobreescribirá los datos actuales.')){
            abonosData = imported; saveData(); loadData(); render(); alert('Datos importados exitosamente');
          }
        }catch(err){ alert('Error al importar el archivo. Verifique que sea un JSON válido.'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function exportToExcel(){
      var abonosMes = getAbonosForMonth(currentMonth.month, currentMonth.year);
      var data = (currentFilter==='todos') ? abonosMes : getFilteredAbonos(abonosMes);
      if(data.length===0){ alert('No hay datos para exportar.'); return; }

      var rows = data.map(function(a){
        return { 
          Cliente:a.cliente, 
          Tipo:a.tipo, 
          Monto:a.monto, 
          'Fecha de Pago':a.fechaPago, 
          'Forma de Pago':a.formaPago, 
          Estado:a.estado,
          Observaciones:a.observaciones || ''
        };
      });
      var ws = XLSX.utils.json_to_sheet(rows);
      var wb = XLSX.utils.book_new();
      var sheetName = (currentFilter==='todos') ? 'Todos los Abonos' : ('Abonos '+currentFilter.replace('-',' '));
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
      XLSX.writeFile(wb, 'Abonos_'+MONTHS[currentMonth.month]+'_'+currentMonth.year+'_'+currentFilter+'.xlsx');
    }
  </script>
