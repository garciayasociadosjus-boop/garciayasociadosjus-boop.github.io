<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="UTF-8">
  <title>Control de Abonos Mensuales - Estudio Garc√≠a y Asociados</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <!-- Librer√≠as para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
  <style>
    :root{
      --primary-color:#1e3a8a;--secondary-color:#1e293b;--success-color:#059669;--danger-color:#dc2626;--warning-color:#f59e0b;--info-color:#6366f1;--light-bg:#f8fafc;--text-dark:#1e293b;--text-light:#f1f5f9;--disabled-color:#94a3b8;--finished-color:#64748b;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Arial,sans-serif;background:#f1f5f9;min-height:100vh;padding:20px;color:var(--text-dark)}
    .container{max-width:1600px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,var(--secondary-color),var(--primary-color));color:var(--text-light);padding:30px;text-align:center;border-bottom:5px solid var(--primary-color)}
    .header h1{font-size:2.2em;margin-bottom:8px}
    .header p{font-size:1.1em;opacity:.9}
    .main-content{padding:30px}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:25px;margin-bottom:30px}
    .card{background:var(--light-bg);border-radius:12px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.07);border-left:5px solid var(--primary-color);transition:.2s;position:relative}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
    .card h3{color:var(--secondary-color);margin-bottom:15px;font-size:1.1em;text-transform:uppercase;letter-spacing:.5px}
    .card .value{font-size:2.4em;font-weight:700;color:var(--primary-color)}
    .card .value.positive{color:var(--success-color)}
    .card.warning-card{border-left-color:var(--warning-color)}
    .card.danger-card{border-left-color:var(--danger-color)}
    .value-container{display:flex;align-items:center;justify-content:space-between}
    .toggle-visibility{background:none;border:none;font-size:1.4em;cursor:pointer;color:var(--secondary-color);transition:.3s;padding:5px;opacity:.6}
    .toggle-visibility:hover{opacity:1;transform:scale(1.1)}
    .hidden-value{font-size:2.4em;font-weight:700;color:var(--success-color);letter-spacing:5px}
    .controls{background:var(--light-bg);padding:20px;border-radius:10px;margin-bottom:30px;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:20px}
    .form-group{display:flex;flex-direction:column;gap:5px}
    .form-group label{font-weight:600;font-size:.85em;color:var(--text-dark)}
    .form-group select,.form-group input{padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:.9em;background:#fff}
    .btn{background:var(--primary-color);color:var(--text-light);border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:.9em;transition:.25s;font-weight:600;margin:0 5px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(30,58,138,.3)}
    .btn:disabled{background:var(--disabled-color);cursor:not-allowed;transform:none;box-shadow:none}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color)}
    .btn-info{background:var(--info-color)}
    .btn-danger{background:var(--danger-color)}
    .btn-drive{background:#4285f4}
    .data-status{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;border-radius:8px;margin-bottom:20px;text-align:center}
    .filters-container{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 3px 10px rgba(0,0,0,.05)}
    .filter-buttons{display:flex;gap:10px;flex-wrap:wrap}
    .filter-btn{padding:8px 16px;border:2px solid #e2e8f0;background:#fff;border-radius:20px;cursor:pointer;transition:.3s;font-size:.9em;font-weight:500}
    .filter-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .filter-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
    .filter-btn.filter-pendiente.active{background:var(--warning-color);border-color:var(--warning-color)}
    .filter-btn.filter-falta.active{background:var(--danger-color);border-color:var(--danger-color)}
    .filter-btn.filter-pagado.active{background:var(--success-color);border-color:var(--success-color)}
    .filter-info{margin-top:15px;padding:10px;background:#f0f9ff;border-radius:8px;font-size:.9em;color:#0369a1;display:none}
    .alert-banner{background:linear-gradient(135deg,var(--warning-color),var(--danger-color));color:#fff;padding:15px 20px;border-radius:10px;margin-bottom:20px;display:none;align-items:center;gap:15px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.9}}
    .alert-banner.show{display:flex}
    .alert-icon{font-size:1.5em}
    .alert-text{flex:1}
    .alert-text strong{font-size:1.1em}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:.95em}
    thead{background:var(--secondary-color);color:var(--text-light)}
    th,td{padding:12px 15px;text-align:left;border-bottom:1px solid #e2e8f0;vertical-align:middle}
    tbody tr:nth-child(even){background:var(--light-bg)}
    tbody tr:hover{background:#e0e7ff}
    tbody tr.highlight-pending{background:#fef3c7!important;border-left:4px solid var(--warning-color)}
    tbody tr.highlight-falta{background:#fee2e2!important;border-left:4px solid var(--danger-color)}
    .action-buttons{display:flex;gap:5px;align-items:center}
    .status-span{display:inline-block;width:100%;font-weight:bold;color:#fff;padding:8px;border-radius:5px;text-align:center}
    .status-span.pagado{background:var(--success-color)}
    .status-span.pendiente{background:var(--warning-color)}
    .status-span.falta-de-pago{background:var(--danger-color)}
    .status-span.terminado{background:var(--finished-color)}
    .editable{cursor:pointer;position:relative}
    .editable:hover::after{content:'‚úèÔ∏è';position:absolute;right:5px;top:50%;transform:translateY(-50%);font-size:.9em;opacity:.7}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:14px;padding:30px;width:90%;max-width:500px;position:relative;max-height:90vh;overflow-y:auto}
    .modal-content h2{margin-bottom:20px;color:var(--secondary-color)}
    .modal-form .form-group{margin-bottom:15px}
    .modal-form input,.modal-form select{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:.9em}
    .modal-form .form-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
    .close-btn{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;cursor:pointer;color:#64748b}
    .receipt-preview{background:#fff;padding:0;border:1px solid #e2e8f0;border-radius:10px;margin:20px 0;box-shadow:0 5px 15px rgba(0,0,0,.1);overflow:hidden}
    .receipt-header{background:linear-gradient(135deg,var(--secondary-color),var(--primary-color));color:#fff;text-align:center;padding:30px}
    .receipt-header h1{font-size:1.8em;margin-bottom:10px;font-weight:300;letter-spacing:2px}
    .receipt-header .company-name{font-size:1.3em;font-weight:600;margin-bottom:15px}
    .receipt-header .receipt-info{display:flex;justify-content:space-between;margin-top:20px;font-size:.9em}
    .receipt-body{padding:30px;background:#fafbfc}
    .receipt-detail{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0}
    .receipt-detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9}
    .receipt-detail-row:last-child{border-bottom:none}
    .receipt-detail-label{font-weight:600;color:var(--secondary-color)}
    .receipt-total{background:var(--primary-color);color:#fff;padding:20px;border-radius:8px;text-align:center;margin:20px 0}
    .receipt-total .amount{font-size:2em;font-weight:700}
    .receipt-footer{padding:30px;display:flex;justify-content:space-between;background:#fff;border-top:2px solid #e2e8f0}
    .signature-container{text-align:center;flex:1}
    .signature-container img{max-width:150px;height:60px;object-fit:contain;margin-bottom:10px}
    .signature-line{border-top:2px solid #1e293b;width:200px;margin:10px auto}
    .signature-config{margin-top:20px;padding:20px;background:var(--light-bg);border-radius:10px}
    .signature-preview{margin-top:10px;padding:20px;background:#fff;border:2px dashed #e2e8f0;border-radius:8px;text-align:center}
    .signature-preview img{max-width:200px;height:80px;object-fit:contain}
    .month-navigation{display:flex;align-items:center;gap:10px}
    .month-nav-btn{background:var(--primary-color);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:1.2em;transition:.2s}
    .month-nav-btn:hover{background:var(--secondary-color)}
    .month-display{font-weight:600;color:var(--secondary-color);font-size:1.1em;min-width:150px;text-align:center}
    .back-to-portal{position:fixed;top:20px;left:20px;background:var(--secondary-color);color:#fff;padding:10px 20px;border-radius:8px;text-decoration:none;font-weight:600;display:flex;align-items:center;gap:8px;z-index:100;transition:.3s}
    .back-to-portal:hover{background:var(--primary-color);transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    @media print{
      body,.container,.main-content{visibility:hidden;padding:0;margin:0}
      .print-area,.print-area *{visibility:visible}
      .print-area{position:absolute;left:0;top:0;width:100%}
      .no-print{display:none!important}
      .receipt-preview{visibility:visible!important;position:absolute;left:0;top:0;width:100%;border:none;box-shadow:none;margin:0}
      .back-to-portal{display:none!important}
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-to-portal no-print">‚Üê Volver al Portal</a>
  
  <div class="container">
    <div class="header">
      <h1>üíº Control de Abonos Mensuales</h1>
      <p>Estudio Garc√≠a y Asociados - Sistema de Gesti√≥n</p>
    </div>

    <div class="main-content">
      <div id="driveStatus" class="data-status" style="display:none;"></div>

      <div id="alertBanner" class="alert-banner">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-text">
          <strong>Atenci√≥n:</strong> Hay <span id="alertCount">0</span> clientes con pagos pendientes o en falta de pago este mes.
        </div>
        <button id="btnVerPendientes" class="btn btn-danger">Ver Pendientes</button>
      </div>

      <div class="dashboard">
        <div class="card">
          <h3>Total Cobrado</h3>
          <div class="value-container">
            <div class="value positive" id="totalCobrado">$0.00</div>
            <button class="toggle-visibility" id="toggleAmountBtn" title="Ocultar/Mostrar monto">
              <span id="toggleIcon">üëÅÔ∏è</span>
            </button>
          </div>
        </div>
        <div class="card"><h3>Total Registros</h3><div class="value" id="totalRegistros">0</div></div>
        <div class="card warning-card"><h3>Pendientes</h3><div class="value" id="totalPendientes" style="color:var(--warning-color);">0</div></div>
        <div class="card danger-card"><h3>Falta de Pago</h3><div class="value" id="totalFaltaPago" style="color:var(--danger-color);">0</div></div>
      </div>

      <div class="controls no-print">
        <div class="form-group">
          <label>Mes Seleccionado:</label>
          <div class="month-navigation">
            <button id="btnPrevMonth" class="month-nav-btn">‚óÄ</button>
            <div class="month-display" id="monthDisplay"></div>
            <button id="btnNextMonth" class="month-nav-btn">‚ñ∂</button>
          </div>
        </div>
        <div>
          <button class="btn btn-success" id="add-record-btn">‚ûï Agregar Registro</button>
          <button class="btn btn-info" id="carry-btn">üìã Arrastrar Clientes</button>
          <button class="btn" style="background:#8e44ad;" id="print-btn">üñ®Ô∏è Imprimir</button>
          <button class="btn" id="export-btn">üìä Exportar Excel</button>
          <button class="btn" id="export-json-btn">üíæ Exportar JSON</button>
          <button class="btn btn-warning" id="import-json-btn">üì• Importar JSON</button>
          <button class="btn btn-warning" id="config-btn">‚öôÔ∏è Config</button>
        </div>
      </div>

      <section style="text-align:center;margin-bottom:30px;border-top:1px solid #ddd;padding-top:20px;">
        <button id="connectDriveBtn" class="btn btn-drive" onclick="handleAuthClick()">üîó Conectar a Drive</button>
        <button id="saveToDriveBtn" class="btn btn-success" style="display:none;" onclick="saveDataToDrive()">üì§ Guardar en Drive</button>
        <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;" onclick="loadDataFromDrive()">üì• Cargar de Drive</button>
      </section>

      <div class="filters-container no-print">
        <h4 style="margin-bottom:15px;color:var(--secondary-color);">üîç Filtrar por Estado:</h4>
        <div class="filter-buttons" id="filtersBar">
          <button class="filter-btn active" data-status="todos">Todos (<span id="countTodos">0</span>)</button>
          <button class="filter-btn filter-pendiente" data-status="pendiente">‚è≥ Pendiente (<span id="countPendiente">0</span>)</button>
          <button class="filter-btn filter-falta" data-status="falta-de-pago">‚ùå Falta de Pago (<span id="countFalta">0</span>)</button>
          <button class="filter-btn filter-pagado" data-status="pagado">‚úÖ Pagado (<span id="countPagado">0</span>)</button>
          <button class="filter-btn" data-status="terminado">üèÅ Terminado (<span id="countTerminado">0</span>)</button>
          <button class="filter-btn" data-status="pendientes">üö® Todos los Pendientes (<span id="countAllPendientes">0</span>)</button>
        </div>
        <div id="filterInfo" class="filter-info"></div>
      </div>

      <div id="print-area" class="print-area">
        <h2 id="table-title" style="display:none;text-align:center;margin-bottom:20px;"></h2>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Cliente</th><th>Tipo</th><th>Monto Abono</th><th>Fecha de Pago</th><th>Forma de Pago</th><th>Estado</th><th class="no-print">Acciones</th>
              </tr>
            </thead>
            <tbody id="abonosTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="importInput" accept=".json" style="display:none">

  <!-- Modal para Abono -->
  <div id="abonoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="abonoModalClose">‚úñ</button>
      <h2 id="modalTitle">Agregar Nuevo Registro</h2>
      <form id="abonoForm" class="modal-form">
        <div class="form-group"><label>Cliente</label><input type="text" id="cliente" required></div>
        <div class="form-group"><label>Tipo</label><select id="tipo"></select></div>
        <div class="form-group"><label>Monto</label><input type="number" id="monto" required step="0.01"></div>
        <div class="form-group"><label>Fecha de Pago</label><input type="date" id="fechaPago"></div>
        <div class="form-group"><label>Forma de Pago</label><input type="text" id="formaPago"></div>
        <div class="form-group"><label>Estado</label><select id="estado"></select></div>
        <div class="form-actions">
          <button type="button" class="btn" id="abonoModalCancel" style="background-color:#94a3b8;">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Recibo -->
  <div id="receiptModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
      <button class="close-btn" id="receiptClose">‚úñ</button>
      <div id="receiptContent" class="receipt-preview"></div>
      <div class="form-actions">
        <button type="button" class="btn" id="printReceiptBtn">üñ®Ô∏è Imprimir Recibo</button>
        <button type="button" class="btn" id="receiptCancel" style="background-color:#94a3b8;">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Config -->
  <div id="configModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="configClose">‚úñ</button>
      <h2>‚öôÔ∏è Configuraci√≥n</h2>
      <div class="signature-config">
        <h3>Firma para Recibos</h3>
        <div class="form-group">
          <label>Cargar imagen de firma (PNG, JPG)</label>
          <input type="file" id="signatureFile" accept="image/*">
        </div>
        <div class="signature-preview">
          <div id="signaturePreview"><p style="color:#94a3b8;">No hay firma cargada</p></div>
        </div>
        <button class="btn" id="removeSignatureBtn" style="background-color:var(--danger-color);margin-top:10px;">üóëÔ∏è Eliminar Firma</button>
      </div>
    </div>
  </div>

  <script>
    // ====== ESTADO APP ======
    let abonosData = [];
    let currentMonth;
    let signatureImage = null;
    let currentFilter = 'todos';
    let isAmountHidden = false;
    let realAmount = 0;
    const TIPO_OPTIONS = ['Abono Mensual','Honorarios Siniestro','Regulaci√≥n Honorarios'];
    const ESTADO_OPTIONS = ['Pendiente','Pagado','Falta de Pago','Terminado'];
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', function() {
      // Botones principales
      document.getElementById('toggleAmountBtn').addEventListener('click', toggleAmountVisibility);
      document.getElementById('btnPrevMonth').addEventListener('click', function(){ changeMonth(-1); });
      document.getElementById('btnNextMonth').addEventListener('click', function(){ changeMonth(1); });
      document.getElementById('add-record-btn').addEventListener('click', openModal);
      document.getElementById('carry-btn').addEventListener('click', carryOverClients);
      document.getElementById('print-btn').addEventListener('click', printTable);
      document.getElementById('export-btn').addEventListener('click', exportToExcel);
      document.getElementById('export-json-btn').addEventListener('click', exportData);
      document.getElementById('import-json-btn').addEventListener('click', function(){ document.getElementById('importInput').click(); });
      document.getElementById('config-btn').addEventListener('click', openConfigModal);
      document.getElementById('btnVerPendientes').addEventListener('click', function(){ filterByStatus('pendientes'); });

      document.getElementById('importInput').addEventListener('change', handleImport);

      // Filtros delegaci√≥n
      document.getElementById('filtersBar').addEventListener('click', function(e){
        var btn = e.target.closest('.filter-btn');
        if(!btn){ return; }
        document.querySelectorAll('.filter-btn').forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        filterByStatus(btn.getAttribute('data-status'));
      });

      // Tabla delegaci√≥n
      document.getElementById('abonosTableBody').addEventListener('click', function(event){
        var target = event.target;
        if(target.classList.contains('delete-btn')) {
          deleteAbono(target.getAttribute('data-id'));
        } else if(target.classList.contains('receipt-btn')) {
          generateReceipt(target.getAttribute('data-id'));
        } else {
          var cell = target.closest('.editable');
          if(cell){ handleCellEdit(cell); }
        }
      });

      // Modal Abono
      document.getElementById('abonoModalClose').addEventListener('click', closeModal);
      document.getElementById('abonoModalCancel').addEventListener('click', closeModal);
      document.getElementById('abonoModal').addEventListener('click', function(e){ if(e.target.id === 'abonoModal'){ closeModal(); } });
      document.getElementById('abonoForm').addEventListener('submit', handleFormSubmit);

      // Modal Recibo
      document.getElementById('receiptClose').addEventListener('click', function(){ document.getElementById('receiptModal').classList.remove('active'); });
      document.getElementById('receiptCancel').addEventListener('click', function(){ document.getElementById('receiptModal').classList.remove('active'); });
      document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);

      // Modal Config
      document.getElementById('configClose').addEventListener('click', closeConfigModal);
      document.getElementById('removeSignatureBtn').addEventListener('click', removeSignature);
      document.getElementById('signatureFile').addEventListener('change', handleSignatureUpload);

      // Datos
      loadData();
      loadSignature();
      initializeMonth();
      setupModal();
      render();
    });

    // ====== UTIL DATOS ======
    function saveData(){ localStorage.setItem('abonosData', JSON.stringify(abonosData)); }
    function loadData(){ var s = localStorage.getItem('abonosData'); abonosData = s ? JSON.parse(s) : []; }

    function saveSignature(){ if(signatureImage){ localStorage.setItem('signatureImage', signatureImage); } else { localStorage.removeItem('signatureImage'); } }
    function loadSignature(){ signatureImage = localStorage.getItem('signatureImage'); updateSignaturePreview(); }
    function updateSignaturePreview(){
      var el = document.getElementById('signaturePreview');
      if(signatureImage){ el.innerHTML = '<img src="'+signatureImage+'" alt="Firma">'; }
      else { el.innerHTML = '<p style="color:#94a3b8;">No hay firma cargada</p>'; }
    }

    function getAbonosForMonth(month, year){
      return abonosData.filter(function(a){
        if(!a.fechaPago) return false;
        var d = new Date(a.fechaPago + 'T00:00:00');
        return d.getMonth() === month && d.getFullYear() === year;
      });
    }

    function addAbono(newAbono){ newAbono.id='abono_'+Date.now(); abonosData.push(newAbono); saveData(); render(); }
    function updateAbono(id, updatedData){
      var idx = abonosData.findIndex(function(a){ return a.id===id; });
      if(idx !== -1){ abonosData[idx] = Object.assign({}, abonosData[idx], updatedData); saveData(); render(); }
    }
    function deleteAbono(id){
      if(confirm('¬øEliminar este registro?')){
        abonosData = abonosData.filter(function(a){ return a.id !== id; });
        saveData(); render();
      }
    }

    // ====== FILTROS ======
    function filterByStatus(status){
      currentFilter = status;
      var info = document.getElementById('filterInfo');
      if(status === 'todos'){ info.style.display='none'; }
      else {
        info.style.display='block';
        var m = {
          'pendiente':'Mostrando solo registros pendientes',
          'falta-de-pago':'Mostrando solo registros con falta de pago',
          'pagado':'Mostrando solo registros pagados',
          'terminado':'Mostrando solo registros terminados',
          'pendientes':'Mostrando todos los registros pendientes y con falta de pago'
        };
        info.textContent = m[status] || '';
      }
      render();
    }
    function getFilteredAbonos(abonos){
      if(currentFilter==='todos') return abonos;
      if(currentFilter==='pendientes') return abonos.filter(function(a){ return a.estado==='Pendiente'||a.estado==='Falta de Pago'; });
      return abonos.filter(function(a){
        var estado = (a.estado||'').toLowerCase().replace(/ /g,'-');
        return estado === currentFilter;
      });
    }

    // ====== ARRASTRE CLIENTES ======
    function carryOverClients(){
      var curr = getAbonosForMonth(currentMonth.month, currentMonth.year);
      if(curr.length===0){ alert('No hay clientes en el mes actual para arrastrar.'); return; }
      var nm = currentMonth.month + 1, ny=currentMonth.year;
      if(nm>11){ nm=0; ny++; }
      var unique = Array.from(new Set(curr.map(function(a){ return a.cliente; })));
      var next = getAbonosForMonth(nm, ny);
      var existing = new Set(next.map(function(a){ return a.cliente; }));
      var added=0;

      unique.forEach(function(cliente){
        if(!existing.has(cliente)){
          var last = curr.filter(function(a){ return a.cliente===cliente; }).sort(function(a,b){ return new Date(b.fechaPago)-new Date(a.fechaPago); })[0];
          var dateStr = ny+'-'+String(nm+1).padStart(2,'0')+'-01';
          addAbono({ cliente:cliente, tipo:(last.tipo||'Abono Mensual'), monto:(last.monto||0), fechaPago:dateStr, formaPago:(last.formaPago||''), estado:'Pendiente' });
          added++;
        }
      });

      if(added>0){
        alert('Se arrastraron '+added+' clientes al mes de '+MONTHS[nm]+' '+ny+'.');
        currentMonth = { month:nm, year:ny }; updateMonthDisplay(); render();
      } else {
        alert('Todos los clientes ya existen en el pr√≥ximo mes.');
      }
    }

    // ====== MES ======
    function initializeMonth(){ var t=new Date(); currentMonth = { month:t.getMonth(), year:t.getFullYear() }; updateMonthDisplay(); }
    function changeMonth(dir){
      currentMonth.month += dir;
      if(currentMonth.month>11){ currentMonth.month=0; currentMonth.year++; }
      else if(currentMonth.month<0){ currentMonth.month=11; currentMonth.year--; }
      updateMonthDisplay(); render();
    }
    function updateMonthDisplay(){ document.getElementById('monthDisplay').textContent = MONTHS[currentMonth.month]+' '+currentMonth.year; }

    // ====== FIRMA ======
    function handleSignatureUpload(event){
      var file = event.target.files[0];
      if(file && file.type.startsWith('image/')){
        var reader = new FileReader();
        reader.onload = function(e){ signatureImage = e.target.result; saveSignature(); updateSignaturePreview(); };
        reader.readAsDataURL(file);
      }
    }
    function removeSignature(){
      if(confirm('¬øEst√° seguro de eliminar la firma?')){
        signatureImage = null; saveSignature(); updateSignaturePreview(); document.getElementById('signatureFile').value='';
      }
    }

    // ====== RENDER ======
    function formatCurrency(v){ return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(v||0); }
    function toggleAmountVisibility(){
      isAmountHidden = !isAmountHidden;
      var totalCobradoEl = document.getElementById('totalCobrado');
      var toggleIcon = document.getElementById('toggleIcon');
      if(isAmountHidden){ totalCobradoEl.textContent='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; totalCobradoEl.classList.add('hidden-value'); toggleIcon.textContent='üëÅÔ∏è‚Äçüó®Ô∏è'; }
      else { totalCobradoEl.textContent=formatCurrency(realAmount); totalCobradoEl.classList.remove('hidden-value'); toggleIcon.textContent='üëÅÔ∏è'; }
    }

    function render(){
      var mes = getAbonosForMonth(currentMonth.month, currentMonth.year);
      var filtered = getFilteredAbonos(mes);
      renderTable(filtered);
      renderDashboard(mes);
      updateFilterCounts(mes);
      updateAlertBanner(mes);
    }

    function renderDashboard(abonos){
      var totalCobrado = abonos.filter(function(a){ return a.estado==='Pagado'; }).reduce(function(s,a){ return s+Number(a.monto||0); },0);
      var totalPendientes = abonos.filter(function(a){ return a.estado==='Pendiente'; }).length;
      var totalFaltaPago = abonos.filter(function(a){ return a.estado==='Falta de Pago'; }).length;

      realAmount = totalCobrado;
      var el = document.getElementById('totalCobrado');
      if(isAmountHidden){ el.textContent='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; el.classList.add('hidden-value'); }
      else { el.textContent=formatCurrency(totalCobrado); el.classList.remove('hidden-value'); }

      document.getElementById('totalRegistros').textContent = abonos.length;
      document.getElementById('totalPendientes').textContent = totalPendientes;
      document.getElementById('totalFaltaPago').textContent = totalFaltaPago;
    }

    function updateFilterCounts(abonos){
      var counts = {
        todos: abonos.length,
        pendiente: abonos.filter(function(a){ return a.estado==='Pendiente'; }).length,
        'falta-de-pago': abonos.filter(function(a){ return a.estado==='Falta de Pago'; }).length,
        pagado: abonos.filter(function(a){ return a.estado==='Pagado'; }).length,
        terminado: abonos.filter(function(a){ return a.estado==='Terminado'; }).length,
        pendientes: abonos.filter(function(a){ return a.estado==='Pendiente'||a.estado==='Falta de Pago'; }).length
      };
      document.getElementById('countTodos').textContent = counts.todos;
      document.getElementById('countPendiente').textContent = counts.pendiente;
      document.getElementById('countFalta').textContent = counts['falta-de-pago'];
      document.getElementById('countPagado').textContent = counts.pagado;
      document.getElementById('countTerminado').textContent = counts.terminado;
      document.getElementById('countAllPendientes').textContent = counts.pendientes;
    }

    function updateAlertBanner(abonos){
      var n = abonos.filter(function(a){ return a.estado==='Pendiente'||a.estado==='Falta de Pago'; }).length;
      var banner = document.getElementById('alertBanner');
      if(n>0){ banner.classList.add('show'); document.getElementById('alertCount').textContent = n; }
      else { banner.classList.remove('show'); }
    }

    function renderTable(abonos){
      var body = document.getElementById('abonosTableBody');
      body.innerHTML = '';
      if(abonos.length===0){
        var msg = currentFilter==='todos' ? 'No hay registros para este mes.' : 'No hay registros que coincidan con el filtro seleccionado.';
        body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#94a3b8;">'+msg+'</td></tr>';
        return;
      }
      abonos.forEach(function(abono){
        var tr = document.createElement('tr');
        var isPagado = (abono.estado==='Pagado');
        var estadoClass = (abono.estado||'').toLowerCase().replace(/ /g,'-') || 'pendiente';
        if(abono.estado==='Pendiente'){ tr.classList.add('highlight-pending'); }
        else if(abono.estado==='Falta de Pago'){ tr.classList.add('highlight-falta'); }

        tr.innerHTML =
          '<td class="editable" data-id="'+abono.id+'" data-field="cliente" data-type="text">'+(abono.cliente||'')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="tipo" data-type="select" data-options=\''+JSON.stringify(TIPO_OPTIONS)+'\'>'+(abono.tipo||'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="monto" data-type="number">'+formatCurrency(abono.monto)+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="fechaPago" data-type="date">'+(abono.fechaPago?new Date(abono.fechaPago+'T00:00:00').toLocaleDateString('es-AR'):'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="formaPago" data-type="text">'+(abono.formaPago||'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="estado" data-type="select" data-options=\''+JSON.stringify(ESTADO_OPTIONS)+'\'><span class="status-span '+estadoClass+'">'+(abono.estado||'')+'</span></td>'+
          '<td class="no-print"><div class="action-buttons">'+
            '<button class="btn btn-success receipt-btn" data-id="'+abono.id+'" '+(isPagado?'':'disabled')+'>üßæ</button>'+
            '<button class="btn delete-btn" style="background-color:var(--danger-color);" data-id="'+abono.id+'">üóëÔ∏è</button>'+
          '</div></td>';
        body.appendChild(tr);
      });
    }

    function handleCellEdit(cell){
      if(cell.querySelector('input,select')) return;
      var id = cell.getAttribute('data-id');
      var field = cell.getAttribute('data-field');
      var type = cell.getAttribute('data-type');
      var options = cell.getAttribute('data-options');
      var abono = abonosData.find(function(a){ return a.id===id; });
      if(!abono){ return; }
      var currentValue = abono[field] || '';
      var editor;

      if(type==='select'){
        editor = document.createElement('select');
        JSON.parse(options).forEach(function(opt){
          var o = document.createElement('option');
          o.value = opt; o.textContent = opt;
          if(opt===currentValue){ o.selected = true; }
          editor.appendChild(o);
        });
      } else {
        editor = document.createElement('input');
        editor.type = type;
        if(type==='date' && currentValue){ editor.value = currentValue; }
        else if(type==='number'){ editor.value = parseFloat(currentValue)||''; }
        else { editor.value = currentValue; }
      }

      cell.innerHTML = '';
      cell.appendChild(editor);
      editor.focus();

      var saveChange = function(){
        var newValue = (type==='number') ? (parseFloat(editor.value)||0) : editor.value;
        updateAbono(id, (function(o){ o[field]=newValue; return o; })({}));
      };

      editor.addEventListener('blur', saveChange);
      editor.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); editor.blur(); } });
    }

    function setupModal(){
      var tipo = document.getElementById('tipo');
      var estado = document.getElementById('estado');
      tipo.innerHTML=''; estado.innerHTML='';
      TIPO_OPTIONS.forEach(function(opt){ var o=document.createElement('option'); o.value=opt; o.textContent=opt; tipo.appendChild(o); });
      ESTADO_OPTIONS.forEach(function(opt){ var o=document.createElement('option'); o.value=opt; o.textContent=opt; estado.appendChild(o); });
    }

    function openModal(){
      var form = document.getElementById('abonoForm');
      form.reset();
      var ds = currentMonth.year+'-'+String(currentMonth.month+1).padStart(2,'0')+'-'+String(new Date().getDate()).padStart(2,'0');
      document.getElementById('fechaPago').value = ds;
      document.getElementById('modalTitle').textContent = 'Agregar Nuevo Registro';
      document.getElementById('abonoModal').classList.add('active');
    }
    function closeModal(){ document.getElementById('abonoModal').classList.remove('active'); }

    function openConfigModal(){ document.getElementById('configModal').classList.add('active'); }
    function closeConfigModal(){ document.getElementById('configModal').classList.remove('active'); }

    function handleFormSubmit(e){
      e.preventDefault();
      var data = {
        cliente: document.getElementById('cliente').value,
        tipo: document.getElementById('tipo').value,
        monto: parseFloat(document.getElementById('monto').value),
        fechaPago: document.getElementById('fechaPago').value,
        formaPago: document.getElementById('formaPago').value,
        estado: document.getElementById('estado').value
      };
      addAbono(data);
      closeModal();
    }

    function printTable(){
      var ft = (currentFilter==='todos') ? '' : ' ('+currentFilter.replace('-',' ')+')';
      var title = 'Resumen de Abonos - '+MONTHS[currentMonth.month]+' '+currentMonth.year+ft;
      var h = document.getElementById('table-title');
      h.textContent = title; h.style.display='block';
      window.print();
      setTimeout(function(){ h.style.display='none'; }, 100);
    }

    // ====== RECIBOS ======
    function generateReceipt(abonoId){
      var abono = abonosData.find(function(a){ return a.id===abonoId; });
      if(!abono || abono.estado!=='Pagado'){ return; }

      var receiptDate = new Date().toLocaleDateString('es-AR');
      var receiptNumber = String(Date.now()).slice(-8);

      var parts = [];
      parts.push(
        '<div class="receipt-header">',
          '<div class="company-name">ESTUDIO GARC√çA Y ASOCIADOS</div>',
          '<h1>RECIBO DE PAGO</h1>',
          '<div class="receipt-info">',
            '<div>Fecha: ', receiptDate, '</div>',
            '<div>Recibo N¬∞: ', receiptNumber, '</div>',
          '</div>',
        '</div>',
        '<div class="receipt-body">',
          '<div class="receipt-detail">',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Cliente:</span><span>', (abono.cliente||''), '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Concepto:</span><span>', (abono.tipo||''), '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Fecha de Pago:</span><span>', (abono.fechaPago? new Date(abono.fechaPago+'T00:00:00').toLocaleDateString('es-AR') : ''), '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Forma de Pago:</span><span>', (abono.formaPago||'Efectivo'), '</span></div>',
          '</div>',
          '<div class="receipt-total"><div>TOTAL ABONADO</div><div class="amount">', formatCurrency(abono.monto), '</div></div>',
        '</div>',
        '<div class="receipt-footer">',
          '<div class="signature-container"><div class="signature-line"></div><p>Firma del Cliente</p></div>',
          '<div class="signature-container">', (signatureImage?('<img src="'+signatureImage+'" alt="Firma">'):'') ,'<div class="signature-line"></div><p>Firma Autorizada</p></div>',
        '</div>'
      );

      document.getElementById('receiptContent').innerHTML = parts.join('');
      document.getElementById('receiptModal').classList.add('active');
    }

    function printReceipt(){
      var content = document.getElementById('receiptContent').innerHTML.replace(/<\/script/gi,'<\\/script');
      var w = window.open('','_blank');
      var html = [];
      html.push('<!doctype html><html><head><meta charset="utf-8"><title>Recibo de Pago - Estudio Garc√≠a y Asociados</title><style>',
        'body{font-family:Arial,sans-serif;margin:0;padding:20px}',
        '.receipt-preview{max-width:700px;margin:0 auto}',
        '.receipt-header{background:linear-gradient(135deg,#1e293b,#1e3a8a);color:#fff;text-align:center;padding:30px}',
        '.receipt-header h1{font-size:1.8em;margin-bottom:10px;font-weight:300;letter-spacing:2px}',
        '.company-name{font-size:1.3em;font-weight:600;margin-bottom:15px}',
        '.receipt-info{display:flex;justify-content:space-between;margin-top:20px;font-size:.9em}',
        '.receipt-body{padding:30px;background:#fafbfc}',
        '.receipt-detail{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0}',
        '.receipt-detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9}',
        '.receipt-detail-row:last-child{border-bottom:none}',
        '.receipt-detail-label{font-weight:600;color:#1e293b}',
        '.receipt-total{background:#1e3a8a;color:#fff;padding:20px;border-radius:8px;text-align:center;margin:20px 0}',
        '.receipt-total .amount{font-size:2em;font-weight:700}',
        '.receipt-footer{padding:30px;display:flex;justify-content:space-between;background:#fff;border-top:2px solid #e2e8f0}',
        '.signature-container{text-align:center;flex:1}',
        '.signature-container img{max-width:150px;height:60px;object-fit:contain;margin-bottom:10px}',
        '.signature-line{border-top:2px solid #1e293b;width:200px;margin:10px auto}',
        '@media print{body{margin:0}}',
      '</style></head><body><div class="receipt-preview">');
      html.push(content);
      html.push('</div></body></html>');
      w.document.write(html.join(''));
      w.document.close();
      w.print();
    }

    // ====== IMPORT/EXPORT ======
    function exportData(){
      var dataStr = JSON.stringify(abonosData, null, 2);
      var uri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      var name = 'control_abonos_'+new Date().toISOString().slice(0,10)+'.json';
      var a = document.createElement('a');
      a.href = uri; a.download = name; a.click();
    }

    function handleImport(event){
      var file = event.target.files[0]; if(!file) return;
      var reader = new FileReader();
      reader.onload = function(e){
        try{
          var imported = JSON.parse(e.target.result);
          if(Array.isArray(imported) && confirm('¬øImportar '+imported.length+' registros? Esto sobreescribir√° los datos actuales.')){
            abonosData = imported; saveData(); loadData(); render(); alert('Datos importados exitosamente');
          }
        }catch(err){ alert('Error al importar el archivo. Verifique que sea un JSON v√°lido.'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function exportToExcel(){
      var abonosMes = getAbonosForMonth(currentMonth.month, currentMonth.year);
      var data = (currentFilter==='todos') ? abonosMes : getFilteredAbonos(abonosMes);
      if(data.length===0){ alert('No hay datos para exportar.'); return; }

      var rows = data.map(function(a){
        return { Cliente:a.cliente, Tipo:a.tipo, Monto:a.monto, 'Fecha de Pago':a.fechaPago, 'Forma de Pago':a.formaPago, Estado:a.estado };
      });
      var ws = XLSX.utils.json_to_sheet(rows);
      var wb = XLSX.utils.book_new();
      var sheetName = (currentFilter==='todos') ? 'Todos los Abonos' : ('Abonos '+currentFilter.replace('-',' '));
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
      XLSX.writeFile(wb, 'Abonos_'+MONTHS[currentMonth.month]+'_'+currentMonth.year+'_'+currentFilter+'.xlsx');
    }
  </script>
  
  <!-- IMPORTANTE: Primero definir las funciones globales ANTES de cargar los scripts -->
  <script>
    // GOOGLE DRIVE - VARIABLES Y FUNCIONES GLOBALES
    const CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DATA_FILE_NAME = 'datos_control_abonos_mensuales.json';

    let tokenClient, gapiInited = false, gisInited = false, dataFileId = null;

    function gapiLoaded() { 
      gapi.load('client', initializeGapiClient); 
    }
    
    async function initializeGapiClient() { 
      await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }); 
      gapiInited = true; 
      maybeEnableButtons(); 
    }
    
    function gisLoaded() { 
      tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); 
      gisInited = true; 
      maybeEnableButtons(); 
    }
    
    function maybeEnableButtons() { 
      if (gapiInited && gisInited) {
        // Nada que hacer aqu√≠, los botones tienen onclick directo en el HTML
      }
    }
    
    function updateDriveStatus(message, isConnected = false) { 
      const driveStatusEl = document.getElementById('driveStatus');
      driveStatusEl.style.display = 'block'; 
      driveStatusEl.textContent = message; 
      driveStatusEl.style.background = isConnected ? '#d1e7dd' : '#fff3cd'; 
      driveStatusEl.style.color = isConnected ? '#0f5132' : '#664d03'; 
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw (resp);
        updateDriveStatus('‚úÖ Conectado a Google Drive', true);
        document.getElementById('connectDriveBtn').style.display = 'none'; 
        document.getElementById('saveToDriveBtn').style.display = 'inline-block'; 
        document.getElementById('loadFromDriveBtn').style.display = 'inline-block';
        await findDataFile();
      };
      if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'}); 
      else tokenClient.requestAccessToken({prompt: ''});
    }
    
    async function findDataFile() {
      updateDriveStatus('Buscando archivo de datos en Drive...', false);
      try {
        const response = await gapi.client.drive.files.list({ q: `name='${DATA_FILE_NAME}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
        if (response.result.files.length > 0) { dataFileId = response.result.files[0].id; updateDriveStatus('‚úÖ Archivo de datos encontrado en Drive.', true); }
        else { updateDriveStatus('‚ö†Ô∏è Archivo no encontrado. Se crear√° uno nuevo al guardar.', false); dataFileId = null; }
      } catch (err) { console.error(err); alert('Error al buscar el archivo de datos en Drive.'); }
    }
    
    async function saveDataToDrive() {
      if (!confirm('¬øGuardar los datos actuales en Google Drive? Esto sobreescribir√° la versi√≥n anterior en la nube.')) return;
      updateDriveStatus('Guardando datos en Drive...', false);
      try {
        const content = JSON.stringify(abonosData, null, 2);
        dataFileId = await uploadContent(content, DATA_FILE_NAME, 'application/json', null, dataFileId);
        updateDriveStatus('‚úÖ ¬°Datos guardados en Drive con √©xito!', true);
      } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al guardar en Drive.', false); }
    }
    
    async function loadDataFromDrive() {
      if (!dataFileId) return alert("No se ha encontrado un archivo de datos. Guarda primero para crear uno.");
      if (!confirm("¬øSeguro? Se reemplazar√°n los datos locales con los de Drive.")) return;
      updateDriveStatus('Cargando datos desde Drive...', false);
      try {
        const response = await gapi.client.drive.files.get({ fileId: dataFileId, alt: 'media' });
        const importedData = JSON.parse(response.body);
        if (!Array.isArray(importedData)) throw new Error('Formato no v√°lido.');
        abonosData = importedData;
        saveData();
        loadData();
        render();
        updateDriveStatus('‚úÖ Datos cargados desde Drive con √©xito.', true);
      } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al cargar desde Drive.', false); alert('Error al cargar desde Drive: ' + err.message); }
    }
    
    async function uploadContent(content, fileName, mimeType, parentId, fileIdToUpdate) {
      const boundary = '-------314159265358979323846';
      const metadata = { name: fileName, mimeType: mimeType, ...(parentId && {parents: [parentId]}) };
      const base64Data = content instanceof ArrayBuffer ? btoa(String.fromCharCode.apply(null, new Uint8Array(content))) : btoa(unescape(encodeURIComponent(content)));
      const requestBody =
        `--${boundary}\r\n` +
        `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
        JSON.stringify(metadata) +
        `\r\n--${boundary}\r\n` +
        `Content-Type: ${mimeType}\r\n` +
        `Content-Transfer-Encoding: base64\r\n\r\n` +
        base64Data +
        `\r\n--${boundary}--`;
        
      const request = gapi.client.request({
        path: fileIdToUpdate ? `/upload/drive/v3/files/${fileIdToUpdate}` : '/upload/drive/v3/files',
        method: fileIdToUpdate ? 'PATCH' : 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
        body: requestBody
      });
      const response = await request;
      return response.result.id;
    }
  </script>
  
  <!-- AHORA S√ç cargamos los scripts de Google con las funciones ya definidas -->
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  
</body>
</html>
