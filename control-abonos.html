<!DOCTYPE html>
<html lang="es-AR">
<head>
  <meta charset="UTF-8">
  <title>Control de Abonos Mensuales - Estudio Garc√≠a y Asociados</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
  <style>
    :root{
      --primary-color:#1e3a8a;--secondary-color:#1e293b;--success-color:#059669;--danger-color:#dc2626;--warning-color:#f59e0b;--info-color:#6366f1;--light-bg:#f8fafc;--text-dark:#1e293b;--text-light:#f1f5f9;--disabled-color:#94a3b8;--finished-color:#64748b;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Arial,sans-serif;background:#f1f5f9;min-height:100vh;padding:20px;color:var(--text-dark)}
    .container{max-width:1600px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,var(--secondary-color),var(--primary-color));color:var(--text-light);padding:30px;text-align:center;border-bottom:5px solid var(--primary-color)}
    .header h1{font-size:2.2em;margin-bottom:8px}
    .header p{font-size:1.1em;opacity:.9}
    .main-content{padding:30px}
    .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
    /* MODIFICACI√ìN 1: Se convierte la tarjeta en un contenedor flex para alinear el contenido verticalmente */
    .card{background:var(--light-bg);border-radius:12px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.07);border-left:5px solid var(--primary-color);transition:.2s;position:relative;display:flex;flex-direction:column;justify-content:space-between;}
    .card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(0,0,0,.1)}
    .card h3{color:var(--secondary-color);margin-bottom:10px;font-size:0.9em;text-transform:uppercase;letter-spacing:.5px}
    .card .value{font-size:1.3em;font-weight:700;color:var(--primary-color);word-break:break-word;overflow-wrap:break-word}
    .card .value.positive{color:var(--success-color)}
    .card.success-card{border-left-color:var(--success-color)}
    .card.warning-card{border-left-color:var(--warning-color)}
    .card.danger-card{border-left-color:var(--danger-color)}
    /* MODIFICACI√ìN 2: Nuevo contenedor para el t√≠tulo y el bot√≥n del ojo */
    .title-container{display:flex;justify-content:space-between;align-items:flex-start;}
    .value-container{display:flex;align-items:center;justify-content:space-between}
    .toggle-visibility{background:none;border:none;font-size:1.4em;cursor:pointer;color:var(--secondary-color);transition:.3s;padding:0;opacity:.6;line-height:1;}
    .toggle-visibility:hover{opacity:1;transform:scale(1.1)}
    .hidden-value{letter-spacing:5px}
    .controls{background:var(--light-bg);padding:20px;border-radius:10px;margin-bottom:30px;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;gap:20px}
    .form-group{display:flex;flex-direction:column;gap:5px}
    .form-group label{font-weight:600;font-size:.85em;color:var(--text-dark)}
    .form-group select,.form-group input,.form-group textarea{padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:.9em;background:#fff}
    .form-group textarea{resize:vertical;min-height:80px}
    .btn{background:var(--primary-color);color:var(--text-light);border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:.9em;transition:.25s;font-weight:600;margin:0 5px}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(30,58,138,.3)}
    .btn:disabled{background:var(--disabled-color);cursor:not-allowed;transform:none;box-shadow:none}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color)}
    .btn-info{background:var(--info-color)}
    .btn-danger{background:var(--danger-color)}
    .btn-drive{background:#4285f4}
    .btn-small{padding:5px 10px;font-size:0.8em;margin:0 2px}
    .data-status{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;border-radius:8px;margin-bottom:20px;text-align:center}
    .filters-container{background:#fff;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 3px 10px rgba(0,0,0,.05)}
    .search-container{margin-bottom:20px}
    #searchInput{width:100%;padding:12px;border-radius:8px;border:2px solid #e2e8f0;font-size:1em}
    .filter-buttons{display:flex;gap:10px;flex-wrap:wrap}
    .filter-btn{padding:8px 16px;border:2px solid #e2e8f0;background:#fff;border-radius:20px;cursor:pointer;transition:.3s;font-size:.9em;font-weight:500}
    .filter-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .filter-btn.active{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
    .filter-btn.filter-pendiente.active{background:var(--warning-color);border-color:var(--warning-color)}
    .filter-btn.filter-falta.active{background:var(--danger-color);border-color:var(--danger-color)}
    .filter-btn.filter-pagado.active{background:var(--success-color);border-color:var(--success-color)}
    .filter-btn.filter-terminado-global.active{background:var(--finished-color);border-color:var(--finished-color)}
    .filter-info{margin-top:15px;padding:10px;background:#f0f9ff;border-radius:8px;font-size:.9em;color:#0369a1;display:none}
    .alert-banner{background:linear-gradient(135deg,var(--warning-color),var(--danger-color));color:#fff;padding:15px 20px;border-radius:10px;margin-bottom:20px;display:none;align-items:center;gap:15px;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.9}}
    .alert-banner.show{display:flex}
    .alert-icon{font-size:1.5em}
    .alert-text{flex:1}
    .alert-text strong{font-size:1.1em}
    table{width:100%;border-collapse:collapse;margin-top:20px;font-size:.95em}
    thead{background:var(--secondary-color);color:var(--text-light)}
    th,td{padding:12px 15px;text-align:left;border-bottom:1px solid #e2e8f0;vertical-align:middle}
    tbody tr:nth-child(even){background:var(--light-bg)}
    tbody tr:hover{background:#e0e7ff}
    tbody tr.highlight-pending{background:#fef3c7!important;border-left:4px solid var(--warning-color)}
    tbody tr.highlight-falta{background:#fee2e2!important;border-left:4px solid var(--danger-color)}
    tbody tr.has-debt{border-left:4px solid var(--danger-color)!important}
    .action-buttons{display:flex;gap:5px;align-items:center}
    .status-span{display:inline-block;width:100%;font-weight:bold;color:#fff;padding:8px;border-radius:5px;text-align:center}
    .status-span.pagado{background:var(--success-color)}
    .status-span.pendiente{background:var(--warning-color)}
    .status-span.falta-de-pago{background:var(--danger-color)}
    .status-span.terminado{background:var(--finished-color)}
    .status-span.pago-parcial{background:var(--info-color)}
    .status-span.ejecuci√≥n-de-honorarios{background:#8e44ad;color:#fff!important}
    .editable{cursor:pointer;position:relative}
    .editable:hover::after{content:'‚úèÔ∏è';position:absolute;right:5px;top:50%;transform:translateY(-50%);font-size:.9em;opacity:.7}
    .obs-btn{background:var(--info-color);color:#fff;border:none;padding:4px 8px;border-radius:5px;cursor:pointer;font-size:0.8em}
    .obs-btn:hover{opacity:0.8}
    .debt-indicator{color:var(--danger-color);font-size:0.8em;display:block;margin-top:5px}
    .partial-payment-info{color:var(--info-color);font-size:0.8em;display:block;margin-top:5px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center;padding:20px}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:14px;padding:30px;width:90%;max-width:500px;position:relative;max-height:90vh;overflow-y:auto}
    .modal-content h2{margin-bottom:20px;color:var(--secondary-color)}
    .modal-form .form-group{margin-bottom:15px}
    .modal-form input,.modal-form select,.modal-form textarea{width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:.9em}
    .modal-form .form-actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}
    .close-btn{position:absolute;top:15px;right:15px;background:none;border:none;font-size:24px;cursor:pointer;color:#64748b}
    .obs-modal-content{max-width:400px}
    .obs-modal-content .obs-text{background:var(--light-bg);padding:15px;border-radius:8px;margin:15px 0;white-space:pre-wrap}
    .receipt-preview{background:#fff;padding:0;border:1px solid #e2e8f0;border-radius:10px;margin:20px 0;box-shadow:0 5px 15px rgba(0,0,0,.1);overflow:hidden}
    .receipt-header{background:linear-gradient(135deg,var(--secondary-color),var(--primary-color));color:#fff;text-align:center;padding:30px}
    .receipt-header h1{font-size:1.8em;margin-bottom:10px;font-weight:300;letter-spacing:2px}
    .receipt-header .company-name{font-size:1.3em;font-weight:600;margin-bottom:15px}
    .receipt-header .receipt-info{display:flex;justify-content:space-between;margin-top:20px;font-size:.9em}
    .receipt-body{padding:30px;background:#fafbfc}
    .receipt-detail{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0}
    .receipt-detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9}
    .receipt-detail-row:last-child{border-bottom:none}
    .receipt-detail-label{font-weight:600;color:var(--secondary-color)}
    .receipt-total{background:var(--primary-color);color:#fff;padding:20px;border-radius:8px;text-align:center;margin:20px 0}
    .receipt-total .amount{font-size:2em;font-weight:700}
    .receipt-footer{padding:30px;display:flex;justify-content:space-between;background:#fff;border-top:2px solid #e2e8f0}
    .signature-container{text-align:center;flex:1}
    .signature-container img{max-width:150px;height:60px;object-fit:contain;margin-bottom:10px}
    .signature-line{border-top:2px solid #1e293b;width:200px;margin:10px auto}
    .signature-config{margin-top:20px;padding:20px;background:var(--light-bg);border-radius:10px}
    .signature-preview{margin-top:10px;padding:20px;background:#fff;border:2px dashed #e2e8f0;border-radius:8px;text-align:center}
    .signature-preview img{max-width:200px;height:80px;object-fit:contain}
    .month-navigation{display:flex;align-items:center;gap:10px}
    .month-nav-btn{background:var(--primary-color);color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:1.2em;transition:.2s}
    .month-nav-btn:hover{background:var(--secondary-color)}
    .month-display{font-weight:600;color:var(--secondary-color);font-size:1.1em;min-width:150px;text-align:center}
    .back-to-portal{position:fixed;top:20px;left:20px;background:var(--secondary-color);color:#fff;padding:10px 20px;border-radius:8px;text-decoration:none;font-weight:600;display:flex;align-items:center;gap:8px;z-index:100;transition:.3s}
    .back-to-portal:hover{background:var(--primary-color);transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.2)}
    @media print{
      body,.container,.main-content{visibility:hidden;padding:0;margin:0}
      .print-area,.print-area *{visibility:visible}
      .print-area{position:absolute;left:0;top:0;width:100%}
      .no-print{display:none!important}
      .receipt-preview{visibility:visible!important;position:absolute;left:0;top:0;width:100%;border:none;box-shadow:none;margin:0}
      .back-to-portal{display:none!important}
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-to-portal no-print">‚Üê Volver al Portal</a>
  
  <div class="container">
    <div class="header">
      <h1>üíº Control de Abonos Mensuales</h1>
      <p>Estudio Garc√≠a y Asociados - Sistema de Gesti√≥n</p>
    </div>

    <div class="main-content">
      <div id="driveStatus" class="data-status" style="display:none;"></div>

      <div id="alertBanner" class="alert-banner">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-text">
          <strong>Atenci√≥n:</strong> Hay <span id="alertCount">0</span> clientes con pagos pendientes o en falta de pago este mes.
        </div>
        <button id="btnVerPendientes" class="btn btn-danger">Ver Pendientes</button>
      </div>

      <div class="dashboard">
        <div class="card success-card">
          <div class="title-container">
            <h3>Total de Ingresos Brutos</h3>
            <button class="toggle-visibility" id="toggleAmountBtn" title="Ocultar/Mostrar montos">
              <span id="toggleIcon">üëÅÔ∏è</span>
            </button>
          </div>
          <div class="value positive" id="totalIngresosBrutos">$0.00</div>
        </div>
        <div class="card">
          <h3>Honorarios Cobrados</h3>
          <div class="value positive" id="totalCobrado">$0.00</div>
        </div>
        <div class="card">
          <h3>Bonos y AP Cobrados</h3>
          <div class="value" id="totalBonosCobrados" style="color: var(--info-color);">$0.00</div>
        </div>
        <div class="card warning-card">
          <h3>$ Pendientes</h3>
          <div class="value" id="totalPendientes" style="color:var(--warning-color);">$0.00</div>
        </div>
        <div class="card danger-card">
          <h3>$ Falta de Pago</h3>
          <div class="value" id="totalFaltaPago" style="color:var(--danger-color);">$0.00</div>
        </div>
         <div class="card"><h3>Total Registros</h3><div class="value" id="totalRegistros">0</div></div>
      </div>

      <div class="controls no-print">
        <div class="form-group">
          <label>Mes Seleccionado:</label>
          <div class="month-navigation">
            <button id="btnPrevMonth" class="month-nav-btn">‚óÄ</button>
            <div class="month-display" id="monthDisplay"></div>
            <button id="btnNextMonth" class="month-nav-btn">‚ñ∂</button>
          </div>
        </div>
        <div>
          <button class="btn btn-success" id="add-record-btn">‚ûï Agregar Registro</button>
          <button class="btn btn-info" id="carry-btn">üìã Arrastrar Clientes</button>
          <button class="btn" style="background:#8e44ad;" id="print-btn">üñ®Ô∏è Imprimir</button>
          <button class="btn" id="export-btn">üìä Exportar Excel</button>
          <button class="btn" id="export-json-btn">üíæ Exportar JSON</button>
          <button class="btn btn-warning" id="import-json-btn">üì• Importar JSON</button>
          <button class="btn btn-warning" id="config-btn">‚öôÔ∏è Config</button>
        </div>
      </div>

      <section style="text-align:center;margin-bottom:30px;border-top:1px solid #ddd;padding-top:20px;">
        <button id="connectDriveBtn" class="btn btn-drive" onclick="handleAuthClick()">üîó Conectar a Drive</button>
        <button id="saveToDriveBtn" class="btn btn-success" style="display:none;" onclick="saveDataToDrive()">üì§ Guardar en Drive</button>
        <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;" onclick="loadDataFromDrive()">üì• Cargar de Drive</button>
      </section>

      <div class="filters-container no-print">
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="üîç Buscar cliente por nombre...">
        </div>
        <h4 style="margin-bottom:15px;color:var(--secondary-color);">Filtrar por Estado:</h4>
        <div class="filter-buttons" id="filtersBar">
          <button class="filter-btn active" data-status="todos">Todos (<span id="countTodos">0</span>)</button>
          <button class="filter-btn filter-pendiente" data-status="pendiente">‚è≥ Pendiente (<span id="countPendiente">0</span>)</button>
          <button class="filter-btn filter-falta" data-status="falta-de-pago">‚ùå Falta de Pago (<span id="countFalta">0</span>)</button>
          <button class="filter-btn filter-pagado" data-status="pagado">‚úÖ Pagado (<span id="countPagado">0</span>)</button>
          <button class="filter-btn" data-status="pago-parcial">üí∞ Pago Parcial (<span id="countPagoParcial">0</span>)</button>
          <button class="filter-btn" data-status="ejecuci√≥n-de-honorarios">‚öñÔ∏è Ejecuci√≥n de Honorarios (<span id="countEjecucion">0</span>)</button>
          <button class="filter-btn" data-status="terminado">üèÅ Terminado (<span id="countTerminado">0</span>)</button>
          <button class="filter-btn" data-status="pendientes">üö® Todos los Pendientes (<span id="countAllPendientes">0</span>)</button>
          <button class="filter-btn filter-terminado-global" data-status="todos-terminados">üåê Todos los Terminados (<span id="countTodosTerminados">0</span>)</button>
        </div>
        <div id="filterInfo" class="filter-info"></div>
      </div>

      <div id="print-area" class="print-area">
        <h2 id="table-title" style="display:none;text-align:center;margin-bottom:20px;"></h2>
        <div style="overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Cliente</th><th>Tipo</th><th>Monto Abono</th><th>Fecha de Pago</th><th>Forma de Pago</th><th>Estado</th><th class="no-print">Acciones</th>
              </tr>
            </thead>
            <tbody id="abonosTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="importInput" accept=".json" style="display:none">

  <div id="abonoModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="abonoModalClose">‚úñ</button>
      <h2 id="modalTitle">Agregar Nuevo Registro</h2>
      <form id="abonoForm" class="modal-form">
        <div class="form-group"><label>Cliente</label><input type="text" id="cliente" required></div>
        <div class="form-group"><label>Tipo</label><select id="tipo"></select></div>
        <div class="form-group"><label>Monto</label><input type="number" id="monto" required step="0.01"></div>
        <div class="form-group"><label>Fecha de Pago</label><input type="date" id="fechaPago"></div>
        <div class="form-group"><label>Forma de Pago</label><input type="text" id="formaPago"></div>
        <div class="form-group"><label>Estado</label><select id="estado"></select></div>
        <div id="pagoMontoParcialDiv" class="form-group" style="display:none;">
          <label>Monto Pagado Parcialmente</label>
          <input type="number" id="montoPagadoParcial" step="0.01" placeholder="Ingrese el monto pagado">
        </div>
        <div class="form-group"><label>Observaciones</label><textarea id="observaciones" placeholder="Notas adicionales sobre este registro..."></textarea></div>
        <div class="form-actions">
          <button type="button" class="btn" id="abonoModalCancel" style="background-color:#94a3b8;">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="obsModal" class="modal">
    <div class="modal-content obs-modal-content">
      <button class="close-btn" id="obsModalClose">‚úñ</button>
      <h2>üìù Observaciones</h2>
      <h4 id="obsClientName" style="color:var(--primary-color);margin-bottom:10px;"></h4>
      <div id="obsContent" class="obs-text"></div>
      <form id="obsForm" style="display:none;">
        <div class="form-group">
          <textarea id="obsTextarea" placeholder="Escriba las observaciones aqu√≠..." style="min-height:120px;"></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" id="obsSaveBtn" style="background:var(--success-color);">Guardar</button>
          <button type="button" class="btn" id="obsCancelBtn" style="background:#94a3b8;">Cancelar</button>
        </div>
      </form>
      <button id="obsEditBtn" class="btn btn-info" style="margin-top:10px;">‚úèÔ∏è Editar</button>
    </div>
  </div>

  <div id="receiptModal" class="modal">
    <div class="modal-content" style="max-width:700px;">
      <button class="close-btn" id="receiptClose">‚úñ</button>
      <div id="receiptContent" class="receipt-preview"></div>
      <div class="form-actions">
        <button type="button" class="btn" id="printReceiptBtn">üñ®Ô∏è Imprimir Recibo</button>
        <button type="button" class="btn" id="receiptCancel" style="background-color:#94a3b8;">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="configModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" id="configClose">‚úñ</button>
      <h2>‚öôÔ∏è Configuraci√≥n</h2>
      <div class="signature-config">
        <h3>Firma para Recibos</h3>
        <div class="form-group">
          <label>Cargar imagen de firma (PNG, JPG)</label>
          <input type="file" id="signatureFile" accept="image/*">
        </div>
        <div class="signature-preview">
          <div id="signaturePreview"><p style="color:#94a3b8;">No hay firma cargada</p></div>
        </div>
        <button class="btn" id="removeSignatureBtn" style="background-color:var(--danger-color);margin-top:10px;">üóëÔ∏è Eliminar Firma</button>
      </div>
    </div>
  </div>

  <script>
    // ====== ESTADO APP ======
    let abonosData = [];
    let currentMonth;
    let signatureImage = null;
    let currentFilter = 'todos';
    let currentSearchTerm = '';
    let isAmountHidden = false;
    let realAmounts = { cobrado: 0, pendientes: 0, falta: 0, bonos: 0, bruto: 0 };
    let currentObsId = null;
    const TIPO_OPTIONS = ['Abono Mensual','Honorarios Siniestro','Regulaci√≥n Honorarios','Pago de Bonos y AP'];
    const ESTADO_OPTIONS = ['Pendiente','Pagado','Falta de Pago','Pago Parcial','Ejecuci√≥n de Honorarios','Terminado'];
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];

    // ====== INIT ======
    document.addEventListener('DOMContentLoaded', function() {
      // Botones principales
      document.getElementById('toggleAmountBtn').addEventListener('click', toggleAmountVisibility);
      document.getElementById('btnPrevMonth').addEventListener('click', function(){ changeMonth(-1); });
      document.getElementById('btnNextMonth').addEventListener('click', function(){ changeMonth(1); });
      document.getElementById('add-record-btn').addEventListener('click', openModal);
      document.getElementById('carry-btn').addEventListener('click', carryOverClients);
      document.getElementById('print-btn').addEventListener('click', printTable);
      document.getElementById('export-btn').addEventListener('click', exportToExcel);
      document.getElementById('export-json-btn').addEventListener('click', exportData);
      document.getElementById('import-json-btn').addEventListener('click', function(){ document.getElementById('importInput').click(); });
      document.getElementById('config-btn').addEventListener('click', openConfigModal);
      document.getElementById('btnVerPendientes').addEventListener('click', function(){ filterByStatus('pendientes'); });

      document.getElementById('importInput').addEventListener('change', handleImport);
      
      // Buscador
      document.getElementById('searchInput').addEventListener('input', function(e) {
          currentSearchTerm = e.target.value;
          render();
      });

      // Filtros delegaci√≥n
      document.getElementById('filtersBar').addEventListener('click', function(e){
        var btn = e.target.closest('.filter-btn');
        if(!btn){ return; }
        document.querySelectorAll('.filter-btn').forEach(function(b){ b.classList.remove('active'); });
        btn.classList.add('active');
        filterByStatus(btn.getAttribute('data-status'));
      });

      // Tabla delegaci√≥n
      document.getElementById('abonosTableBody').addEventListener('click', function(event){
        var target = event.target;
        if(target.classList.contains('delete-btn')) {
          deleteAbono(target.getAttribute('data-id'));
        } else if(target.classList.contains('receipt-btn')) {
          generateReceipt(target.getAttribute('data-id'));
        } else if(target.classList.contains('obs-btn')) {
          showObservations(target.getAttribute('data-id'));
        } else {
          var cell = target.closest('.editable');
          if(cell){ handleCellEdit(cell); }
        }
      });

      // Modal Abono
      document.getElementById('abonoModalClose').addEventListener('click', closeModal);
      document.getElementById('abonoModalCancel').addEventListener('click', closeModal);
      document.getElementById('abonoModal').addEventListener('click', function(e){ if(e.target.id === 'abonoModal'){ closeModal(); } });
      document.getElementById('abonoForm').addEventListener('submit', handleFormSubmit);
      
      document.getElementById('estado').addEventListener('change', function() {
        var div = document.getElementById('pagoMontoParcialDiv');
        div.style.display = (this.value === 'Pago Parcial') ? 'block' : 'none';
      });

      // Modal Observaciones
      document.getElementById('obsModalClose').addEventListener('click', closeObsModal);
      document.getElementById('obsEditBtn').addEventListener('click', editObservations);
      document.getElementById('obsSaveBtn').addEventListener('click', saveObservations);
      document.getElementById('obsCancelBtn').addEventListener('click', cancelObsEdit);

      // Modal Recibo
      document.getElementById('receiptClose').addEventListener('click', function(){ document.getElementById('receiptModal').classList.remove('active'); });
      document.getElementById('receiptCancel').addEventListener('click', function(){ document.getElementById('receiptModal').classList.remove('active'); });
      document.getElementById('printReceiptBtn').addEventListener('click', printReceipt);

      // Modal Config
      document.getElementById('configClose').addEventListener('click', closeConfigModal);
      document.getElementById('removeSignatureBtn').addEventListener('click', removeSignature);
      document.getElementById('signatureFile').addEventListener('change', handleSignatureUpload);

      // Datos
      loadData();
      loadSignature();
      initializeMonth();
      setupModal();
      render();
    });

    // ====== UTIL DATOS ======
    function saveData(){ localStorage.setItem('abonosData', JSON.stringify(abonosData)); }
    function loadData(){ var s = localStorage.getItem('abonosData'); abonosData = s ? JSON.parse(s) : []; }

    function saveSignature(){ if(signatureImage){ localStorage.setItem('signatureImage', signatureImage); } else { localStorage.removeItem('signatureImage'); } }
    function loadSignature(){ signatureImage = localStorage.getItem('signatureImage'); updateSignaturePreview(); }
    function updateSignaturePreview(){
      var el = document.getElementById('signaturePreview');
      if(signatureImage){ el.innerHTML = '<img src="'+signatureImage+'" alt="Firma">'; }
      else { el.innerHTML = '<p style="color:#94a3b8;">No hay firma cargada</p>'; }
    }

    function getAbonosForMonth(month, year){
      return abonosData.filter(function(a){
        if (a.mesServicio) {
          return a.mesServicio.month === month && a.mesServicio.year === year;
        }
        else if (a.fechaPago) {
          var d = new Date(a.fechaPago + 'T00:00:00');
          return d.getMonth() === month && d.getFullYear() === year;
        }
        return false;
      });
    }

    function addAbono(newAbono){ 
      newAbono.id='abono_'+Date.now(); 
      if(!newAbono.deudaAcumulada) newAbono.deudaAcumulada = 0;
      abonosData.push(newAbono); 
      saveData(); 
      render(); 
    }
    
    function updateAbono(id, updatedData){
      var idx = abonosData.findIndex(function(a){ return a.id===id; });
      if(idx !== -1){ 
        abonosData[idx] = Object.assign({}, abonosData[idx], updatedData); 
        saveData(); 
        render(); 
      }
    }
    
    function deleteAbono(id){
      if(confirm('¬øEliminar este registro?')){
        abonosData = abonosData.filter(function(a){ return a.id !== id; });
        saveData(); render();
      }
    }

    // ====== OBSERVACIONES ======
    function showObservations(id){
      currentObsId = id;
      var abono = abonosData.find(function(a){ return a.id === id; });
      if(!abono) return;
      
      document.getElementById('obsClientName').textContent = abono.cliente || 'Sin nombre';
      document.getElementById('obsContent').textContent = abono.observaciones || 'Sin observaciones';
      document.getElementById('obsContent').style.display = 'block';
      document.getElementById('obsForm').style.display = 'none';
      document.getElementById('obsEditBtn').style.display = 'block';
      document.getElementById('obsModal').classList.add('active');
    }

    function editObservations(){
      var abono = abonosData.find(function(a){ return a.id === currentObsId; });
      if(!abono) return;
      
      document.getElementById('obsTextarea').value = abono.observaciones || '';
      document.getElementById('obsContent').style.display = 'none';
      document.getElementById('obsForm').style.display = 'block';
      document.getElementById('obsEditBtn').style.display = 'none';
      document.getElementById('obsTextarea').focus();
    }

    function saveObservations(){
      var newObs = document.getElementById('obsTextarea').value;
      updateAbono(currentObsId, {observaciones: newObs});
      closeObsModal();
    }

    function cancelObsEdit(){
      document.getElementById('obsContent').style.display = 'block';
      document.getElementById('obsForm').style.display = 'none';
      document.getElementById('obsEditBtn').style.display = 'block';
    }

    function closeObsModal(){
      document.getElementById('obsModal').classList.remove('active');
      currentObsId = null;
    }

    // ====== FILTROS ======
    function filterByStatus(status){
      currentFilter = status;
      var info = document.getElementById('filterInfo');
      var monthControls = document.querySelector('.month-navigation');
      
      if(status === 'todos-terminados'){
          monthControls.style.opacity = '0.5';
          monthControls.style.pointerEvents = 'none';
          document.getElementById('monthDisplay').textContent = "Todos los Meses";
      } else {
          monthControls.style.opacity = '1';
          monthControls.style.pointerEvents = 'auto';
          updateMonthDisplay();
      }

      if(status === 'todos'){ info.style.display='none'; }
      else {
        info.style.display='block';
        var m = {
          'pendiente':'Mostrando solo registros pendientes',
          'falta-de-pago':'Mostrando solo registros con falta de pago',
          'pagado':'Mostrando solo registros pagados',
          'pago-parcial':'Mostrando solo registros con pago parcial',
          'ejecuci√≥n-de-honorarios':'Mostrando solo registros en ejecuci√≥n de honorarios',
          'terminado':'Mostrando solo registros terminados de este mes',
          'pendientes':'Mostrando todos los registros con deuda (Pendiente, Falta de Pago, Ejecuci√≥n)',
          'todos-terminados': 'Mostrando todos los registros terminados de todos los meses.'
        };
        info.textContent = m[status] || '';
      }
      render();
    }
    
    function getFilteredAbonos(abonos){
      if(currentFilter === 'todos-terminados') {
          return abonos.filter(function(a) { return a.estado === 'Terminado'; });
      }
      if(currentFilter === 'todos') return abonos;
      if(currentFilter === 'pendientes') return abonos.filter(function(a){ 
        return a.estado==='Pendiente'||a.estado==='Falta de Pago'||a.estado==='Ejecuci√≥n de Honorarios'; 
      });
      return abonos.filter(function(a){
        var estado = (a.estado||'').toLowerCase().replace(/ /g,'-');
        return estado === currentFilter;
      });
    }

    // ====== FUNCIONES AUXILIARES PARA C√ÅLCULO DE DEUDA ======
    function calcularDeudaCliente(cliente, abonos) {
      var deudaTotal = 0;
      var abonoMensual = 0;
      
      abonos.forEach(function(record) {
        if (record.cliente === cliente) {
          var montoBase = parseFloat(record.montoBase || record.monto) || 0;
          var deudaPrevia = parseFloat(record.deudaAcumulada) || 0;
          
          if (record.tipo === 'Abono Mensual') { abonoMensual = montoBase; }
          
          if (record.estado === 'Pendiente' || record.estado === 'Falta de Pago' || record.estado === 'Ejecuci√≥n de Honorarios') {
            if (record.tipo !== 'Regulaci√≥n Honorarios' || record.estado !== 'Falta de Pago') {
              deudaTotal += montoBase + deudaPrevia;
            }
          } else if (record.estado === 'Pago Parcial') {
            if (record.tipo !== 'Regulaci√≥n Honorarios') {
              var montoTotalRecord = montoBase + deudaPrevia;
              var montoPagado = parseFloat(record.montoPagado) || 0;
              var deudaRestante = montoTotalRecord - montoPagado;
              if (deudaRestante > 0) { deudaTotal += deudaRestante; }
            }
          }
        }
      });
      return { deudaTotal: deudaTotal, abonoMensual: abonoMensual };
    }

    // ====== ARRASTRE CLIENTES ======
    function carryOverClients(){
      var curr = getAbonosForMonth(currentMonth.month, currentMonth.year);
      if(curr.length===0){ alert('No hay clientes en el mes actual para arrastrar.'); return; }
      
      var nm = currentMonth.month + 1, ny=currentMonth.year;
      if(nm>11){ nm=0; ny++; }
      
      var unique = Array.from(new Set(curr.map(function(a){ return a.cliente; })));
      var next = getAbonosForMonth(nm, ny);
      var existing = new Set(next.map(function(a){ return a.cliente; }));
      var added=0;

      unique.forEach(function(cliente){
        if(!existing.has(cliente)){
          var clienteRecords = curr.filter(function(a){ return a.cliente===cliente; });
          var lastRecord = clienteRecords.sort(function(a,b){ return new Date(b.fechaPago)-new Date(a.fechaPago); })[0];
          
          if (lastRecord.estado === 'Terminado') {
            return;
          }
          
          var dateStr = ny+'-'+String(nm+1).padStart(2,'0')+'-01';
          var observaciones = lastRecord.observaciones || '';
          var registrosAgregados = 0;
          var mesServicioNuevo = { month: nm, year: ny };
          
          var abonosmensuales = clienteRecords.filter(function(r){ return r.tipo === 'Abono Mensual'; });
          if (abonosmensuales.length > 0) {
            var calculoDeuda = calcularDeudaCliente(cliente, abonosmensuales);
            var deudaTotal = calculoDeuda.deudaTotal;
            var abonoMensual = calculoDeuda.abonoMensual;
            
            if (deudaTotal > 0) {
              var montoTotal = abonoMensual + deudaTotal;
              var obsAbono = 'Deuda acumulada: ' + formatCurrency(deudaTotal) + ' + Abono: ' + formatCurrency(abonoMensual);
              addAbono({ cliente: cliente, tipo: 'Abono Mensual', monto: montoTotal, montoBase: abonoMensual, deudaAcumulada: deudaTotal, fechaPago: '', estado: 'Pendiente', observaciones: obsAbono, mesServicio: mesServicioNuevo });
            } else {
              addAbono({ cliente: cliente, tipo: 'Abono Mensual', monto: abonoMensual, montoBase: abonoMensual, deudaAcumulada: 0, fechaPago: '', estado: 'Pendiente', observaciones: observaciones, mesServicio: mesServicioNuevo });
            }
            registrosAgregados++;
          }
          
          var regulaciones = clienteRecords.filter(function(r){ return r.tipo === 'Regulaci√≥n Honorarios'; });
          regulaciones.forEach(function(record) {
            var montoRestante = 0, observacionRegulacion = '';
            if (record.estado === 'Pago Parcial') {
              montoRestante = (parseFloat(record.monto) || 0) - (parseFloat(record.montoPagado) || 0);
              observacionRegulacion = 'Saldo pendiente de regulaci√≥n anterior: ' + formatCurrency(montoRestante);
            } else if (['Pendiente', 'Ejecuci√≥n de Honorarios', 'Falta de Pago'].includes(record.estado)) {
              montoRestante = parseFloat(record.monto) || 0;
              observacionRegulacion = 'Regulaci√≥n de honorarios pendiente: ' + formatCurrency(montoRestante);
            }
            if (montoRestante > 0) {
              addAbono({ cliente: cliente, tipo: 'Regulaci√≥n Honorarios', monto: montoRestante, montoBase: montoRestante, deudaAcumulada: 0, fechaPago: '', estado: 'Pendiente', observaciones: observacionRegulacion, mesServicio: mesServicioNuevo });
              registrosAgregados++;
            }
          });
          if (registrosAgregados > 0) { added++; }
        }
      });

      if(added>0){
        alert('Se arrastraron '+added+' clientes a '+MONTHS[nm]+' '+ny+'. Cambiando al mes siguiente...');
        currentMonth = { month:nm, year:ny }; updateMonthDisplay(); render();
      } else {
        alert('Todos los clientes ya existen en el pr√≥ximo mes o estaban terminados.');
      }
    }

    // ====== MES ======
    function initializeMonth(){ var t=new Date(); currentMonth = { month:t.getMonth(), year:t.getFullYear() }; updateMonthDisplay(); }
    function changeMonth(dir){
      currentMonth.month += dir;
      if(currentMonth.month>11){ currentMonth.month=0; currentMonth.year++; }
      else if(currentMonth.month<0){ currentMonth.month=11; currentMonth.year--; }
      updateMonthDisplay(); render();
    }
    function updateMonthDisplay(){ document.getElementById('monthDisplay').textContent = MONTHS[currentMonth.month]+' '+currentMonth.year; }

    // ====== FIRMA ======
    function handleSignatureUpload(event){
      var file = event.target.files[0];
      if(file && file.type.startsWith('image/')){
        var reader = new FileReader();
        reader.onload = function(e){ signatureImage = e.target.result; saveSignature(); updateSignaturePreview(); };
        reader.readAsDataURL(file);
      }
    }
    function removeSignature(){
      if(confirm('¬øEst√° seguro de eliminar la firma?')){
        signatureImage = null; saveSignature(); updateSignaturePreview(); document.getElementById('signatureFile').value='';
      }
    }

    // ====== RENDER ======
    function formatCurrency(v){ 
      return new Intl.NumberFormat('es-AR',{
        style:'currency',
        currency:'ARS',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(v||0).replace(/,/g, '.'); 
    }
    
    function toggleAmountVisibility(){
      isAmountHidden = !isAmountHidden;
      var toggleIcon = document.getElementById('toggleIcon');
      var cards = [
        { el: document.getElementById('totalIngresosBrutos'), value: realAmounts.bruto },
        { el: document.getElementById('totalCobrado'),   value: realAmounts.cobrado },
        { el: document.getElementById('totalBonosCobrados'), value: realAmounts.bonos },
        { el: document.getElementById('totalPendientes'), value: realAmounts.pendientes },
        { el: document.getElementById('totalFaltaPago'),  value: realAmounts.falta }
      ];

      toggleIcon.textContent = isAmountHidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è';

      cards.forEach(card => {
        if(card.el) {
            if (isAmountHidden) {
                card.el.textContent = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                card.el.classList.add('hidden-value');
            } else {
                card.el.textContent = formatCurrency(card.value);
                card.el.classList.remove('hidden-value');
            }
        }
      });
    }

    function render(){
      let sourceData;
      if (currentFilter === 'todos-terminados') {
        sourceData = abonosData.filter(a => a.estado === 'Terminado');
      } else {
        sourceData = getAbonosForMonth(currentMonth.month, currentMonth.year);
      }
      
      let searchedData = sourceData;
      if (currentSearchTerm) {
          searchedData = sourceData.filter(function(a) {
              return (a.cliente || '').toLowerCase().includes(currentSearchTerm.toLowerCase());
          });
      }

      var filtered = getFilteredAbonos(searchedData);
      renderTable(filtered);
      
      var abonosMes = getAbonosForMonth(currentMonth.month, currentMonth.year);
      renderDashboard(abonosMes);
      updateFilterCounts(abonosMes);
      updateAlertBanner(abonosMes);
    }
    
    function renderDashboard(abonos){
      var honorariosCobrados = abonos.filter(function(a){ 
        return (a.estado==='Pagado' || a.estado === 'Terminado') && a.tipo !== 'Pago de Bonos y AP'; 
      }).reduce(function(s,a){ return s+Number(a.monto||0); },0);
      honorariosCobrados += abonos.filter(function(a){ 
        return a.estado==='Pago Parcial' && a.tipo !== 'Pago de Bonos y AP'; 
      }).reduce(function(s,a){ return s+Number(a.montoPagado||0); },0);

      var bonosCobrados = abonos.filter(function(a){ 
        return a.tipo === 'Pago de Bonos y AP' && (a.estado === 'Pagado' || a.estado === 'Terminado');
      }).reduce(function(s, a){ return s + Number(a.monto || 0); }, 0);
      bonosCobrados += abonos.filter(function(a){ 
        return a.tipo === 'Pago de Bonos y AP' && a.estado === 'Pago Parcial';
      }).reduce(function(s, a){ return s + Number(a.montoPagado || 0); }, 0);
      
      var totalIngresosBrutos = honorariosCobrados + bonosCobrados;

      var totalPendientes = abonos.filter(function(a){ return a.estado==='Pendiente'; }).reduce((sum, a) => sum + Number(a.monto || 0), 0);
      var totalFaltaPago = abonos.filter(function(a){ return a.estado==='Falta de Pago'; }).reduce((sum, a) => sum + Number(a.monto || 0), 0);

      realAmounts = {
        cobrado: honorariosCobrados,
        pendientes: totalPendientes,
        falta: totalFaltaPago,
        bonos: bonosCobrados,
        bruto: totalIngresosBrutos
      };

      document.getElementById('totalRegistros').textContent = abonos.length;

      toggleAmountVisibility();
      toggleAmountVisibility(); 
    }

    function updateFilterCounts(abonos){
      var counts = {
        todos: abonos.length,
        pendiente: abonos.filter(function(a){ return a.estado==='Pendiente'; }).length,
        'falta-de-pago': abonos.filter(function(a){ return a.estado==='Falta de Pago'; }).length,
        pagado: abonos.filter(function(a){ return a.estado==='Pagado'; }).length,
        'pago-parcial': abonos.filter(function(a){ return a.estado==='Pago Parcial'; }).length,
        'ejecuci√≥n-de-honorarios': abonos.filter(function(a){ return a.estado==='Ejecuci√≥n de Honorarios'; }).length,
        terminado: abonos.filter(function(a){ return a.estado==='Terminado'; }).length,
        pendientes: abonos.filter(function(a){ 
          return a.estado==='Pendiente'||a.estado==='Falta de Pago'||a.estado==='Ejecuci√≥n de Honorarios'; 
        }).length,
        'todos-terminados': abonosData.filter(function(a){ return a.estado==='Terminado'; }).length
      };
      document.getElementById('countTodos').textContent = counts.todos;
      document.getElementById('countPendiente').textContent = counts.pendiente;
      document.getElementById('countFalta').textContent = counts['falta-de-pago'];
      document.getElementById('countPagado').textContent = counts.pagado;
      document.getElementById('countPagoParcial').textContent = counts['pago-parcial'];
      document.getElementById('countEjecucion').textContent = counts['ejecuci√≥n-de-honorarios'];
      document.getElementById('countTerminado').textContent = counts.terminado;
      document.getElementById('countAllPendientes').textContent = counts.pendientes;
      document.getElementById('countTodosTerminados').textContent = counts['todos-terminados'];
    }

    function updateAlertBanner(abonos){
      var n = abonos.filter(function(a){ return a.estado==='Pendiente'||a.estado==='Falta de Pago'; }).length;
      var banner = document.getElementById('alertBanner');
      if(n>0){ banner.classList.add('show'); document.getElementById('alertCount').textContent = n; }
      else { banner.classList.remove('show'); }
    }

    function renderTable(abonos){
      var body = document.getElementById('abonosTableBody');
      body.innerHTML = '';
      if(abonos.length===0){
        var msg = currentFilter==='todos' ? 'No hay registros para este mes.' : 'No hay registros que coincidan con los filtros seleccionados.';
        if (currentSearchTerm) msg = 'No se encontraron clientes con ese nombre.'
        body.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:30px;color:#94a3b8;">'+msg+'</td></tr>';
        return;
      }
      abonos.forEach(function(abono){
        var tr = document.createElement('tr');
        var isPayable = abono.estado==='Pagado' || abono.estado === 'Pago Parcial' || abono.estado === 'Terminado';
        var estadoClass = (abono.estado||'').toLowerCase().replace(/ /g,'-') || 'pendiente';
        if(abono.estado==='Pendiente'){ tr.classList.add('highlight-pending'); }
        else if(abono.estado==='Falta de Pago'){ tr.classList.add('highlight-falta'); }
        if(abono.deudaAcumulada && abono.deudaAcumulada > 0){ tr.classList.add('has-debt'); }

        var montoDisplay = formatCurrency(abono.monto);
        var additionalInfo = '';
        
        if(abono.deudaAcumulada && abono.deudaAcumulada > 0){
          additionalInfo += '<span class="debt-indicator">(Incluye deuda: '+formatCurrency(abono.deudaAcumulada)+')</span>';
        }
        
        if(abono.estado === 'Pago Parcial' && abono.montoPagado){
          var montoRestante = parseFloat(abono.monto) - parseFloat(abono.montoPagado);
          additionalInfo += '<span class="partial-payment-info">(Pagado: '+formatCurrency(abono.montoPagado)+' - Resta: '+formatCurrency(montoRestante)+')</span>';
        }
        
        montoDisplay += additionalInfo;

        tr.innerHTML =
          '<td class="editable" data-id="'+abono.id+'" data-field="cliente" data-type="text">'+(abono.cliente||'')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="tipo" data-type="select" data-options=\''+JSON.stringify(TIPO_OPTIONS)+'\'>'+(abono.tipo||'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="monto" data-type="number">'+montoDisplay+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="fechaPago" data-type="date">'+(abono.fechaPago?new Date(abono.fechaPago+'T00:00:00').toLocaleDateString('es-AR'):'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="formaPago" data-type="text">'+(abono.formaPago||'N/A')+'</td>'+
          '<td class="editable" data-id="'+abono.id+'" data-field="estado" data-type="select" data-options=\''+JSON.stringify(ESTADO_OPTIONS)+'\'><span class="status-span '+estadoClass+'">'+(abono.estado||'')+'</span></td>'+
          '<td class="no-print"><div class="action-buttons">'+
            '<button class="btn btn-small btn-info obs-btn" data-id="'+abono.id+'" title="Ver observaciones">üìù</button>'+
            '<button class="btn btn-small btn-success receipt-btn" data-id="'+abono.id+'" '+(isPayable ? '':'disabled')+'>üßæ</button>'+
            '<button class="btn btn-small delete-btn" style="background-color:var(--danger-color);" data-id="'+abono.id+'">üóëÔ∏è</button>'+
          '</div></td>';
        body.appendChild(tr);
      });
    }

    function handleCellEdit(cell){
      if(cell.querySelector('input,select')) return;
      var id = cell.getAttribute('data-id');
      var field = cell.getAttribute('data-field');
      var type = cell.getAttribute('data-type');
      var options = cell.getAttribute('data-options');
      var abono = abonosData.find(function(a){ return a.id===id; });
      if(!abono){ return; }
      var currentValue = abono[field] || '';
      var editor;

      if(type==='select'){
        editor = document.createElement('select');
        JSON.parse(options).forEach(function(opt){
          var o = document.createElement('option');
          o.value = opt; o.textContent = opt;
          if(opt===currentValue){ o.selected = true; }
          editor.appendChild(o);
        });
      } else {
        editor = document.createElement('input');
        editor.type = type;
        if(type==='date' && currentValue){ editor.value = currentValue; }
        else if(type==='number'){ editor.value = parseFloat(currentValue)||''; }
        else { editor.value = currentValue; }
      }

      cell.innerHTML = '';
      cell.appendChild(editor);
      editor.focus();

      var saveChange = function(){
        var newValue = (type==='number') ? (parseFloat(editor.value)||0) : editor.value;
        
        if(field === 'estado' && newValue === 'Pago Parcial'){
          var montoPagado = prompt('Ingrese el monto pagado parcialmente:');
          if(montoPagado && !isNaN(parseFloat(montoPagado))){
            updateAbono(id, {estado: newValue, montoPagado: parseFloat(montoPagado)});
          } else {
            render();
          }
        } else {
          updateAbono(id, (function(o){ o[field]=newValue; return o; })({}));
        }
      };

      editor.addEventListener('blur', saveChange);
      editor.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); editor.blur(); } });
    }

    function setupModal(){
      var tipo = document.getElementById('tipo');
      var estado = document.getElementById('estado');
      tipo.innerHTML=''; estado.innerHTML='';
      TIPO_OPTIONS.forEach(function(opt){ var o=document.createElement('option'); o.value=opt; o.textContent=opt; tipo.appendChild(o); });
      ESTADO_OPTIONS.forEach(function(opt){ var o=document.createElement('option'); o.value=opt; o.textContent=opt; estado.appendChild(o); });
    }

    function openModal(){
      var form = document.getElementById('abonoForm');
      form.reset();
      document.getElementById('fechaPago').value = '';
      document.getElementById('modalTitle').textContent = 'Agregar Nuevo Registro';
      document.getElementById('pagoMontoParcialDiv').style.display = 'none';
      document.getElementById('abonoModal').classList.add('active');
    }
    function closeModal(){ document.getElementById('abonoModal').classList.remove('active'); }

    function openConfigModal(){ document.getElementById('configModal').classList.add('active'); }
    function closeConfigModal(){ document.getElementById('configModal').classList.remove('active'); }

    function handleFormSubmit(e){
      e.preventDefault();
      var data = {
        cliente: document.getElementById('cliente').value,
        tipo: document.getElementById('tipo').value,
        monto: parseFloat(document.getElementById('monto').value),
        fechaPago: document.getElementById('fechaPago').value,
        formaPago: document.getElementById('formaPago').value,
        estado: document.getElementById('estado').value,
        observaciones: document.getElementById('observaciones').value,
        mesServicio: {
          month: currentMonth.month,
          year: currentMonth.year
        }
      };
      
      if(data.estado === 'Pago Parcial') {
        var montoPagado = parseFloat(document.getElementById('montoPagadoParcial').value);
        if(montoPagado && montoPagado > 0) {
          data.montoPagado = montoPagado;
        } else {
          alert('Debe ingresar un monto pagado v√°lido para el pago parcial');
          return;
        }
      }
      
      addAbono(data);
      closeModal();
    }

    function printTable(){
      var ft = (currentFilter==='todos') ? '' : ' ('+currentFilter.replace(/-/g,' ')+')';
      var title = 'Resumen de Abonos - '+ (currentFilter === 'todos-terminados' ? 'Todos los Terminados' : MONTHS[currentMonth.month]+' '+currentMonth.year+ft);
      var h = document.getElementById('table-title');
      h.textContent = title; h.style.display='block';
      window.print();
      setTimeout(function(){ h.style.display='none'; }, 100);
    }

    // ====== RECIBOS ======
    function generateReceipt(abonoId){
      var abono = abonosData.find(function(a){ return a.id===abonoId; });
      if(!abono){ 
        alert('No se encontr√≥ el registro del abono.');
        return; 
      }
      
      if(!['Pagado', 'Pago Parcial', 'Terminado'].includes(abono.estado)){ 
        alert('Solo se pueden generar recibos para pagos completos, parciales o terminados.');
        return; 
      }

      var receiptDate = new Date().toLocaleDateString('es-AR');
      var receiptNumber = String(Date.now()).slice(-8);
      
      var mesServicioTexto = '';
      if (abono.mesServicio) {
        mesServicioTexto = MONTHS[abono.mesServicio.month] + ' ' + abono.mesServicio.year;
      } else if (abono.fechaPago) {
        var d = new Date(abono.fechaPago + 'T00:00:00');
        mesServicioTexto = MONTHS[d.getMonth()] + ' ' + d.getFullYear();
      }

      var montoRecibo, conceptoBase;
      
      if (abono.estado === 'Pago Parcial') {
        montoRecibo = parseFloat(abono.montoPagado) || 0;
        conceptoBase = (abono.tipo || 'Abono Mensual') + ' (Pago Parcial)';
        if (montoRecibo <= 0) { alert('El monto pagado debe ser mayor a cero.'); return; }
      } else {
        montoRecibo = parseFloat(abono.monto) || 0;
        conceptoBase = abono.tipo || 'Abono Mensual';
      }

      var conceptoRecibo = conceptoBase + (mesServicioTexto ? ' - ' + mesServicioTexto : '');

      var parts = [];
      parts.push(
        '<div class="receipt-header">',
          '<div class="company-name">ESTUDIO GARC√çA Y ASOCIADOS</div>',
          '<h1>RECIBO DE PAGO</h1>',
          '<div class="receipt-info">',
            '<div>Fecha: ', receiptDate, '</div>',
            '<div>Recibo N¬∞: ', receiptNumber, '</div>',
          '</div>',
        '</div>',
        '<div class="receipt-body">',
          '<div class="receipt-detail">',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Cliente:</span><span>', (abono.cliente||'Sin nombre'), '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Concepto:</span><span>', conceptoRecibo, '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Fecha de Pago:</span><span>', (abono.fechaPago? new Date(abono.fechaPago+'T00:00:00').toLocaleDateString('es-AR') : 'Sin fecha'), '</span></div>',
            '<div class="receipt-detail-row"><span class="receipt-detail-label">Forma de Pago:</span><span>', (abono.formaPago||'Efectivo'), '</span></div>'
      );
      
      if (abono.estado === 'Pago Parcial') {
        var montoTotal = parseFloat(abono.monto) || 0;
        var montoRestante = montoTotal - montoRecibo;
        parts.push(
          '<div class="receipt-detail-row"><span class="receipt-detail-label">Monto Total Adeudado:</span><span>', formatCurrency(montoTotal), '</span></div>',
          '<div class="receipt-detail-row"><span class="receipt-detail-label">Saldo Pendiente:</span><span>', formatCurrency(montoRestante), '</span></div>'
        );
      }
      
      parts.push(
          '</div>',
          '<div class="receipt-total"><div>TOTAL ABONADO</div><div class="amount">', formatCurrency(montoRecibo), '</div></div>',
        '</div>',
        '<div class="receipt-footer">',
          '<div class="signature-container"><div class="signature-line"></div><p>Firma del Cliente</p></div>',
          '<div class="signature-container">', (signatureImage?('<img src="'+signatureImage+'" alt="Firma">'):'') ,'<div class="signature-line"></div><p>Firma Autorizada</p></div>',
        '</div>'
      );

      document.getElementById('receiptContent').innerHTML = parts.join('');
      document.getElementById('receiptModal').classList.add('active');
    }

    function printReceipt(){
      var content = document.getElementById('receiptContent').innerHTML.replace(/<\/script/gi,'<\\/script');
      var w = window.open('','_blank');
      var html = [];
      html.push('<!doctype html><html><head><meta charset="utf-8"><title>Recibo de Pago - Estudio Garc√≠a y Asociados</title><style>',
        'body{font-family:Arial,sans-serif;margin:0;padding:20px}',
        '.receipt-preview{max-width:700px;margin:0 auto}',
        '.receipt-header{background:linear-gradient(135deg,#1e293b,#1e3a8a);color:#fff;text-align:center;padding:30px}',
        '.receipt-header h1{font-size:1.8em;margin-bottom:10px;font-weight:300;letter-spacing:2px}',
        '.company-name{font-size:1.3em;font-weight:600;margin-bottom:15px}',
        '.receipt-info{display:flex;justify-content:space-between;margin-top:20px;font-size:.9em}',
        '.receipt-body{padding:30px;background:#fafbfc}',
        '.receipt-detail{background:#fff;padding:20px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0}',
        '.receipt-detail-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f5f9}',
        '.receipt-detail-row:last-child{border-bottom:none}',
        '.receipt-detail-label{font-weight:600;color:#1e293b}',
        '.receipt-total{background:#1e3a8a;color:#fff;padding:20px;border-radius:8px;text-align:center;margin:20px 0}',
        '.receipt-total .amount{font-size:2em;font-weight:700}',
        '.receipt-footer{padding:30px;display:flex;justify-content:space-between;background:#fff;border-top:2px solid #e2e8f0}',
        '.signature-container{text-align:center;flex:1}',
        '.signature-container img{max-width:150px;height:60px;object-fit:contain;margin-bottom:10px}',
        '.signature-line{border-top:2px solid #1e293b;width:200px;margin:10px auto}',
        '@media print{body{margin:0}}',
      '</style></head><body><div class="receipt-preview">');
      html.push(content);
      html.push('</div></body></html>');
      w.document.write(html.join(''));
      w.document.close();
      w.print();
    }

    // ====== IMPORT/EXPORT ======
    function exportData(){
      var dataStr = JSON.stringify(abonosData, null, 2);
      var uri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      var name = 'control_abonos_'+new Date().toISOString().slice(0,10)+'.json';
      var a = document.createElement('a');
      a.href = uri; a.download = name; a.click();
    }

    function handleImport(event){
      var file = event.target.files[0]; if(!file) return;
      var reader = new FileReader();
      reader.onload = function(e){
        try{
          var imported = JSON.parse(e.target.result);
          if(Array.isArray(imported) && confirm('¬øImportar '+imported.length+' registros? Esto sobreescribir√° los datos actuales.')){
            abonosData = imported; saveData(); loadData(); render(); alert('Datos importados exitosamente');
          }
        }catch(err){ alert('Error al importar el archivo. Verifique que sea un JSON v√°lido.'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function exportToExcel(){
      let data;
      if (currentFilter === 'todos-terminados') {
        data = abonosData.filter(a => a.estado === 'Terminado');
      } else {
        const abonosMes = getAbonosForMonth(currentMonth.month, currentMonth.year);
        let searchedData = abonosMes;
        if (currentSearchTerm) {
            searchedData = abonosMes.filter(a => (a.cliente || '').toLowerCase().includes(currentSearchTerm.toLowerCase()));
        }
        data = getFilteredAbonos(searchedData);
      }

      if(data.length===0){ alert('No hay datos para exportar.'); return; }

      var rows = data.map(function(a){
        return { 
          Cliente:a.cliente, 
          Tipo:a.tipo, 
          Monto:a.monto, 
          'Fecha de Pago':a.fechaPago, 
          'Forma de Pago':a.formaPago, 
          Estado:a.estado,
          Observaciones:a.observaciones || ''
        };
      });
      var ws = XLSX.utils.json_to_sheet(rows);
      var wb = XLSX.utils.book_new();
      var sheetName = (currentFilter==='todos') ? 'Todos' : (currentFilter.replace(/-/g,' '));
      XLSX.utils.book_append_sheet(wb, ws, sheetName);
      
      var fileName;
      if (currentFilter === 'todos-terminados') {
        fileName = 'Todos_los_Terminados.xlsx';
      } else {
        fileName = 'Abonos_'+MONTHS[currentMonth.month]+'_'+currentMonth.year+'_'+currentFilter+'.xlsx';
      }
      XLSX.writeFile(wb, fileName);
    }
  </script>
  
  <script>
    // GOOGLE DRIVE - VARIABLES Y FUNCIONES GLOBALES
    const CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const DATA_FILE_NAME = 'datos_control_abonos_mensuales.json';

    let tokenClient, gapiInited = false, gisInited = false, dataFileId = null;

    function gapiLoaded() { 
      gapi.load('client', initializeGapiClient); 
    }
    
    async function initializeGapiClient() { 
      await gapi.client.init({ apiKey: API_KEY, discoveryDocs: [DISCOVERY_DOC] }); 
      gapiInited = true; 
      maybeEnableButtons(); 
    }
    
    function gisLoaded() { 
      tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: '' }); 
      gisInited = true; 
      maybeEnableButtons(); 
    }
    
    function maybeEnableButtons() { 
      if (gapiInited && gisInited) {
        // Nada que hacer aqu√≠, los botones tienen onclick directo en el HTML
      }
    }
    
    function updateDriveStatus(message, isConnected = false) { 
      const driveStatusEl = document.getElementById('driveStatus');
      driveStatusEl.style.display = 'block'; 
      driveStatusEl.textContent = message; 
      driveStatusEl.style.background = isConnected ? '#d1e7dd' : '#fff3cd'; 
      driveStatusEl.style.color = isConnected ? '#0f5132' : '#664d03'; 
    }

    function handleAuthClick() {
      tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) throw (resp);
        updateDriveStatus('‚úÖ Conectado a Google Drive', true);
        document.getElementById('connectDriveBtn').style.display = 'none'; 
        document.getElementById('saveToDriveBtn').style.display = 'inline-block'; 
        document.getElementById('loadFromDriveBtn').style.display = 'inline-block';
        await findDataFile();
      };
      if (gapi.client.getToken() === null) tokenClient.requestAccessToken({prompt: 'consent'}); 
      else tokenClient.requestAccessToken({prompt: ''});
    }
    
    async function findDataFile() {
      updateDriveStatus('Buscando archivo de datos en Drive...', false);
      try {
        const response = await gapi.client.drive.files.list({ q: `name='${DATA_FILE_NAME}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
        if (response.result.files.length > 0) { dataFileId = response.result.files[0].id; updateDriveStatus('‚úÖ Archivo de datos encontrado en Drive.', true); }
        else { updateDriveStatus('‚ö†Ô∏è Archivo no encontrado. Se crear√° uno nuevo al guardar.', false); dataFileId = null; }
      } catch (err) { console.error(err); alert('Error al buscar el archivo de datos en Drive.'); }
    }
    
    async function saveDataToDrive() {
      if (!confirm('¬øGuardar los datos actuales en Google Drive? Esto sobreescribir√° la versi√≥n anterior en la nube.')) return;
      updateDriveStatus('Guardando datos en Drive...', false);
      try {
        const content = JSON.stringify(abonosData, null, 2);
        dataFileId = await uploadContent(content, DATA_FILE_NAME, 'application/json', null, dataFileId);
        updateDriveStatus('‚úÖ ¬°Datos guardados en Drive con √©xito!', true);
      } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al guardar en Drive.', false); }
    }
    
    async function loadDataFromDrive() {
      if (!dataFileId) return alert("No se ha encontrado un archivo de datos. Guarda primero para crear uno.");
      if (!confirm("¬øSeguro? Se reemplazar√°n los datos locales con los de Drive.")) return;
      updateDriveStatus('Cargando datos desde Drive...', false);
      try {
        const response = await gapi.client.drive.files.get({ fileId: dataFileId, alt: 'media' });
        const importedData = JSON.parse(response.body);
        if (!Array.isArray(importedData)) throw new Error('Formato no v√°lido.');
        abonosData = importedData;
        saveData();
        loadData();
        render();
        updateDriveStatus('‚úÖ Datos cargados desde Drive con √©xito.', true);
      } catch (err) { console.error(err); updateDriveStatus('‚ùå Error al cargar desde Drive.', false); alert('Error al cargar desde Drive: ' + err.message); }
    }
    
    async function uploadContent(content, fileName, mimeType, parentId, fileIdToUpdate) {
      const boundary = '-------314159265358979323846';
      const metadata = { name: fileName, mimeType: mimeType, ...(parentId && {parents: [parentId]}) };
      const base64Data = content instanceof ArrayBuffer ? btoa(String.fromCharCode.apply(null, new Uint8Array(content))) : btoa(unescape(encodeURIComponent(content)));
      const requestBody =
        `--${boundary}\r\n` +
        `Content-Type: application/json; charset=UTF-8\r\n\r\n` +
        JSON.stringify(metadata) +
        `\r\n--${boundary}\r\n` +
        `Content-Type: ${mimeType}\r\n` +
        `Content-Transfer-Encoding: base64\r\n\r\n` +
        base64Data +
        `\r\n--${boundary}--`;
        
      const request = gapi.client.request({
        path: fileIdToUpdate ? `/upload/drive/v3/files/${fileIdToUpdate}` : '/upload/drive/v3/files',
        method: fileIdToUpdate ? 'PATCH' : 'POST',
        params: { uploadType: 'multipart' },
        headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
        body: requestBody
      });
      const response = await request;
      return response.result.id;
    }
  </script>
  
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  
</body>
</html>
