<!DOCTYPE html>
<html lang="es-AR">
<head>
<meta charset="UTF-8">
<title>Planilla de Siniestros - Garc√≠a & Asociados</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
<style>
:root {
    --primary-color: #2980b9;
    --secondary-color: #3498db;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --success-color: #2ecc71;
    --light-bg: #ecf0f1;
    --dark-text: #2c3e50;
    --light-text: #ffffff;
    --border-radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
.header{background:linear-gradient(135deg,#020c24 0%,#081e4b 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:2.4em;margin-bottom:8px}
.header-clock-container{display:flex;align-items:center;justify-content:center;gap:20px;margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,.2)}
.analog-clock{width:60px;height:60px;background:rgba(255,255,255,.1);border-radius:50%;border:2px solid rgba(255,255,255,.5);position:relative;flex-shrink:0}
.analog-clock .hand{width:50%;height:2px;background:var(--light-text);position:absolute;top:50%;transform-origin:100%;transform:rotate(90deg);transition:none}
.analog-clock .hour-hand{width:35%;left:15%;background:var(--secondary-color);height:3px}
.analog-clock .min-hand{height:2px}
.analog-clock .second-hand{width:45%;left:5%;background:var(--danger-color);height:1px}
#digital-clock{font-size:1em;opacity:.9;font-weight:500;letter-spacing:.5px;text-align:left}
.main-content{padding:30px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;margin-bottom:40px}
.card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 8px 25px rgba(0,0,0,.1);border:1px solid #e0e0e0;transition:.3s}
.card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.card h3{color:#2c3e50;margin-bottom:18px;font-size:1.2em;display:flex;gap:8px;align-items:center}
.today-reviews{background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff}
.overdue-reviews{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff}
.pending-reviews{background:linear-gradient(135deg,#feca57,#ff9ff3);color:#fff}
.btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:11px 22px;border-radius:8px;cursor:pointer;font-size:.95em;margin:5px;transition:.25s}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(102,126,234,.4)}
.btn-success{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.btn-info{background:linear-gradient(135deg,#3498db,#2980b9)}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
.btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22)}
.btn-sm{padding:6px 14px;font-size:.8em}
.data-status{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;font-size:.9em}
.filter-bar{background:#f8f9fa;padding:18px;border-radius:8px;margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
.form-group{margin-bottom:10px}
.form-group label{display:block;font-weight:600;margin-bottom:6px;color:#2c3e50;font-size:.85em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:.9em}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.reviews-list{max-height:400px;overflow:auto}
.review-item{background:#f8f9fa;border-left:4px solid #667eea;padding:14px;margin-bottom:9px;border-radius:0 8px 8px 0;display:flex;gap:10px;align-items:center;cursor:pointer;font-size:.82em}
.review-item.completed{background:#f2fdf5;border-left-color:#2ecc71;opacity:.85}
.review-item.today{border-left-color:#e74c3c}
.review-item.overdue{border-left-color:#f39c12}
.review-item:hover{background:#eef4ff}
.review-date{font-weight:600;color:#2c3e50}
.review-client{color:#667eea;font-weight:500;margin:4px 0}
.review-obs{font-style:italic;color:#555}
.review-obs-private{font-size:.9em;color:#8e44ad;font-style:italic;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px}
.complete-btn{background:#e0e0e0;border:none;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:14px}
.complete-btn:hover{background:#c7c7c7}
.review-item.completed .complete-btn{background:#2ecc71;color:#fff}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);z-index:1000}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:#fff;border-radius:14px;padding:28px;max-width:900px;width:95%;max-height:90vh;overflow:auto}
#alertModal .modal-content{border-top:10px solid var(--danger-color)}
#alertModal h2{color:var(--danger-color);text-align:center;margin-bottom:20px}
.close{float:right;font-size:26px;font-weight:700;color:#999;cursor:pointer;margin-top:-8px}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px}
.info-item{background:#fff;padding:10px;border-left:3px solid #667eea;border-radius:6px}
.info-label{font-size:.65em;text-transform:uppercase;color:#666;font-weight:600;letter-spacing:.5px}
.info-value{font-size:.85em;font-weight:500;color:#2c3e50;margin-top:2px;word-break:break-word}
.editable-field{cursor:pointer;padding:2px 4px;margin:-2px -4px}
.editable-field:hover{background:#eef5ff;border-radius:4px}
.history-item{background:#fff;border:1px solid #e0e0e0;border-left:4px solid #667eea;border-radius:6px;padding:12px;margin-bottom:10px;font-size:.9rem}
.history-item.completed{opacity:.6}
.history-date{font-size:.9em;font-weight:600;color:#667eea;margin-bottom:4px}
.history-revision-date{color:#c0392b;font-size:.85em;margin-top:4px}
.private-note-details{margin-top:10px}
.private-note-summary{cursor:pointer;font-weight:600;color:#8e44ad;-webkit-user-select:none;user-select:none;font-size:.9em}
.private-note-summary::-webkit-details-marker{display:none}
.private-note-summary:before{content:'‚ûï';display:inline-block;margin-right:8px}
.private-note-details[open] .private-note-summary:before{content:'‚ûñ'}
.private-note-content{background:#fdf5e6;border-left:3px solid #f39c12;padding:10px;margin-top:8px;border-radius:5px;font-style:italic;color:#666}
.history-item-mediacion{border-left-color:#1abc9c}
.history-tag{font-size:.8em;color:#fff;padding:2px 8px;border-radius:10px;margin-left:auto;font-weight:500;display:inline-block}
.tag-task{background-color:var(--secondary-color)}
.tag-mediacion{background-color:#1abc9c}
.form-section{background:#f8f9fa;padding:16px;border:1px solid #e0e0e0;border-radius:10px;margin-top:16px}
.action-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:18px}
.document-list{list-style:none;padding:0;margin:0;max-height:250px;overflow:auto;font-size:.9em}
.document-list li{background:#f1f3f5;padding:8px 10px;border-radius:6px;margin-bottom:7px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.document-list a{color:#3498db;text-decoration:none;font-weight:500;flex:1;word-break:break-word}
.document-list a:hover{text-decoration:underline}
.document-list .spinner{display:block;margin:20px auto;width:30px;height:30px;border:4px solid #f3f3f3;border-top:4px solid #3498db;border-radius:50%;animation:spin 1s linear infinite}
.progress-bar-container{width:80%;margin:20px auto;height:20px;background-color:#ecf0f1;border-radius:10px;overflow:hidden}
.progress-bar{width:0;height:100%;background:linear-gradient(90deg,var(--secondary-color),var(--primary-color));transition:width .2s ease-out}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
@media (max-width:780px){.reviews-list{max-height:300px}.action-buttons .btn{flex:1 1 100%}}
@media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%;padding:20px}.btn,.no-print{display:none!important}#generatedLetterText{white-space:pre-wrap}}

/* Estilos para las nuevas funcionalidades */
.weekly-glance {
    display: flex;
    justify-content: space-around;
    padding: 15px 0 5px 0;
    gap: 10px;
    flex-wrap: wrap;
    transition: all 0.4s ease-in-out;
}
.day-circle {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background: #f0f4f7;
    border: 2px solid #e1e8ed;
    transition: all 0.3s ease;
}
.day-circle.has-tasks {
    background: #fff9e6;
    border-color: var(--warning-color);
    font-weight: bold;
    cursor: pointer;
}
.day-circle.has-tasks:hover {
    transform: scale(1.1);
    box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);
}
.day-circle.is-today {
     background: #e8f2ff;
     border-color: var(--primary-color);
}
.day-circle .day-name {
    font-size: 0.9em;
    font-weight: 600;
    color: var(--dark-text);
}
.day-circle .day-count {
    font-size: 1.4em;
    color: var(--primary-color);
    margin-top: 2px;
}
.day-circle.has-tasks .day-count {
    color: #d35400;
}
.toggle-icon { display: inline-block; margin-left: 8px; }
</style>
</head>
<body>

<datalist id="marcasVehiculosList"></datalist>

<div class="container">
  <div class="header">
    <h1>üö¶ Planilla de Siniestros</h1>
    <p>Garc√≠a & Asociados</p>
    <div class="header-clock-container">
        <div class="analog-clock">
            <div class="hand hour-hand"></div>
            <div class="hand min-hand"></div>
            <div class="hand second-hand"></div>
        </div>
        <div id="digital-clock"></div>
    </div>
  </div>

  <div class="main-content">
    <div id="dataStatus" class="data-status">Cargando datos...</div>
    <div id="driveStatus" class="data-status" style="display:none;"></div>

    <section class="card" style="margin-bottom: 30px;">
        <h3 onclick="toggleVisibility('weeklyGlanceContainer')" style="cursor: pointer; user-select: none;">
            üóìÔ∏è Resumen de la Pr√≥xima Semana
            <span class="toggle-icon">‚ûñ</span>
        </h3>
        <div id="weeklyGlanceContainer" class="weekly-glance"></div>
    </section>
    
    <section class="card" style="margin-bottom: 30px; background-color: #e7f5ff;">
        <h3 onclick="toggleVisibility('advanceNoticeContainer')" style="cursor: pointer; user-select: none; border-color: #b3e0ff;">
            üîî Avisos Previos (Vencimientos y Mediaciones) (<span id="advanceNoticeCount">0</span>)
            <span class="toggle-icon">‚ûñ</span>
        </h3>
        <div id="advanceNoticeContainer" class="reviews-list" style="max-height: 300px; display: block;"></div>
    </section>

    <div class="dashboard">
      <div class="card today-reviews"><h3>Eventos de Hoy</h3><div class="reviews-list" id="todayReviews"></div></div>
      <div class="card overdue-reviews"><h3>Eventos Vencidos</h3><div class="reviews-list" id="overdueReviews"></div></div>
      <div class="card pending-reviews"><h3>Pr√≥ximos Eventos</h3><div class="reviews-list" id="upcomingReviews"></div></div>
    </div>

    <div style="text-align:center;margin-bottom:26px;">
      <button class="btn btn-success" onclick="showNewSiniestroModal()">‚ûï Agregar Siniestro</button>
      <button class="btn" onclick="showSiniestroSelectorModal()">üëÅÔ∏è Ver/Editar Siniestro</button>
      <button class="btn" onclick="exportToExcel()">üìä Exportar Excel</button>
      <button class="btn" onclick="exportData()">üíæ Exportar JSON</button>
      <button class="btn btn-warning" onclick="importData()">üì• Importar JSON</button>
    </div>

    <div style="text-align:center;border-top:1px solid #ddd;padding-top:18px;margin-bottom:25px;">
      <button id="connectDriveBtn" class="btn">üîó Conectar a Drive & Calendar</button>
      <button id="saveToDriveBtn" class="btn btn-success" style="display:none;">üì§ Guardar en Drive</button>
      <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;">üì• Cargar de Drive</button>
    </div>

    <div class="filter-bar">
      <div class="form-group"><label>B√∫squeda General</label><input type="text" id="searchInput" placeholder="Cliente, DNI, reclamo..." onkeyup="renderAllSiniestrosList()"></div>
      <div class="form-group"><label>Estado</label><select id="estadoFilter" onchange="renderAllSiniestrosList()"><option value="">Todos</option><option value="RECHAZADO">Rechazado</option><option value="SIN INICIAR">Sin iniciar</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA P">Finalizada P</option><option value="EJECUCION">Ejecuci√≥n</option><option value="DEMORADA">Demorada</option></select></div>
    </div>

    <div class="card">
      <h3>üìã Todos los Siniestros</h3>
      <div id="allSiniestros" class="reviews-list" style="max-height:580px;"></div>
    </div>
  </div>
</div>

<input type="file" id="importInput" accept=".json" style="display:none" onchange="handleImport(event)">
<input type="file" id="documentUploadInput" style="display:none" multiple>

<div id="newSiniestroModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroSelectorModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroInfoModal" class="modal"><div class="modal-content"></div></div>
<div id="alertModal" class="modal"><div class="modal-content"></div></div>
<div id="rescheduleModal" class="modal"><div class="modal-content"></div></div>
<div id="letterGenerationModal" class="modal"><div class="modal-content"></div></div>
<div id="documentModal" class="modal"><div class="modal-content"></div></div>

<script>
let siniestrosData=[];
let editingSiniestroId=null,editingField=null, currentSiniestroIdForDocs=null;

function saveData(){localStorage.setItem('planilla_siniestros_data',JSON.stringify(siniestrosData));updateDataStatus('‚úÖ Datos guardados localmente');}
function loadData(){
  const saved=localStorage.getItem('planilla_siniestros_data');
  siniestrosData = saved ? JSON.parse(saved) : [];
  siniestrosData=sanitizeData(siniestrosData);
  updateDataStatus(saved?'‚úÖ Datos locales cargados':'üìã Planilla lista para usar.');
}
function sanitizeData(data){
  (data||[]).forEach(s=>{
    s.id=s.id||generateId(s);
    s.observaciones=Array.isArray(s.observaciones)?s.observaciones:[];
    s.mediaciones_list=Array.isArray(s.mediaciones_list)?s.mediaciones_list:[];
    s.observaciones.forEach(o=>{
        o.id=o.id||generateId({});
        o.texto = o.texto || '';
        o.textoPrivado = o.textoPrivado || '';
        o.completed=typeof o.completed==='boolean'?o.completed:false;
    });
    s.mediaciones_list.forEach(m=>{
        m.id=m.id||generateId({});
        m.completed=typeof m.completed==='boolean'?m.completed:false;
        m.alertaMostrada=typeof m.alertaMostrada==='boolean'?m.alertaMostrada:false;
        m.avisoPrevio = m.avisoPrevio || '1'; // Default para datos antiguos
    });
    updateSiniestroNextRevision(s);
  });
  return data;
}
function updateDataStatus(msg,err=false){
  const el=document.getElementById('dataStatus');
  el.textContent=msg;
  el.style.background=err?'#f8d7da':'#d4edda';
  el.style.color=err?'#721c24':'#155724';
}
function getTodayYMD(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
const todayYMD=getTodayYMD();
function formatDate(d){if(!d) return 'No definida'; const date = new Date(d); const userTimezoneOffset = date.getTimezoneOffset() * 60000; const adjustedDate = new Date(date.getTime() + userTimezoneOffset); const [y,m,day]=adjustedDate.toISOString().split('T')[0].split('-'); return `${day}/${m}/${y}`;}
function formatTime(t){if(!t) return ''; return t;}
function isToday(d){return d&&d===todayYMD}
function isPastDue(d){return d&&d<todayYMD}
function getDaysDifference(d){if(!d) return 999;return Math.ceil((new Date(d)-new Date(todayYMD))/86400000)}
function generateId(it){return `EVT_${(it.cliente||'S').slice(0,3).toUpperCase()}_${Date.now()}_${Math.floor(Math.random()*1000)}`}
function getDisplayName(s){return `${s.cliente||'S/N'} - Reclamo: ${s.numeroReclamo||'S/N'} (${s.estado||'S/E'})`}
function formatCurrency(v){if(v===null||v===undefined||v==='') return 'S/D';return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(v)}
function toggleFormVisibility(formId) {
    const formElement = document.getElementById(formId);
    const iconElement = formElement.previousElementSibling.querySelector('.toggle-icon');
    if (formElement.style.display === 'none' || formElement.style.display === '') {
        formElement.style.display = 'block';
        if(iconElement) iconElement.textContent = '‚ûñ';
    } else {
        formElement.style.display = 'none';
        if(iconElement) iconElement.textContent = '‚ûï';
    }
}
function updateSiniestroNextRevision(s){
  const future=(s.observaciones||[]).filter(o=>!o.completed&&o.proximaRevision).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision));
  if(future.length){
      s.fechaRevision=future[0].proximaRevision;
      s.observacion=future[0].texto;
      if(future[0].textoPrivado) s.observacion += ` (Privado: ${future[0].textoPrivado})`;
    }
  else {s.fechaRevision='';s.observacion='No hay tareas pendientes';}
}
function toggleCompleted(e,sid,oid, type='task'){
    e.stopPropagation();
    const s = siniestrosData.find(x => x.id === sid);
    let item;
    if (type === 'task') item = s.observaciones.find(y => y.id === oid);
    else if (type === 'mediacion') item = s.mediaciones_list.find(y => y.id === oid);
    
    if(item) item.completed = !item.completed;
    if (type === 'task') updateSiniestroNextRevision(s);
    saveData(); renderAll();
}
function renderAll(){siniestrosData.forEach(updateSiniestroNextRevision);renderWeeklyGlance();renderAdvanceNotices();renderDashboardLists();renderAllSiniestrosList();}
function renderWeeklyGlance() {
    const container = document.getElementById('weeklyGlanceContainer');
    if (!container) return;

    const counts = Array(7).fill(0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const allSchedulableItems = siniestrosData.flatMap(siniestro => {
        const tasks = (siniestro.observaciones || []).filter(obs => !obs.completed && obs.proximaRevision).map(obs => ({ reviewDate: obs.proximaRevision }));
        const mediaciones = (siniestro.mediaciones_list || []).filter(med => med.fecha && !med.completed).map(med => ({ reviewDate: med.fecha }));
        return [...tasks, ...mediaciones];
    });

    allSchedulableItems.forEach(item => {
        if (!item.reviewDate) return;
        const itemDate = new Date(item.reviewDate + 'T00:00:00');
        const diffTime = itemDate - today;
        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays >= 0 && diffDays < 7) {
            counts[diffDays]++;
        }
    });

    const dayNames = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
    let html = '';
    for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dayOfWeek = date.getDay();
        const dayName = dayNames[dayOfWeek];
        const dateNumber = date.getDate();
        const isoDateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

        const hasTasks = counts[i] > 0;
        const hasTasksClass = hasTasks ? 'has-tasks' : '';
        const isTodayClass = i === 0 ? 'is-today' : '';
        const title = date.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' });
        const onClickAction = hasTasks ? `onclick="showTasksForDate('${isoDateString}')"` : '';

        html += `
            <div class="day-circle ${hasTasksClass} ${isTodayClass}" title="${title}" ${onClickAction}>
                <span class="day-name">${dayName} ${dateNumber}</span>
                <span class="day-count">${counts[i]}</span>
            </div>
        `;
    }
    container.innerHTML = html || '<p>No hay tareas en los pr√≥ximos 7 d√≠as.</p>';
}

function renderAdvanceNotices() {
    const container = document.getElementById('advanceNoticeContainer');
    if (!container) return;

    const itemsToNotice = [];
    
    siniestrosData.forEach(siniestro => {
        const criticalItems = [
            ...(siniestro.mediaciones_list || []).map(item => ({...item, dueDate: item.fecha, type: 'mediacion', text: `MEDIACI√ìN: ${item.texto}` }))
        ];

        criticalItems.forEach(item => {
            const noticeDays = parseInt(item.avisoPrevio, 10);
            if (!item.completed && noticeDays > 0 && item.dueDate) {
                const daysDifference = getDaysDifference(item.dueDate);
                if (daysDifference > 0 && daysDifference <= noticeDays) {
                    itemsToNotice.push({ siniestro, item, daysDifference });
                }
            }
        });
    });

    itemsToNotice.sort((a, b) => a.item.dueDate.localeCompare(b.item.dueDate));
    document.getElementById('advanceNoticeCount').textContent = itemsToNotice.length;

    if (itemsToNotice.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666;">No hay avisos previos para los pr√≥ximos d√≠as.</p>';
        return;
    }

    container.innerHTML = itemsToNotice.map(({ siniestro, item, daysDifference }) => {
        const dateInfo = `Vence en ${daysDifference} d√≠a${daysDifference > 1 ? 's' : ''} (${formatDate(item.dueDate)})`;
        return `<div class="review-item" onclick="showSiniestroModal('${siniestro.id}')">
                    <div class="review-item-content">
                        <div class="review-date">${dateInfo}</div>
                        <div class="review-client">${getDisplayName(siniestro)}</div>
                        <div class="review-obs">${item.text}</div>
                    </div>
                </div>`;
    }).join('');
}

function showTasksForDate(dateString) {
    const date = new Date(dateString);
    const formattedDate = formatDate(dateString);
    const modal = document.getElementById('dailyTasksModal');
    
    const tasksForDate = siniestrosData.flatMap(siniestro => {
        const tasks = (siniestro.observaciones || []).filter(obs => !obs.completed && obs.proximaRevision === dateString).map(obs => ({...obs, siniestro, type: 'task'}));
        const mediaciones = (siniestro.mediaciones_list || []).filter(med => !med.completed && med.fecha === dateString).map(med => ({...med, siniestro, type: 'mediacion'}));
        return [...tasks, ...mediaciones];
    });
    
    const content = `
        <span class="close" onclick="closeModal('dailyTasksModal')">&times;</span>
        <h2>Tareas para ${formattedDate}</h2>
        <div class="reviews-list" style="max-height: 60vh;">
            ${tasksForDate.length === 0 ? 
                '<p style="text-align: center; color: #666;">No hay tareas para esta fecha.</p>' :
                tasksForDate.map(item => {
                    const toggleFunc = `toggleCompleted(event,'${item.siniestro.id}','${item.id}', '${item.type}')`;
                    const privateNoteHtml = item.type === 'task' && item.textoPrivado ? `<div class="review-obs-private">üîí ${item.textoPrivado}</div>` : '';
                    const timeLabel = item.type === 'mediacion' ? formatTime(item.hora) : '';
                    const label = item.type === 'mediacion' ? 'MEDIACI√ìN:' : '';
                    
                    return `<div class="review-item">
                        <button class="complete-btn" onclick="${toggleFunc}">‚úî</button>
                        <div class="review-item-content" onclick="showSiniestroModal('${item.siniestro.id}')">
                            <div class="review-date">${timeLabel}</div>
                            <div class="review-client">${item.siniestro.cliente}</div>
                            <div class="review-obs"><b>${label}</b> ${item.texto}</div>
                            ${privateNoteHtml}
                        </div>
                    </div>`;
                }).join('')
            }
        </div>
    `;
    
    modal.querySelector('.modal-content').innerHTML = content;
    modal.classList.add('active');
}

function toggleVisibility(elementId) {
    const element = document.getElementById(elementId);
    const icon = element.previousElementSibling.querySelector('.toggle-icon');
    if (!element || !icon) return;
    
    if (getComputedStyle(element).display === 'none') {
        element.style.display = 'block';
        icon.textContent = '‚ûñ';
    } else {
        element.style.display = 'none';
        icon.textContent = '‚ûï';
    }
}

function renderDashboardLists(){
  const tasks = siniestrosData.flatMap(s => (s.observaciones||[]).filter(o=>!o.completed&&o.proximaRevision).map(o=>({...o,siniestro:s,type:'task'})));
  const mediaciones = siniestrosData.flatMap(s => (s.mediaciones_list||[]).filter(m=>!m.completed&&m.fecha).map(m=>({...m,siniestro:s,type:'mediacion',proximaRevision:m.fecha})));
  const allItems = [...tasks,...mediaciones];

  const today=allItems.filter(t=>isToday(t.proximaRevision));
  const overdue=allItems.filter(t=>isPastDue(t.proximaRevision)).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision));
  const upcoming=allItems.filter(t=>getDaysDifference(t.proximaRevision)>0).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision));
  renderReviewList('todayReviews',today,'No hay eventos para hoy','today');
  renderReviewList('overdueReviews',overdue,'No hay eventos vencidos','overdue');
  renderReviewList('upcomingReviews',upcoming,'No hay pr√≥ximos eventos','upcoming');
}
function renderReviewList(id,items,empty,type){
  const c=document.getElementById(id);
  const listColor = (type === 'today' || type === 'overdue' || type === 'pending-reviews') ? 'var(--light-text)' : 'rgba(0,0,0,0.6)';
  if(!items.length){c.innerHTML=`<p style="color:${listColor};text-align:center;">${empty}</p>`;return;}
  c.innerHTML=items.map(item=>{
    let dateInfo = '';
    if (type === 'today') dateInfo = 'HOY';
    else if (type === 'overdue') dateInfo = `VENCIDA - ${formatDate(item.proximaRevision)}`;
    else dateInfo = `En ${getDaysDifference(item.proximaRevision)} d√≠as - ${formatDate(item.proximaRevision)}`;
    
    let label = '';
    let timeLabel = item.type === 'mediacion' ? formatTime(item.hora) : '';
    if(item.type === 'mediacion') label = 'MEDIACI√ìN:';
    const toggleFunc = `toggleCompleted(event,'${item.siniestro.id}','${item.id}', '${item.type}')`;
    const privateNoteHtml = item.type === 'task' && item.textoPrivado ? `<div class="review-obs-private">üîí ${item.textoPrivado}</div>` : '';
    return `<div class="review-item">
      <button class="complete-btn" onclick="${toggleFunc}">‚úî</button>
      <div class="review-item-content" onclick="showSiniestroModal('${item.siniestro.id}')">
        <div class="review-date">${dateInfo} ${timeLabel}</div>
        <div class="review-client">${item.siniestro.cliente}</div>
        <div class="review-obs"><b>${label}</b> ${item.texto}</div>
        ${privateNoteHtml}
      </div>
    </div>`;
  }).join('');
}
function renderAllSiniestrosList(){
  const sterm=document.getElementById('searchInput').value.toLowerCase();
  const estado=document.getElementById('estadoFilter').value;
  const filtrados=siniestrosData.filter(s=>{
    const searchString = [s.cliente,s.dni,s.celular,s.mailCliente,s.estado,s.aseguradoEn,s.contra,s.numeroReclamo,s.presupuesto,s.indemnizacion,s.honorarios,s.acuerdo,s.fechaPago,s.factura,s.marcaCliente,s.modeloCliente,s.dominioCliente,s.marcaTercero,s.modeloTercero,s.dominioTercero].filter(Boolean).join(' ').toLowerCase();
    const matchS=!sterm||searchString.includes(sterm);
    const matchE=!estado||s.estado===estado;
    return matchS&&matchE;
  }).sort((a,b)=>(a.fechaRevision||'9999').localeCompare(b.fechaRevision||'9999'));
  document.getElementById('allSiniestros').innerHTML=filtrados.length?filtrados.map(s=>{
    const pending=(s.observaciones||[]).some(o=>!o.completed&&o.proximaRevision);
    const cls=`review-item ${!pending?'completed':''} ${isToday(s.fechaRevision)?'today':''} ${isPastDue(s.fechaRevision)?'overdue':''}`;
    const lastWorkedObs = (s.observaciones || []).filter(o => o.fechaTrabajado).sort((a, b) => b.fechaTrabajado.localeCompare(a.fechaTrabajado))[0];
    const lastWorkedDate = lastWorkedObs ? lastWorkedObs.fechaTrabajado : null;
    return `<div class="${cls}" onclick="showSiniestroModal('${s.id}')">
      <div class="review-item-content">
        <div style="display:flex; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
            <div class="review-date">Pr√≥x. Tarea: ${formatDate(s.fechaRevision)}</div>
            ${lastWorkedDate ? `<div class="review-date" style="color:#27ae60;">Trabajado: ${formatDate(lastWorkedDate)}</div>` : ''}
        </div>
        <div class="review-client">${s.cliente} - Reclamo: ${s.numeroReclamo||'S/N'}</div>
        <div class="review-obs">${s.observacion}</div>
      </div>
    </div>`;
  }).join(''):'<p>No se encontraron siniestros.</p>';
}
function showNewSiniestroModal(){document.getElementById('newSiniestroModal').classList.add('active')}
function showSiniestroSelectorModal(){
  const sel=document.getElementById('siniestroSelector');
  sel.innerHTML='<option value="">-- Seleccionar --</option>' + [...siniestrosData].sort((a,b)=>(a.cliente||'').localeCompare(b.cliente||''))
    .map(s=>`<option value="${s.id}">${getDisplayName(s)}</option>`).join('');
  document.getElementById('siniestroSelectorModal').classList.add('active');
}
function loadSiniestroInfo(){const id=document.getElementById('siniestroSelector').value;if(id){closeModal('siniestroSelectorModal');showSiniestroModal(id);}}
function closeModal(id){document.getElementById(id).classList.remove('active');editingSiniestroId=null;editingField=null;}
function showSiniestroModal(id){
  const s=siniestrosData.find(x=>x.id===id);if(!s)return;
  updateSiniestroNextRevision(s);
  const aseguradoras = [...new Set(siniestrosData.map(s => s.aseguradoEn).filter(Boolean))];
  const contras = [...new Set(siniestrosData.map(s => s.contra).filter(Boolean))];
  const datalistsHTML = `<datalist id="aseguradorasList">${aseguradoras.map(a => `<option value="${a}"></option>`).join('')}</datalist><datalist id="contrasList">${contras.map(c => `<option value="${c}"></option>`).join('')}</datalist>`;
  const html=`
    <span class="close" onclick="closeModal('siniestroInfoModal')">&times;</span><h2 style="margin-bottom:12px;">üè• ${s.cliente}</h2>
    <div class="info-grid">${Object.entries({
        cliente:'Cliente (Titular)',dni:'DNI (Titular)',celular:'Celular',mailCliente:'Mail Cliente',estado:'Estado',
        conductorNombre: 'Nombre Conductor', conductorDni: 'DNI Conductor',
        aseguradoEn:'Aseguradora Cliente', polizaCliente: 'P√≥liza Cliente', 
        marcaCliente: 'Marca Veh. Cliente', modeloCliente: 'Modelo Veh. Cliente', dominioCliente: 'Dominio Veh. Cliente', anoCliente: 'A√±o Veh. Cliente',
        contra:'Aseguradora Tercero', numeroReclamo:'N¬∞ Reclamo',
        fechaSiniestro: 'Fecha Siniestro', horaSiniestro: 'Hora Siniestro', lugarSiniestro: 'Lugar Siniestro',
        nombreTercero: 'Nombre Tercero', mailTercero:'Mail Tercero', telefonoTercero: 'Tel√©fono Tercero',
        marcaTercero: 'Marca Veh. Tercero', modeloTercero: 'Modelo Veh. Tercero', dominioTercero: 'Dominio Veh. Tercero', anoTercero: 'A√±o Veh. Tercero',
        presupuesto:'Presupuesto',indemnizacion:'Indemnizaci√≥n',honorarios:'Honorarios',
        acuerdo:'Acuerdo',fechaPago:'Fecha Pago',factura:'Factura'
    }).map(([k,l])=>`<div class="info-item"><div class="info-label">${l}</div><div class="info-value editable-field" id="field-${k}" onclick="editField('${s.id}','${k}', this)">${
        /presupuesto|indemnizacion|honorarios/.test(k) ? formatCurrency(s[k]) : (k === 'fechaSiniestro' ? formatDate(s[k]) : (s[k] || 'S/D'))
    }</div></div>`).join('')}<div class="info-item"><div class="info-label">Pr√≥xima Tarea</div><div class="info-value" style="color:#e74c3c;font-weight:700">${formatDate(s.fechaRevision)}</div></div></div>
    
    <div class="form-section" style="margin-top: 20px;">
        <h4>üí∞ Informaci√≥n de Cobro</h4>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Cobrado por Cliente</div>
                <div class="info-value editable-field" id="field-cobradoCliente" onclick="editField('${s.id}','cobradoCliente', this)">${s.cobradoCliente || 'No'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Cobrado por Estudio</div>
                <div class="info-value editable-field" id="field-cobradoEstudio" onclick="editField('${s.id}','cobradoEstudio', this)">${s.cobradoEstudio || 'No'}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Fecha de Cobro</div>
                <div class="info-value editable-field" id="field-fechaCobro" onclick="editField('${s.id}','fechaCobro', this)">${s.fechaCobro ? formatDate(s.fechaCobro) : 'S/F'}</div>
            </div>
        </div>
    </div>
    
    <div style="margin-top:18px;"><h4 style="margin-bottom:8px;font-size:.9em;">Historial de Eventos</h4><div id="history-list-${s.id}" style="max-height:230px;overflow:auto;padding-right:5px;">${renderHistoryList(s)}</div></div>
    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px;">
        <div class="form-section"><h4>üìù Agregar Tarea</h4><form onsubmit="addObservation(event,'${s.id}')"><div class="form-group"><label>Texto para el Cliente (P√∫blico)</label><textarea id="newObsText" rows="2"></textarea></div><div class="form-group"><label>Notas Internas (Privadas)</label><textarea id="newObsTextPrivate" rows="2"></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n</label><input type="date" id="newRevisionDate" required></div><button class="btn btn-success" type="submit">Guardar Tarea</button></form></div>
        <div class="form-section"><h4 onclick="toggleFormVisibility('mediacion-form-fields')" style="cursor: pointer; user-select: none;"><span class="toggle-icon">‚ûï</span> Agendar Mediaci√≥n</h4><form id="mediacion-form-fields" onsubmit="addMediacion(event,'${s.id}')" style="display:none; margin-top:15px;"><div class="form-group"><label>Descripci√≥n</label><textarea id="newMediacionText" rows="2" required></textarea></div><div class="form-group"><label>Fecha de Mediaci√≥n</label><input type="date" id="newMediacionDate" required></div><div class="form-group"><label>Hora de Mediaci√≥n</label><input type="time" id="newMediacionTime" required></div><div class="form-group"><label>Aviso Previo</label><select id="newMediacionAvisoPrevio"><option value="0">Sin aviso</option><option value="1" selected>1 d√≠a antes</option><option value="2">2 d√≠as antes</option><option value="3">3 d√≠as antes</option><option value="7">1 semana antes</option></select></div><button class="btn btn-success" type="submit">Guardar Mediaci√≥n</button></form></div>
    </div>
    <div class="action-buttons"><button class="btn btn-info" onclick="printFicha('${s.id}')">üñ®Ô∏è Ficha</button><button class="btn btn-info" onclick="printHistorial('${s.id}')">üñ®Ô∏è Historial</button><button class="btn" onclick="startLetterGeneration('${s.id}')">‚úâÔ∏è Generar Carta Patrocinio</button><button class="btn btn-info" onclick="showDocumentModal('${s.id}')">üìÅ Documentos</button><button class="btn btn-danger" onclick="deleteSiniestro('${s.id}')">üóëÔ∏è Eliminar</button></div>${datalistsHTML}`;
  const m=document.getElementById('siniestroInfoModal');m.querySelector('.modal-content').innerHTML=html;m.classList.add('active');
}
function renderHistoryList(s){
    const tasks = (s.observaciones||[]).map(o => ({...o, type: 'task', date: o.proximaRevision}));
    const mediaciones = (s.mediaciones_list||[]).map(m => ({...m, type: 'mediacion', date: m.fecha}));
    const allEvents = [...tasks, ...mediaciones].sort((a,b) => (b.date||'').localeCompare(a.date||''));
    return allEvents.length ? allEvents.map(item => {
        let tagClass, tagText, itemClass, dateLabel, dateValue, deleteFunc, timeValue = '';
        if(item.type === 'task') {tagClass = 'tag-task'; tagText = 'TAREA'; itemClass = ''; dateLabel = 'Creaci√≥n'; dateValue = item.fecha; deleteFunc = `deleteObs('${s.id}','${item.id}')`;} 
        else {tagClass = 'tag-mediacion'; tagText = 'MEDIACI√ìN'; itemClass = 'history-item-mediacion'; dateLabel = 'Fecha'; dateValue = item.fecha; timeValue = formatTime(item.hora); deleteFunc = `deleteMediacion('${s.id}','${item.id}')`;}
        const privateNoteHtml = item.type === 'task' && item.textoPrivado ? `<details class="private-note-details"><summary class="private-note-summary">üîí Ver Nota Privada</summary><div class="private-note-content">${item.textoPrivado}</div></details>` : '';
        return `<div class="history-item ${itemClass} ${item.completed?'completed':''}" id="${item.type}-item-${item.id}"><div style="display:flex; align-items:center;"><div class="history-date">${dateLabel}: ${formatDate(dateValue)} ${timeValue}</div><span class="history-tag ${tagClass}">${tagText}</span></div>${item.type === 'task' && item.fechaTrabajado ? `<div class="history-date" style="color: #27ae60;">Trabajado: ${formatDate(item.fechaTrabajado)}</div>` : ''}<div>${item.texto}</div>${privateNoteHtml}${item.type === 'task' ? `<div class="history-revision-date">Revisi√≥n: ${formatDate(item.proximaRevision)}</div>` : ''}<div style="margin-top:6px;display:flex;gap:6px;">${item.type === 'task' ? `<button class="btn btn-sm" onclick="editObs('${s.id}','${item.id}')">Editar</button>` : ''}<button class="btn btn-danger btn-sm" onclick="${deleteFunc}">Eliminar</button></div></div>`;
    }).join('') : '<p style="font-size:.8em;">Sin eventos.</p>';
}
function editObs(sid,oid){
  const s=siniestrosData.find(x=>x.id===sid); const o=s.observaciones.find(k=>k.id===oid);
  const el=document.getElementById(`task-item-${o.id}`);
  el.innerHTML=`<div class="form-group"><label>Texto P√∫blico</label><textarea id="edit-obs-text-${o.id}" rows="2" style="font-size: 1rem; min-height: 60px;">${o.texto}</textarea></div><div class="form-group"><label>Notas Privadas</label><textarea id="edit-obs-private-${o.id}" rows="2" style="font-size: 1rem; min-height: 60px;">${o.textoPrivado || ''}</textarea></div><div class="form-group"><label>Fecha Revisi√≥n</label><input type="date" id="edit-obs-revision-${o.id}" value="${o.proximaRevision}"></div><button class="btn btn-success btn-sm" onclick="saveObs('${sid}','${o.id}')">Guardar</button><button class="btn btn-sm" onclick="showSiniestroModal('${sid}')">Cancelar</button>`;
}
function saveObs(sid,oid){
  const s=siniestrosData.find(x=>x.id===sid); const o=s.observaciones.find(k=>k.id===oid);
  o.texto=document.getElementById(`edit-obs-text-${o.id}`).value;
  o.textoPrivado=document.getElementById(`edit-obs-private-${o.id}`).value;
  o.proximaRevision=document.getElementById(`edit-obs-revision-${o.id}`).value;
  updateSiniestroNextRevision(s);saveData();renderAll();showSiniestroModal(sid);
}
function deleteObs(sid,oid){if(!confirm('¬øEliminar tarea?'))return;const s=siniestrosData.find(x=>x.id===sid);s.observaciones=s.observaciones.filter(o=>o.id!==oid);updateSiniestroNextRevision(s);saveData();renderAll();showSiniestroModal(sid);}
function addMediacion(e,sid){e.preventDefault();const s=siniestrosData.find(x=>x.id===sid);const newMediacion = { id:generateId({}), fecha:document.getElementById('newMediacionDate').value, hora:document.getElementById('newMediacionTime').value, texto:document.getElementById('newMediacionText').value, completed:false, alertaMostrada: false, avisoPrevio: document.getElementById('newMediacionAvisoPrevio').value };s.mediaciones_list.push(newMediacion);saveData(); renderAll(); showSiniestroModal(sid);addEventToGoogleCalendar(s, newMediacion);}
function deleteMediacion(sid,mid){if(!confirm('¬øEliminar mediaci√≥n?'))return;const s=siniestrosData.find(x=>x.id===sid);s.mediaciones_list=s.mediaciones_list.filter(m=>m.id!==mid);saveData();renderAll();showSiniestroModal(sid);}
function editField(sid, field, element) {
    if (editingField) return; editingSiniestroId = sid; editingField = field;
    const s = siniestrosData.find(x => x.id === sid); const currentValue = s[field] || '';
    let inputType = 'text';
    
    if (field === 'cobradoCliente' || field === 'cobradoEstudio') {
        inputType = 'select';
    } else if (/presupuesto|indemnizacion|honorarios|dni|celular|conductorDni|anoCliente|anoTercero|telefonoTercero/.test(field)) {
        inputType = 'number';
    } else if (field === 'fechaSiniestro' || field === 'fechaCobro') {
        inputType = 'date';
    } else if (field === 'horaSiniestro') {
        inputType = 'time';
    } else if (/mail/.test(field)) {
        inputType = 'email';
    }

    const input = document.createElement(inputType === 'select' ? 'select' : 'input');
    if (inputType === 'select') {
        const options = ['S√≠', 'No'];
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt;
            option.textContent = opt;
            if (opt === currentValue) option.selected = true;
            input.appendChild(option);
        });
    } else {
        input.type = inputType;
        input.value = currentValue;
    }
    
    input.style.cssText='width:100%;font-size:0.85em;border:1px solid #667eea;padding:2px;';
    if (field === 'aseguradoEn') input.setAttribute('list', 'aseguradorasList');
    if (field === 'contra') input.setAttribute('list', 'contrasList');
    if (/marca/.test(field)) input.setAttribute('list', 'marcasVehiculosList');
    
    const save = () => { 
        s[editingField] = input.value; 
        saveData(); 
        editingSiniestroId = null; 
        editingField = null; 
        showSiniestroModal(sid); 
    };
    input.addEventListener('blur', save); 
    input.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); }});
    element.innerHTML = ''; element.appendChild(input); input.focus(); 
    const valLength = input.value.length; 
    input.setSelectionRange(valLength, valLength);
}
function deleteSiniestro(id){if(!confirm('¬øEliminar siniestro y todo su historial?'))return;siniestrosData=siniestrosData.filter(s=>s.id!==id);saveData();renderAll();closeModal('siniestroInfoModal');}
function addObservation(e,sid){
