<!DOCTYPE html>
<html lang="es-AR">
<head>
<meta charset="UTF-8">
<title>Planilla de Siniestros - Garc√≠a & Asociados</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
    --primary-color: #2980b9;
    --secondary-color: #3498db;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --success-color: #2ecc71;
    --light-bg: #ecf0f1;
    --dark-text: #2c3e50;
    --light-text: #ffffff;
    --border-radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
.header{background:linear-gradient(135deg,#020c24 0%,#081e4b 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:2.4em;margin-bottom:8px}
.main-content{padding:30px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;margin-bottom:40px}
.card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 8px 25px rgba(0,0,0,.1);border:1px solid #e0e0e0;transition:.3s}
.card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.card h3{color:#2c3e50;margin-bottom:18px;font-size:1.2em;display:flex;gap:8px;align-items:center}
.today-reviews{background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff}
.overdue-reviews{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff}
.pending-reviews{background:linear-gradient(135deg,#feca57,#ff9ff3);color:#fff}
.btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:11px 22px;border-radius:8px;cursor:pointer;font-size:.95em;margin:5px;transition:.25s}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(102,126,234,.4)}
.btn-success{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.btn-info{background:linear-gradient(135deg,#3498db,#2980b9)}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
.btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22)}
.btn-sm{padding:6px 14px;font-size:.8em}
.data-status{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;font-size:.9em}
.filter-bar{background:#f8f9fa;padding:18px;border-radius:8px;margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
.form-group label{display:block;font-weight:600;margin-bottom:6px;color:#2c3e50;font-size:.85em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:.9em}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.reviews-list{max-height:400px;overflow:auto}
.review-item{background:#f8f9fa;border-left:4px solid #667eea;padding:14px;margin-bottom:9px;border-radius:0 8px 8px 0;display:flex;gap:10px;align-items:center;cursor:pointer;font-size:.82em}
.review-item.completed{background:#f2fdf5;border-left-color:#2ecc71;opacity:.85}
.review-item.today{border-left-color:#e74c3c}
.review-item.overdue{border-left-color:#f39c12}
.review-item:hover{background:#eef4ff}
.review-date{font-weight:600;color:#2c3e50}
.review-client{color:#667eea;font-weight:500;margin:4px 0}
.review-obs{font-style:italic;color:#555}
.review-obs-private { font-size: 0.9em; color: #8e44ad; font-style: italic; margin-top: 5px; border-top: 1px dashed #ddd; padding-top: 5px;}
.complete-btn{background:#e0e0e0;border:none;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:14px}
.complete-btn:hover{background:#c7c7c7}
.review-item.completed .complete-btn{background:#2ecc71;color:#fff}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);z-index:1000}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:#fff;border-radius:14px;padding:28px;max-width:900px;width:95%;max-height:90vh;overflow:auto}
#alertModal .modal-content { border-top: 10px solid var(--danger-color); }
#alertModal h2 { color: var(--danger-color); text-align: center; margin-bottom: 20px; }
.close{float:right;font-size:26px;font-weight:700;color:#999;cursor:pointer;margin-top:-8px}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px}
.info-item{background:#fff;padding:10px;border-left:3px solid #667eea;border-radius:6px}
.info-label{font-size:.65em;text-transform:uppercase;color:#666;font-weight:600;letter-spacing:.5px}
.info-value{font-size:.85em;font-weight:500;color:#2c3e50;margin-top:2px;word-break:break-word}
.editable-field{cursor:pointer;padding:2px 4px;margin:-2px -4px;}
.editable-field:hover{background:#eef5ff;border-radius:4px}
.history-item{background:#fff;border:1px solid #e0e0e0;border-left:4px solid #667eea;border-radius:6px;padding:12px;margin-bottom:10px;font-size:0.9rem}
.history-item.completed{opacity:.6}
.history-date{font-size:.9em;font-weight:600;color:#667eea;margin-bottom:4px}
.history-revision-date{color:#c0392b;font-size:.85em;margin-top:4px}
.private-note-details { margin-top: 10px; }
.private-note-summary { cursor: pointer; font-weight: 600; color: #8e44ad; user-select: none; font-size: 0.9em;}
.private-note-summary::-webkit-details-marker { display: none; }
.private-note-summary:before { content: '‚ûï'; display: inline-block; margin-right: 8px; }
.private-note-details[open] .private-note-summary:before { content: '‚ûñ'; }
.private-note-content { background: #fdf5e6; border-left: 3px solid #f39c12; padding: 10px; margin-top: 8px; border-radius: 5px; font-style: italic; color: #666; }
.history-item-mediacion { border-left-color: #1abc9c; }
.history-tag { font-size: 0.8em; color: #fff; padding: 2px 8px; border-radius: 10px; margin-left: auto; font-weight: 500; display: inline-block; }
.tag-task { background-color: var(--secondary-color); }
.tag-mediacion { background-color: #1abc9c; }
.form-section{background:#f8f9fa;padding:16px;border:1px solid #e0e0e0;border-radius:10px;margin-top:16px}
.action-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:18px}
.document-list{list-style:none;padding:0;margin:0;max-height:250px;overflow:auto;font-size:.9em}
.document-list li{background:#f1f3f5;padding:8px 10px;border-radius:6px;margin-bottom:7px;display:flex;align-items:center;justify-content:space-between;gap:8px}
.document-list a{color:#3498db;text-decoration:none;font-weight:500;flex:1;word-break:break-word}
.document-list a:hover{text-decoration:underline}
.document-list .spinner { display: block; margin: 20px auto; width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
@media (max-width:780px){
  .reviews-list{max-height:300px}
  .action-buttons .btn{flex:1 1 100%}
}
@media print{
  body *{visibility:hidden}
  .print-area,.print-area *{visibility:visible}
  .print-area{position:absolute;left:0;top:0;width:100%;padding:20px}
  .btn,.no-print{display:none!important}
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üö¶ Planilla de Siniestros</h1>
    <p>Garc√≠a & Asociados</p>
  </div>

  <div class="main-content">
    <div id="dataStatus" class="data-status">Cargando datos...</div>
    <div id="driveStatus" class="data-status" style="display:none;"></div>

    <div class="dashboard">
      <div class="card today-reviews">
        <h3>Eventos de Hoy</h3>
        <div class="reviews-list" id="todayReviews"></div>
      </div>
      <div class="card overdue-reviews">
        <h3>Eventos Vencidos</h3>
        <div class="reviews-list" id="overdueReviews"></div>
      </div>
      <div class="card pending-reviews">
        <h3>Pr√≥ximos Eventos</h3>
        <div class="reviews-list" id="upcomingReviews"></div>
      </div>
    </div>

    <div style="text-align:center;margin-bottom:26px;">
      <button class="btn btn-success" onclick="showNewSiniestroModal()">‚ûï Agregar Siniestro</button>
      <button class="btn" onclick="showSiniestroSelectorModal()">üëÅÔ∏è Ver/Editar Siniestro</button>
      <button class="btn" onclick="exportToExcel()">üìä Exportar Excel</button>
      <button class="btn" onclick="exportData()">üíæ Exportar JSON</button>
      <button class="btn btn-warning" onclick="importData()">üì• Importar JSON</button>
    </div>

    <div style="text-align:center;border-top:1px solid #ddd;padding-top:18px;margin-bottom:25px;">
      <button id="connectDriveBtn" class="btn">üîó Conectar a Drive & Calendar</button>
      <button id="saveToDriveBtn" class="btn btn-success" style="display:none;">üì§ Guardar en Drive</button>
      <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;">üì• Cargar de Drive</button>
    </div>

    <div class="filter-bar">
      <div class="form-group">
        <label>B√∫squeda General</label>
        <input type="text" id="searchInput" placeholder="Cliente, DNI, reclamo..." onkeyup="renderAllSiniestrosList()">
      </div>
      <div class="form-group">
        <label>Estado</label>
        <select id="estadoFilter" onchange="renderAllSiniestrosList()">
          <option value="">Todos</option>
          <option value="RECHAZADO">Rechazado</option>
          <option value="SIN INICIAR">Sin iniciar</option>
          <option value="FINALIZADA">Finalizada</option>
          <option value="FINALIZADA P">Finalizada P</option>
          <option value="EJECUCION">Ejecuci√≥n</option>
          <option value="DEMORADA">Demorada</option>
        </select>
      </div>
    </div>

    <div class="card">
      <h3>üìã Todos los Siniestros</h3>
      <div id="allSiniestros" class="reviews-list" style="max-height:580px;"></div>
    </div>
  </div>
</div>

<input type="file" id="importInput" accept=".json" style="display:none" onchange="handleImport(event)">
<input type="file" id="documentUploadInput" style="display:none" multiple>

<div id="newSiniestroModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroSelectorModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroInfoModal" class="modal"><div class="modal-content"></div></div>
<div id="alertModal" class="modal"><div class="modal-content"></div></div>
<div id="rescheduleModal" class="modal"><div class="modal-content"></div></div>

<div id="documentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('documentModal')">&times;</span>
        <h2 id="documentModalTitle"></h2>
        <div id="uploadArea" style="border: 2px dashed #ccc; padding: 20px; text-align: center; margin: 15px 0; background: #f9f9f9;">
            <p>Arrastra y suelta tus archivos aqu√≠</p>
        </div>
        <ul id="localDocumentList" class="document-list" style="margin-top:10px;"></ul>
        <h4>Documentos ya guardados en Drive:</h4>
        <ul id="driveDocumentList" class="document-list"></ul>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn btn-info" onclick="triggerLocalFileUpload()">‚ûï Agregar Archivo</button>
            <button class="btn btn-success" onclick="saveDocumentsToDrive()">üì§ Guardar Documentos en Drive</button>
        </div>
    </div>
</div>

<script>
let siniestrosData=[];
let editingSiniestroId=null,editingField=null, currentSiniestroIdForDocs=null;

function saveData(){localStorage.setItem('planilla_siniestros_data',JSON.stringify(siniestrosData));updateDataStatus('‚úÖ Datos guardados localmente');}
function loadData(){
  const saved=localStorage.getItem('planilla_siniestros_data');
  siniestrosData = saved ? JSON.parse(saved) : [];
  siniestrosData=sanitizeData(siniestrosData);
  updateDataStatus(saved?'‚úÖ Datos locales cargados':'üìã Planilla lista para usar.');
}
function sanitizeData(data){
  (data||[]).forEach(s=>{
    s.id=s.id||generateId(s);
    s.observaciones=Array.isArray(s.observaciones)?s.observaciones:[];
    s.mediaciones_list=Array.isArray(s.mediaciones_list)?s.mediaciones_list:[];
    s.observaciones.forEach(o=>{
        o.id=o.id||generateId({});
        o.texto = o.texto || '';
        o.textoPrivado = o.textoPrivado || '';
        o.completed=typeof o.completed==='boolean'?o.completed:false;
    });
    s.mediaciones_list.forEach(m=>{
        m.id=m.id||generateId({});
        m.completed=typeof m.completed==='boolean'?m.completed:false;
        m.alertaMostrada=typeof m.alertaMostrada==='boolean'?m.alertaMostrada:false;
    });
    updateSiniestroNextRevision(s);
  });
  return data;
}
function updateDataStatus(msg,err=false){
  const el=document.getElementById('dataStatus');
  el.textContent=msg;
  el.style.background=err?'#f8d7da':'#d4edda';
  el.style.color=err?'#721c24':'#155724';
}
function getTodayYMD(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
const todayYMD=getTodayYMD();
function formatDate(d){if(!d) return 'No definida';const [y,m,day]=d.split('-');return `${day}/${m}/${y}`;}
function formatTime(t){if(!t) return ''; return t;}
function isToday(d){return d&&d===todayYMD}
function isPastDue(d){return d&&d<todayYMD}
function getDaysDifference(d){if(!d) return 999;return Math.ceil((new Date(d)-new Date(todayYMD))/86400000)}
function generateId(it){return `EVT_${(it.cliente||'S').slice(0,3).toUpperCase()}_${Date.now()}_${Math.floor(Math.random()*1000)}`}
function getDisplayName(s){return `${s.cliente||'S/N'} - Reclamo: ${s.numeroReclamo||'S/N'} (${s.estado||'S/E'})`}
function formatCurrency(v){if(v===null||v===undefined||v==='') return 'S/D';return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(v)}

function toggleFormVisibility(formId) {
    const formElement = document.getElementById(formId);
    const iconElement = formElement.previousElementSibling.querySelector('.toggle-icon');
    if (formElement.style.display === 'none' || formElement.style.display === '') {
        formElement.style.display = 'block';
        if(iconElement) iconElement.textContent = '‚ûñ';
    } else {
        formElement.style.display = 'none';
        if(iconElement) iconElement.textContent = '‚ûï';
    }
}

function updateSiniestroNextRevision(s){
  const future=(s.observaciones||[]).filter(o=>!o.completed&&o.proximaRevision).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision));
  if(future.length){
      s.fechaRevision=future[0].proximaRevision;
      s.observacion=future[0].texto;
      if(future[0].textoPrivado) s.observacion += ` (Privado: ${future[0].textoPrivado})`;
    }
  else {s.fechaRevision='';s.observacion='No hay tareas pendientes';}
}

function toggleCompleted(e,sid,oid, type='task'){
    e.stopPropagation();
    const s = siniestrosData.find(x => x.id === sid);
    let item;
    if (type === 'task') item = s.observaciones.find(y => y.id === oid);
    else if (type === 'mediacion') item = s.mediaciones_list.find(y => y.id === oid);
    
    if(item) item.completed = !item.completed;
    if (type === 'task') updateSiniestroNextRevision(s);
    saveData(); renderAll();
}

function renderAll(){siniestrosData.forEach(updateSiniestroNextRevision);renderDashboardLists();renderAllSiniestrosList();}

function renderDashboardLists(){
  const tasks = siniestrosData.flatMap(s => (s.observaciones||[]).filter(o => !o.completed && o.proximaRevision).map(o => ({...o, siniestro: s, type: 'task'})));
  const mediaciones = siniestrosData.flatMap(s => (s.mediaciones_list||[]).filter(m => !m.completed && m.fecha).map(m => ({...m, siniestro: s, type: 'mediacion', proximaRevision: m.fecha})));
  const allItems = [...tasks, ...mediaciones];

  const today=allItems.filter(t=>isToday(t.proximaRevision));
  const overdue=allItems.filter(t=>isPastDue(t.proximaRevision)).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision));
  const upcoming=allItems.filter(t=>getDaysDifference(t.proximaRevision)>0).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision));
  renderReviewList('todayReviews',today,'No hay eventos para hoy', 'today');
  renderReviewList('overdueReviews',overdue,'No hay eventos vencidos', 'overdue');
  renderReviewList('upcomingReviews',upcoming,'No hay pr√≥ximos eventos', 'upcoming');
}

function renderReviewList(id,items,empty, type){
  const c=document.getElementById(id);
  const listColor = (type === 'today' || type === 'overdue' || type === 'pending-reviews') ? 'var(--light-text)' : 'rgba(0,0,0,0.6)';
  if(!items.length){c.innerHTML=`<p style="color:${listColor};text-align:center;">${empty}</p>`;return;}
  c.innerHTML=items.map(item=>{
    let dateInfo = '';
    if (type === 'today') dateInfo = 'HOY';
    else if (type === 'overdue') dateInfo = `VENCIDA - ${formatDate(item.proximaRevision)}`;
    else dateInfo = `En ${getDaysDifference(item.proximaRevision)} d√≠as - ${formatDate(item.proximaRevision)}`;
    
    let label = '';
    let timeLabel = item.type === 'mediacion' ? formatTime(item.hora) : '';
    if(item.type === 'mediacion') label = 'MEDIACI√ìN:';
    const toggleFunc = `toggleCompleted(event,'${item.siniestro.id}','${item.id}', '${item.type}')`;

    const privateNoteHtml = item.type === 'task' && item.textoPrivado ? `<div class="review-obs-private">üîí ${item.textoPrivado}</div>` : '';

    return `<div class="review-item">
      <button class="complete-btn" onclick="${toggleFunc}">‚úî</button>
      <div class="review-item-content" onclick="showSiniestroModal('${item.siniestro.id}')">
        <div class="review-date">${dateInfo} ${timeLabel}</div>
        <div class="review-client">${item.siniestro.cliente}</div>
        <div class="review-obs"><b>${label}</b> ${item.texto}</div>
        ${privateNoteHtml}
      </div>
    </div>`;
  }).join('');
}

function renderAllSiniestrosList(){
  const sterm=document.getElementById('searchInput').value.toLowerCase();
  const estado=document.getElementById('estadoFilter').value;
  const filtrados=siniestrosData.filter(s=>{
    const searchString = [s.cliente, s.dni, s.celular, s.estado, s.aseguradoEn, s.contra, s.numeroReclamo, s.presupuesto, s.indemnizacion, s.honorarios, s.acuerdo, s.fechaPago, s.factura].filter(Boolean).join(' ').toLowerCase();
    const matchS=!sterm||searchString.includes(sterm);
    const matchE=!estado||s.estado===estado;
    return matchS&&matchE;
  }).sort((a,b)=>(a.fechaRevision||'9999').localeCompare(b.fechaRevision||'9999'));
  document.getElementById('allSiniestros').innerHTML=filtrados.length?filtrados.map(s=>{
    const pending=(s.observaciones||[]).some(o=>!o.completed&&o.proximaRevision);
    const cls=`review-item ${!pending?'completed':''} ${isToday(s.fechaRevision)?'today':''} ${isPastDue(s.fechaRevision)?'overdue':''}`;
    const lastWorkedObs = (s.observaciones || []).filter(o => o.fechaTrabajado).sort((a, b) => b.fechaTrabajado.localeCompare(a.fechaTrabajado))[0];
    const lastWorkedDate = lastWorkedObs ? lastWorkedObs.fechaTrabajado : null;
    return `<div class="${cls}" onclick="showSiniestroModal('${s.id}')">
      <div class="review-item-content">
        <div style="display:flex; justify-content: space-between; gap: 10px; flex-wrap: wrap;">
            <div class="review-date">Pr√≥x. Tarea: ${formatDate(s.fechaRevision)}</div>
            ${lastWorkedDate ? `<div class="review-date" style="color:#27ae60;">Trabajado: ${formatDate(lastWorkedDate)}</div>` : ''}
        </div>
        <div class="review-client">${s.cliente} - Reclamo: ${s.numeroReclamo||'S/N'}</div>
        <div class="review-obs">${s.observacion}</div>
      </div>
    </div>`;
  }).join(''):'<p>No se encontraron siniestros.</p>';
}

function showNewSiniestroModal(){document.getElementById('newSiniestroModal').classList.add('active')}
function showSiniestroSelectorModal(){
  const sel=document.getElementById('siniestroSelector');
  sel.innerHTML='<option value="">-- Seleccionar --</option>' + [...siniestrosData].sort((a,b)=>(a.cliente||'').localeCompare(b.cliente||''))
    .map(s=>`<option value="${s.id}">${getDisplayName(s)}</option>`).join('');
  document.getElementById('siniestroSelectorModal').classList.add('active');
}
function loadSiniestroInfo(){const id=document.getElementById('siniestroSelector').value;if(id){closeModal('siniestroSelectorModal');showSiniestroModal(id);}}
function closeModal(id){document.getElementById(id).classList.remove('active');editingSiniestroId=null;editingField=null;}

function showSiniestroModal(id){
  const s=siniestrosData.find(x=>x.id===id);if(!s)return;
  updateSiniestroNextRevision(s);
  const aseguradoras = [...new Set(siniestrosData.map(s => s.aseguradoEn).filter(Boolean))];
  const contras = [...new Set(siniestrosData.map(s => s.contra).filter(Boolean))];
  const datalistsHTML = `<datalist id="aseguradorasList">${aseguradoras.map(a => `<option value="${a}"></option>`).join('')}</datalist><datalist id="contrasList">${contras.map(c => `<option value="${c}"></option>`).join('')}</datalist>`;
  const html=`
    <span class="close" onclick="closeModal('siniestroInfoModal')">&times;</span><h2 style="margin-bottom:12px;">üè• ${s.cliente}</h2>
    <div class="info-grid">${Object.entries({cliente:'Cliente',dni:'DNI',celular:'Celular',estado:'Estado',aseguradoEn:'Asegurado En',contra:'Contra',numeroReclamo:'N¬∞ Reclamo',presupuesto:'Presupuesto',indemnizacion:'Indemnizaci√≥n',honorarios:'Honorarios',acuerdo:'Acuerdo',fechaPago:'Fecha Pago',factura:'Factura'}).map(([k,l])=>`<div class="info-item"><div class="info-label">${l}</div><div class="info-value editable-field" id="field-${k}" onclick="editField('${s.id}','${k}', this)">${/presupuesto|indemnizacion|honorarios/.test(k)?formatCurrency(s[k]):(s[k]||'S/D')}</div></div>`).join('')}<div class="info-item"><div class="info-label">Pr√≥xima Tarea</div><div class="info-value" style="color:#e74c3c;font-weight:700">${formatDate(s.fechaRevision)}</div></div></div>
    <div style="margin-top:18px;"><h4 style="margin-bottom:8px;font-size:.9em;">Historial de Eventos</h4><div id="history-list-${s.id}" style="max-height:230px;overflow:auto;padding-right:5px;">${renderHistoryList(s)}</div></div>
    <div style="display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px;">
        <div class="form-section">
            <h4>üìù Agregar Tarea</h4>
            <form onsubmit="addObservation(event,'${s.id}')">
                <div class="form-group"><label>Texto para el Cliente (P√∫blico)</label><textarea id="newObsText" rows="2"></textarea></div>
                <div class="form-group"><label>Notas Internas (Privadas)</label><textarea id="newObsTextPrivate" rows="2"></textarea></div>
                <div class="form-group"><label>Fecha de Revisi√≥n</label><input type="date" id="newRevisionDate" required></div>
                <button class="btn btn-success" type="submit">Guardar Tarea</button>
            </form>
        </div>
        <div class="form-section">
            <h4 onclick="toggleFormVisibility('mediacion-form-fields')" style="cursor: pointer; user-select: none;"><span class="toggle-icon">‚ûï</span> Agendar Mediaci√≥n</h4>
            <form id="mediacion-form-fields" onsubmit="addMediacion(event,'${s.id}')" style="display:none; margin-top:15px;">
                <div class="form-group"><label>Descripci√≥n</label><textarea id="newMediacionText" rows="2" required></textarea></div>
                <div class="form-group"><label>Fecha de Mediaci√≥n</label><input type="date" id="newMediacionDate" required></div>
                <div class="form-group"><label>Hora de Mediaci√≥n</label><input type="time" id="newMediacionTime" required></div>
                <button class="btn btn-success" type="submit">Guardar Mediaci√≥n</button>
            </form>
        </div>
    </div>
    <div class="action-buttons"><button class="btn btn-info" onclick="printFicha('${s.id}')">üñ®Ô∏è Ficha</button><button class="btn btn-info" onclick="printHistorial('${s.id}')">üñ®Ô∏è Historial</button><button class="btn btn-info" onclick="showDocumentModal('${s.id}')">üìÅ Documentos</button><button class="btn btn-danger" onclick="deleteSiniestro('${s.id}')">üóëÔ∏è Eliminar</button></div>${datalistsHTML}`;
  const m=document.getElementById('siniestroInfoModal');m.querySelector('.modal-content').innerHTML=html;m.classList.add('active');
}

function renderHistoryList(s){
    const tasks = (s.observaciones||[]).map(o => ({...o, type: 'task', date: o.proximaRevision}));
    const mediaciones = (s.mediaciones_list||[]).map(m => ({...m, type: 'mediacion', date: m.fecha}));
    const allEvents = [...tasks, ...mediaciones].sort((a,b) => (b.date||'').localeCompare(a.date||''));
    return allEvents.length ? allEvents.map(item => {
        let tagClass, tagText, itemClass, dateLabel, dateValue, deleteFunc, timeValue = '';
        if(item.type === 'task') {
            tagClass = 'tag-task'; tagText = 'TAREA'; itemClass = '';
            dateLabel = 'Creaci√≥n'; dateValue = item.fecha;
            deleteFunc = `deleteObs('${s.id}','${item.id}')`;
        } else {
            tagClass = 'tag-mediacion'; tagText = 'MEDIACI√ìN'; itemClass = 'history-item-mediacion';
            dateLabel = 'Fecha'; dateValue = item.fecha;
            timeValue = formatTime(item.hora);
            deleteFunc = `deleteMediacion('${s.id}','${item.id}')`;
        }
        
        const privateNoteHtml = item.type === 'task' && item.textoPrivado ? `
            <details class="private-note-details">
                <summary class="private-note-summary">üîí Ver Nota Privada</summary>
                <div class="private-note-content">${item.textoPrivado}</div>
            </details>
        ` : '';

        return `<div class="history-item ${itemClass} ${item.completed?'completed':''}" id="${item.type}-item-${item.id}">
            <div style="display:flex; align-items:center;"><div class="history-date">${dateLabel}: ${formatDate(dateValue)} ${timeValue}</div><span class="history-tag ${tagClass}">${tagText}</span></div>
            ${item.type === 'task' && item.fechaTrabajado ? `<div class="history-date" style="color: #27ae60;">Trabajado: ${formatDate(item.fechaTrabajado)}</div>` : ''}
            <div>${item.texto}</div>
            ${privateNoteHtml}
            ${item.type === 'task' ? `<div class="history-revision-date">Revisi√≥n: ${formatDate(item.proximaRevision)}</div>` : ''}
            <div style="margin-top:6px;display:flex;gap:6px;">
                ${item.type === 'task' ? `<button class="btn btn-sm" onclick="editObs('${s.id}','${item.id}')">Editar</button>` : ''}
                <button class="btn btn-danger btn-sm" onclick="${deleteFunc}">Eliminar</button>
            </div>
        </div>`;
    }).join('') : '<p style="font-size:.8em;">Sin eventos.</p>';
}

function editObs(sid,oid){
  const s=siniestrosData.find(x=>x.id===sid);
  const o=s.observaciones.find(k=>k.id===oid);
  const el=document.getElementById(`task-item-${o.id}`);
  el.innerHTML=`<div class="form-group"><label>Texto P√∫blico</label><textarea id="edit-obs-text-${o.id}" rows="2" style="font-size: 1rem; min-height: 60px;">${o.texto}</textarea></div><div class="form-group"><label>Notas Privadas</label><textarea id="edit-obs-private-${o.id}" rows="2" style="font-size: 1rem; min-height: 60px;">${o.textoPrivado || ''}</textarea></div><div class="form-group"><label>Fecha Revisi√≥n</label><input type="date" id="edit-obs-revision-${o.id}" value="${o.proximaRevision}"></div><button class="btn btn-success btn-sm" onclick="saveObs('${sid}','${o.id}')">Guardar</button><button class="btn btn-sm" onclick="showSiniestroModal('${sid}')">Cancelar</button>`;
}

function saveObs(sid,oid){
  const s=siniestrosData.find(x=>x.id===sid);
  const o=s.observaciones.find(k=>k.id===oid);
  o.texto=document.getElementById(`edit-obs-text-${o.id}`).value;
  o.textoPrivado=document.getElementById(`edit-obs-private-${o.id}`).value;
  o.proximaRevision=document.getElementById(`edit-obs-revision-${o.id}`).value;
  updateSiniestroNextRevision(s);saveData();renderAll();showSiniestroModal(sid);
}
function deleteObs(sid,oid){
  if(!confirm('¬øEliminar tarea?'))return;
  const s=siniestrosData.find(x=>x.id===sid);
  s.observaciones=s.observaciones.filter(o=>o.id!==oid);
  updateSiniestroNextRevision(s);saveData();renderAll();showSiniestroModal(sid);
}

function addMediacion(e,sid){
    e.preventDefault();
    const s=siniestrosData.find(x=>x.id===sid);
    const newMediacion = { id:generateId({}), fecha:document.getElementById('newMediacionDate').value, hora:document.getElementById('newMediacionTime').value, texto:document.getElementById('newMediacionText').value, completed:false, alertaMostrada: false };
    s.mediaciones_list.push(newMediacion);
    saveData(); renderAll(); showSiniestroModal(sid);
    addEventToGoogleCalendar(s, newMediacion);
}
function deleteMediacion(sid,mid){if(!confirm('¬øEliminar mediaci√≥n?'))return;const s=siniestrosData.find(x=>x.id===sid);s.mediaciones_list=s.mediaciones_list.filter(m=>m.id!==mid);saveData();renderAll();showSiniestroModal(sid);}

function editField(sid, field, element) {
    if (editingField) return; editingSiniestroId = sid; editingField = field;
    const s = siniestrosData.find(x => x.id === sid);
    const currentValue = s[field] || '';
    const input = document.createElement('input');
    input.type = /presupuesto|indemnizacion|honorarios|dni|celular/.test(field) ? 'number' : 'text';
    input.value = currentValue;
    input.style.cssText='width:100%;font-size:0.85em;border:1px solid #667eea;padding:2px;';
    if (field === 'aseguradoEn') input.setAttribute('list', 'aseguradorasList');
    if (field === 'contra') input.setAttribute('list', 'contrasList');
    const save = () => { s[editingField] = input.value; saveData(); editingSiniestroId = null; editingField = null; showSiniestroModal(sid); };
    input.addEventListener('blur', save);
    input.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); input.blur(); }});
    element.innerHTML = ''; element.appendChild(input); input.focus();
    const valLength = input.value.length; input.setSelectionRange(valLength, valLength);
}

function deleteSiniestro(id){if(!confirm('¬øEliminar siniestro y todo su historial?'))return;siniestrosData=siniestrosData.filter(s=>s.id!==id);saveData();renderAll();closeModal('siniestroInfoModal');}
function addObservation(e,sid){
    e.preventDefault();
    const s=siniestrosData.find(x=>x.id===sid);
    s.observaciones.push({
        id:generateId({}),
        fecha:todayYMD,
        texto:document.getElementById('newObsText').value,
        textoPrivado:document.getElementById('newObsTextPrivate').value,
        proximaRevision:document.getElementById('newRevisionDate').value,
        completed:false, 
        fechaTrabajado: todayYMD
    });
    updateSiniestroNextRevision(s);
    saveData();
    renderAll();
    showSiniestroModal(sid);
}

function exportToExcel(){
  const rows=siniestrosData.map(s=>{
    const hist=(s.observaciones||[]).map(o=>`${formatDate(o.fecha)} (Rev:${formatDate(o.proximaRevision)}) P√∫blico: ${o.texto} | Privado: ${o.textoPrivado || ''}`).join(' | ');
    const med=(s.mediaciones_list||[]).map(m=>`${formatDate(m.fecha)} ${formatTime(m.hora)}: ${m.texto}`).join(' | ');
    return {'Cliente':s.cliente,'DNI':s.dni,'Celular':s.celular,'Estado':s.estado,'Asegurado En':s.aseguradoEn,'Contra':s.contra,'N¬∞ Reclamo':s.numeroReclamo,'Pr√≥xima Revisi√≥n':formatDate(s.fechaRevision),'√öltima Tarea':s.observacion,'Presupuesto':s.presupuesto,'Indemnizaci√≥n':s.indemnizacion,'Honorarios':s.honorarios,'Historial Tareas':hist, 'Historial Mediaciones':med};
  });
  const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Siniestros');XLSX.writeFile(wb,`Siniestros_${todayYMD}.xlsx`);
}
function exportData(){const data=JSON.stringify(siniestrosData,null,2);const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type:'application/json'}));a.download=`siniestros_${todayYMD}.json`;a.click();}
function importData(){document.getElementById('importInput').click();}
function handleImport(ev){const f=ev.target.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const imp=JSON.parse(e.target.result);if(Array.isArray(imp)&&confirm(`Importar ${imp.length} registros? Esto sobreescribir√° los datos locales.`)){siniestrosData=sanitizeData(imp);saveData();renderAll();}}catch(err){alert('Error al importar el archivo.');}};r.readAsText(f);ev.target.value='';}

function printFicha(id){const s=siniestrosData.find(x=>x.id===id);if(!s)return;const html=`<div class="print-area"><h2>Ficha</h2><h3>${getDisplayName(s)}</h3><div>${Object.entries({cliente:'Cliente',dni:'DNI',celular:'Celular',estado:'Estado',aseguradoEn:'Asegurado En',contra:'Contra',numeroReclamo:'Reclamo',presupuesto:'Presupuesto',indemnizacion:'Indemnizaci√≥n',honorarios:'Honorarios',acuerdo:'Acuerdo',fechaPago:'Fecha Pago',factura:'Factura'}).map(([k,l])=>`<div style="margin:4px 0;"><b>${l}:</b> ${/presupuesto|indemnizacion|honorarios/.test(k)?formatCurrency(s[k]):(s[k]||'S/D')}</div>`).join('')}</div></div>`;const w=window.open('','_blank');w.document.write(`<html><head><title>Ficha</title><style>${document.querySelector('style').innerHTML}</style></head><body>${html}</body></html>`);w.document.close();setTimeout(()=>{w.print();w.close();},250);}
function printHistorial(id){const s=siniestrosData.find(x=>x.id===id);if(!s)return;const hist=renderHistoryList(s);const html=`<div class="print-area"><h2>Historial de Eventos</h2><h3>${getDisplayName(s)}</h3>${hist}</div>`;const w=window.open('','_blank');w.document.write(`<html><head><title>Historial</title><style>${document.querySelector('style').innerHTML}</style></head><body>${html}</body></html>`);w.document.close();setTimeout(()=>{w.print();w.close();},250);}

function mostrarAlertaDeMediaciones(mediacionesPorAlertar) {
    if (mediacionesPorAlertar.length === 0) return;
    const modal = document.getElementById('alertModal');
    if (modal.classList.contains('active')) return;
    const content = `<span class="close" onclick="closeModal('alertModal')">&times;</span><h2>‚ö†Ô∏è ¬°Alerta de Mediaciones para Hoy!</h2><div class="reviews-list" style="max-height: 60vh;">
        ${mediacionesPorAlertar.map(alert => `<div class="review-item today">
            <div class="review-item-content" style="width:100%;">
                <div class="review-date" style="font-size: 1.1em; color: var(--danger-color);">HOY - ${formatTime(alert.item.hora)}</div>
                <div class="review-client">${getDisplayName(alert.siniestro)}</div>
                <div class="review-obs"><strong>Mediaci√≥n:</strong> ${alert.item.texto}</div>
                <div style="text-align:center; margin-top: 15px; display:flex; flex-wrap:wrap; gap:8px; justify-content:center;">
                    <button class="btn btn-success btn-sm" onclick="marcarMediacionCompleta('${alert.siniestro.id}', '${alert.item.id}')">‚úÖ Hecho</button>
                    <button class="btn btn-warning btn-sm" onclick="showRescheduleModal('${alert.siniestro.id}', '${alert.item.id}')">üóìÔ∏è Posponer (Fecha)</button>
                    <button class="btn btn-info btn-sm" onclick="snoozeMediacion(30)">üïí 30 min</button>
                    <button class="btn btn-info btn-sm" onclick="snoozeMediacion(60)">üïí 1 hs</button>
                </div>
            </div>
        </div>`).join('')}</div>`;
    modal.querySelector('.modal-content').innerHTML = content;
    modal.classList.add('active');
    mediacionesPorAlertar.forEach(alerta => {
        const s = siniestrosData.find(s => s.id === alerta.siniestro.id);
        const m = s.mediaciones_list.find(m => m.id === alerta.item.id);
        if (m) m.alertaMostrada = true;
    });
    saveData();
}

function revisarMediacionesVencidasAlCargar() {
    const ahora = new Date();
    const horaActual = `${String(ahora.getHours()).padStart(2, '0')}:${String(ahora.getMinutes()).padStart(2, '0')}`;
    const mediacionesVencidas = siniestrosData.flatMap(s => (s.mediaciones_list || []).filter(m => isToday(m.fecha) && m.hora && m.hora <= horaActual && !m.completed && !m.alertaMostrada).map(m => ({ siniestro: s, item: m })));
    mostrarAlertaDeMediaciones(mediacionesVencidas);
}

function iniciarVigilanteDeMediaciones() {
    setInterval(() => {
        const ahora = new Date();
        const horaActual = `${String(ahora.getHours()).padStart(2, '0')}:${String(ahora.getMinutes()).padStart(2, '0')}`;
        const mediacionesPorAlertar = siniestrosData.flatMap(s => (s.mediaciones_list || []).filter(m => isToday(m.fecha) && m.hora && m.hora <= horaActual && !m.completed && !m.alertaMostrada).map(m => ({ siniestro: s, item: m })));
        if (mediacionesPorAlertar.length > 0) { mostrarAlertaDeMediaciones(mediacionesPorAlertar); }
    }, 60000);
}

function marcarMediacionCompleta(siniestroId, mediacionId) {
    const s = siniestrosData.find(x => x.id === siniestroId);
    if(s) { const m = s.mediaciones_list.find(y => y.id === mediacionId); if(m) m.completed = true; }
    saveData(); renderAll(); closeModal('alertModal');
}

function showRescheduleModal(siniestroId, mediacionId) {
    const modal = document.getElementById('rescheduleModal');
    const s = siniestrosData.find(x => x.id === siniestroId);
    const m = s.mediaciones_list.find(y => y.id === mediacionId);
    const content = `<span class="close" onclick="closeModal('rescheduleModal')">&times;</span><h3>Reprogramar Mediaci√≥n</h3><p><b>Caso:</b> ${s.cliente}</p><div class="form-group" style="margin-top:15px;"><label for="rescheduleDate">Nueva Fecha</label><input type="date" id="rescheduleDate" value="${m.fecha}" class="form-control"></div><div class="form-group"><label for="rescheduleTime">Nueva Hora</label><input type="time" id="rescheduleTime" value="${m.hora}" class="form-control"></div><div style="text-align:center; margin-top:20px;"><button class="btn btn-success" onclick="confirmReschedule('${siniestroId}', '${mediacionId}')">Confirmar</button></div>`;
    modal.querySelector('.modal-content').innerHTML = content;
    closeModal('alertModal');
    modal.classList.add('active');
}

function confirmReschedule(siniestroId, mediacionId) {
    const s = siniestrosData.find(x => x.id === siniestroId);
    if(s) {
        const m = s.mediaciones_list.find(y => y.id === mediacionId);
        if(m) {
            m.fecha = document.getElementById('rescheduleDate').value;
            m.hora = document.getElementById('rescheduleTime').value;
            m.alertaMostrada = false;
        }
    }
    saveData(); renderAll(); closeModal('rescheduleModal');
    updateDataStatus(`‚úÖ Mediaci√≥n reprogramada para el ${formatDate(document.getElementById('rescheduleDate').value)}`);
}

function snoozeMediacion(minutos) {
    closeModal('alertModal');
    updateDataStatus(`‚è∞ Recordatorio pospuesto por ${minutos} minutos.`);
    setTimeout(() => { revisarMediacionesVencidasAlCargar(); }, minutos * 60 * 1000);
}


document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('newSiniestroModal').querySelector('.modal-content').innerHTML=`
    <span class="close" onclick="closeModal('newSiniestroModal')">&times;</span><h2 style="margin-bottom:14px;">‚ûï Nuevo Siniestro</h2>
    <form id="newSiniestroForm"><div class="info-grid"><div class="form-group"><label>Cliente *</label><input required id="newCliente" type="text"></div><div class="form-group"><label>DNI</label><input id="newDni" type="number"></div><div class="form-group"><label>Celular</label><input id="newCelular" type="tel"></div><div class="form-group"><label>Estado *</label><select id="newEstado" required><option value="EJECUCION">Ejecuci√≥n</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA P">Finalizada P</option><option value="RECHAZADO">Rechazado</option><option value="DEMORADA">Demorada</option><option value="SIN INICIAR">Sin iniciar</option></select></div><div class="form-group"><label>Asegurado En</label><input id="newAseguradoEn"></div><div class="form-group"><label>Contra</label><input id="newContra"></div><div class="form-group"><label>N¬∞ Reclamo</label><input id="newNumeroReclamo"></div><div class="form-group"><label>Presupuesto</label><input id="newPresupuesto" type="number"></div></div><div class="form-group" style="margin-top:10px;"><label>Tarea Inicial</label><textarea id="newObservacion" rows="2"></textarea></div><div class="form-group"><label>Fecha Revisi√≥n Tarea</label><input id="newFechaRevision" type="date"></div><div style="text-align:center;margin-top:6px;"><button class="btn btn-success" type="submit">Guardar</button></div></form>`;
  document.getElementById('siniestroSelectorModal').querySelector('.modal-content').innerHTML=`<span class="close" onclick="closeModal('siniestroSelectorModal')">&times;</span><h2 style="margin-bottom:12px;">Seleccionar Siniestro</h2><div class="form-group"><select id="siniestroSelector" onchange="loadSiniestroInfo()"></select></div>`;
  
  document.getElementById('newSiniestroForm').addEventListener('submit',e=>{
    e.preventDefault();
    const n={id:generateId({}),cliente:document.getElementById('newCliente').value.toUpperCase(),dni:document.getElementById('newDni').value,celular:document.getElementById('newCelular').value,estado:document.getElementById('newEstado').value,aseguradoEn:document.getElementById('newAseguradoEn').value.toUpperCase(),contra:document.getElementById('newContra').value.toUpperCase(),numeroReclamo:document.getElementById('newNumeroReclamo').value,presupuesto:document.getElementById('newPresupuesto').value,observaciones:[], mediaciones_list:[]};
    const txt=document.getElementById('newObservacion').value;
    const rev=document.getElementById('newFechaRevision').value;
    if(txt&&rev){n.observaciones.push({id:generateId({}),fecha:todayYMD,texto:txt,proximaRevision:rev,completed:false, fechaTrabajado: todayYMD});}
    updateSiniestroNextRevision(n);siniestrosData.push(n);saveData();renderAll();closeModal('newSiniestroModal');e.target.reset();
  });

  loadData();
  renderAll();
  revisarMediacionesVencidasAlCargar();
  iniciarVigilanteDeMediaciones();
});
window.addEventListener('click',e=>{if(e.target.classList.contains('modal'))closeModal(e.target.id);});
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
<script>
const GD_CLIENT_ID='976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
const GD_API_KEY='AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
const GD_SCOPES='https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/calendar.events';
const GD_DATA_FILE='datos_planilla_siniestros.json';
const GD_DOCS_ROOT='Planilla_Siniestros_Documentos';

let tokenClient;
let gapiReady = false, gisReady = false;
let gdDataFileId = null, gdDocsFolderId = null;

function gapiLoaded() { gapi.load('client', initializeGapiClient); }

async function initializeGapiClient() {
    try {
        await gapi.client.init({
            apiKey: GD_API_KEY,
            discoveryDocs: [
                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
            ]
        });
        gapiReady = true;
        maybeEnableButtons();
    } catch (e) { console.error("Error GAPI client init:", e); updateDataStatus('‚ùå Error al inicializar APIs de Google.', true); }
}

function gisLoaded() {
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: GD_CLIENT_ID,
            scope: GD_SCOPES,
            callback: tokenResponseCallback,
        });
        gisReady = true;
        maybeEnableButtons();
    } catch(e) { console.error("Error GIS client init:", e); updateDataStatus('‚ùå Error al inicializar autenticaci√≥n de Google.', true); }
}

function maybeEnableButtons() {
    if (gapiReady && gisReady) {
        document.getElementById('connectDriveBtn').onclick = handleAuthClick;
    }
}

function handleAuthClick() {
    if (tokenClient) {
        tokenClient.requestAccessToken({ prompt: 'consent' });
    }
}

async function tokenResponseCallback(resp) {
    if (resp.error) {
        updateDataStatus('‚ùå Error de autenticaci√≥n. Verifique que las pop-ups no est√©n bloqueadas.', true);
        return;
    }
    try {
        gapi.client.setToken({ access_token: resp.access_token });
        document.getElementById('connectDriveBtn').style.display = 'none';
        const saveBtn = document.getElementById('saveToDriveBtn');
        const loadBtn = document.getElementById('loadFromDriveBtn');
        if (saveBtn) {
            saveBtn.style.display = 'inline-block';
            saveBtn.onclick = saveDataToDrive;
        }
        if (loadBtn) {
            loadBtn.style.display = 'inline-block';
            loadBtn.onclick = loadDataFromDrive;
        }
        updateDataStatus('‚úÖ Conectado. Buscando archivo de respaldo...', false);
        await findDataFile();
    } catch (e) {
        console.error("Error en callback:", e);
        updateDataStatus('‚ùå Ocurri√≥ un error despu√©s de conectar.', true);
    }
}

async function addEventToGoogleCalendar(siniestro, mediacion) {
    if (!gapi.client.getToken()?.access_token) { updateDataStatus('‚ö†Ô∏è No conectado a Google. No se puede crear el evento.', true); return; }
    updateDataStatus('üóìÔ∏è Creando evento en Google Calendar...', false);
    try {
        const eventStartTime = new Date(`${mediacion.fecha}T${mediacion.hora}:00`);
        const eventEndTime = new Date(eventStartTime.getTime() + 60 * 60 * 1000);
        const event = {
            'summary': `Mediaci√≥n: ${siniestro.cliente}`,
            'description': `Caso: ${siniestro.cliente} vs ${siniestro.contra || 'N/A'}\nN¬∞ Reclamo: ${siniestro.numeroReclamo || 'S/N'}\n\nDescripci√≥n: ${mediacion.texto}`,
            'start': { 'dateTime': eventStartTime.toISOString(), 'timeZone': 'America/Argentina/Buenos_Aires' },
            'end': { 'dateTime': eventEndTime.toISOString(), 'timeZone': 'America/Argentina/Buenos_Aires' },
        };
        await gapi.client.calendar.events.insert({ 'calendarId': 'primary', 'resource': event });
        updateDataStatus('‚úÖ Evento creado en Google Calendar.', false);
    } catch(e) {
        console.error("Error creando evento:", e);
        updateDataStatus(`‚ùå Error al crear evento: ${e.result?.error?.message || 'Error desconocido.'}`, true);
    }
}

async function findDataFile(){
  updateDataStatus('üîé Buscando archivo de Drive...', false);
  try {
    const response = await gapi.client.drive.files.list({ q: `name='${GD_DATA_FILE}' and trashed=false`, fields: 'files(id, name)', spaces: 'drive' });
    if (response.result.files && response.result.files.length > 0) {
        gdDataFileId = response.result.files[0].id;
        updateDataStatus('‚úÖ Conexi√≥n exitosa. Archivo de respaldo encontrado.', false);
    } else {
        updateDataStatus('‚ö†Ô∏è Conexi√≥n exitosa. No existe archivo (se crear√° al guardar).', false);
    }
  } catch(e) {
      console.error("Error buscando archivo:", e);
      updateDataStatus(`‚ùå Error buscando archivo: ${e.result?.error?.message}`, true);
  }
}

async function saveDataToDrive() {
    if (!gapi.client.getToken()?.access_token) return alert('No est√° conectado a Google.');
    if (!confirm('¬øGuardar datos en Drive?')) return;
    updateDataStatus('üíæ Guardando en Drive...', false);
    
    const content = JSON.stringify(siniestrosData, null, 2);
    const metadata = { name: GD_DATA_FILE, mimeType: 'application/json' };

    try {
        let request;
        if (gdDataFileId) {
            request = gapi.client.request({
                path: `/upload/drive/v3/files/${gdDataFileId}`,
                method: 'PATCH',
                params: { uploadType: 'media' },
                body: content
            });
        } else {
             request = gapi.client.drive.files.create({
                resource: metadata,
                media: { mimeType: 'application/json', body: content },
                fields: 'id'
            });
        }
        const response = await request;
        if (response.result.id) gdDataFileId = response.result.id;
        updateDataStatus('‚úÖ Guardado en Drive con √©xito.', false);
    } catch (e) {
        console.error('Error en saveDataToDrive:', e);
        updateDataStatus(`‚ùå Error al guardar: ${e.result?.error?.message || e.message}`, true);
    }
}

async function loadDataFromDrive(){
  if (!gapi.client.getToken()?.access_token) return alert('No est√° conectado a Google.');
  if(!gdDataFileId){ alert('No se ha encontrado un archivo de respaldo. Guarde una copia primero.'); return; }
  if(!confirm('¬øReemplazar los datos locales con la copia de seguridad?')) return;
  updateDataStatus('üì• Cargando desde Drive...', false);
  try {
    const response = await gapi.client.drive.files.get({ fileId: gdDataFileId, alt: 'media' });
    const imported = JSON.parse(response.body);
    if (!Array.isArray(imported)) throw new Error('Formato de archivo inv√°lido.');
    siniestrosData = sanitizeData(imported);
    saveData();
    renderAll();
    updateDataStatus('‚úÖ Datos cargados desde Drive.', false);
  } catch(e) {
    console.error("Error cargando datos:", e);
    updateDataStatus(`‚ùå Error al cargar: ${e.result?.error?.message || e.message}`, true);
  }
}

async function showDocumentModal(sid) {
    if (!gapi.client.getToken()?.access_token) return alert('Conecta con Google Drive primero.');
    currentSiniestroIdForDocs = sid;
    localFilesForUpload = [];
    const s = siniestrosData.find(x => x.id === sid); if (!s) return;
    document.getElementById('documentModalTitle').innerText = `Documentos: ${getDisplayName(s)}`;
    document.getElementById('documentModal').classList.add('active');
    renderLocalFileList(); await renderDriveFileList();
    const area = document.getElementById('uploadArea');
    ['dragenter','dragover','dragleave','drop'].forEach(eN=>area.addEventListener(eN,e=>{e.preventDefault();e.stopPropagation();},false));
    ['dragenter','dragover'].forEach(eN=>area.addEventListener(eN,()=>area.style.background='#eef5ff',false));
    ['dragleave','drop'].forEach(eN=>area.addEventListener(eN,()=>area.style.background='#f9f9f9',false));
    area.addEventListener('drop', e=>processFiles(e.dataTransfer.files), false);
}

function processFiles(files) { for (const file of files) { const reader = new FileReader(); reader.onload = e => { localFilesForUpload.push({id:'local_'+Date.now(), name: file.name, type: file.type||'application/octet-stream', size: file.size, dataUrl: e.target.result}); renderLocalFileList(); }; reader.readAsDataURL(file); } }
function renderLocalFileList() { const listEl = document.getElementById('localDocumentList'); listEl.innerHTML = localFilesForUpload.length ? '<h4>Archivos listos para subir:</h4>' + localFilesForUpload.map(f => `<li><span>${f.name}</span><button class="btn btn-danger btn-sm" onclick="removeLocalFile('${f.id}')">X</button></li>`).join('') : '<p style="font-style: italic; color: #666; text-align:center;">No hay archivos nuevos para subir.</p>'; }
function removeLocalFile(id) { localFilesForUpload = localFilesForUpload.filter(f => f.id !== id); renderLocalFileList(); }
function triggerLocalFileUpload() { const up=document.getElementById('documentUploadInput'); up.onchange = e=>processFiles(e.target.files); up.value=''; up.click(); }
async function saveDocumentsToDrive() { if (localFilesForUpload.length === 0) return alert("No hay archivos nuevos para guardar."); document.getElementById('driveDocumentList').innerHTML += '<div class="spinner"></div>'; const s=siniestrosData.find(x=>x.id===currentSiniestroIdForDocs); const folderName=`${s.cliente.replace(/[\/\\?%*:|"<>]/g,'-')} - Reclamo ${s.numeroReclamo||s.id.slice(-4)}`; try { if (!gdDocsFolderId) gdDocsFolderId = await getOrCreateFolder(GD_DOCS_ROOT); const clientFolder = await getOrCreateFolder(folderName, gdDocsFolderId); for (const file of localFilesForUpload) { await uploadDocumentContent(file.dataUrl, file.name, file.type, clientFolder); } localFilesForUpload = []; renderLocalFileList(); await renderDriveFileList(); } catch (e) { alert("Error al subir los archivos."); await renderDriveFileList(); } }
async function renderDriveFileList() { const listEl = document.getElementById('driveDocumentList'); listEl.innerHTML = '<div class="spinner"></div>'; try { const s=siniestrosData.find(x=>x.id===currentSiniestroIdForDocs); if (!gdDocsFolderId) gdDocsFolderId = await getOrCreateFolder(GD_DOCS_ROOT); const folderName=`${s.cliente.replace(/[\/\\?%*:|"<>]/g,'-')} - Reclamo ${s.numeroReclamo||s.id.slice(-4)}`; const clientFolder = await getOrCreateFolder(folderName, gdDocsFolderId); const r = await gapi.client.drive.files.list({ q: `'${clientFolder}' in parents and trashed=false`, fields: 'files(id,name,webViewLink)' }); listEl.innerHTML = r.result.files.length ? r.result.files.map(f => `<li><a href="${f.webViewLink}" target="_blank">${f.name}</a><button class="btn btn-danger btn-sm" onclick="deleteDocument('${f.id}')">X</button></li>`).join('') : '<li>Sin documentos en Drive.</li>'; } catch (e) { listEl.innerHTML = '<li>Error al cargar documentos.</li>'; } }
async function deleteDocument(fid) { if (confirm('¬øEliminar documento de Drive?')) try { await gapi.client.drive.files.delete({ fileId: fid }); await renderDriveFileList(); } catch (e) { alert('Error al eliminar'); } }
async function getOrCreateFolder(name, parentId = null) { let q=`mimeType='application/vnd.google-apps.folder' and name='${name}' and trashed=false`; if (parentId) q+=` and '${parentId}' in parents`; const r = await gapi.client.drive.files.list({ q, fields: 'files(id)' }); if (r.result.files.length) return r.result.files[0].id; const meta = { name, mimeType: 'application/vnd.google-apps.folder', ...(parentId && { parents: [parentId] }) }; const newF = await gapi.client.drive.files.create({ resource: meta, fields: 'id' }); return newF.result.id; }
async function uploadDocumentContent(content,fileName,mimeType,parentId){ const boundary = '-------314159265358979323846'; const metadata = { name: fileName, mimeType: mimeType, ...(parentId && { parents: [parentId] }) }; const base64Data = content.split(',')[1]; const body = [ `--${boundary}`, 'Content-Type: application/json; charset=UTF-8', '', JSON.stringify(metadata), `--${boundary}`, `Content-Type: ${mimeType}`, 'Content-Transfer-Encoding: base64', '', base64Data, `--${boundary}--` ].join('\r\n'); const request = await gapi.client.request({ path: '/upload/drive/v3/files', method: 'POST', params: { uploadType: 'multipart' }, headers: { 'Content-Type': `multipart/related; boundary="${boundary}"` }, body: body }); return request.result.id; }
</script>
</body>
</html>
