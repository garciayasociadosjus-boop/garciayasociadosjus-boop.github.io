<!DOCTYPE html>
<html lang="es-AR">
<head>
<meta charset="UTF-8">
<title>Planilla de Siniestros - Garc√≠a & Asociados</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
<style>
:root {
    --primary-color: #2980b9;
    --secondary-color: #3498db;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --success-color: #2ecc71;
    --light-bg: #ecf0f1;
    --dark-text: #2c3e50;
    --light-text: #ffffff;
    --border-radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
.header{background:linear-gradient(135deg,#020c24 0%,#081e4b 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:2.4em;margin-bottom:8px}
.header-clock-container{display:flex;align-items:center;justify-content:center;gap:20px;margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,.2)}
.analog-clock{width:60px;height:60px;background:rgba(255,255,255,.1);border-radius:50%;border:2px solid rgba(255,255,255,.5);position:relative;flex-shrink:0}
.analog-clock .hand{width:50%;height:2px;background:var(--light-text);position:absolute;top:50%;transform-origin:100%;transform:rotate(90deg);transition:none}
.analog-clock .hour-hand{width:35%;left:15%;background:var(--secondary-color);height:3px}
.analog-clock .min-hand{height:2px}
.analog-clock .second-hand{width:45%;left:5%;background:var(--danger-color);height:1px}
#digital-clock{font-size:1em;opacity:.9;font-weight:500;letter-spacing:.5px;text-align:left}
.main-content{padding:30px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;margin-bottom:40px}
.card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 8px 25px rgba(0,0,0,.1);border:1px solid #e0e0e0;transition:.3s}
.card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.card h3{color:#2c3e50;margin-bottom:18px;font-size:1.2em;display:flex;gap:8px;align-items:center}
.today-reviews{background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff}
.overdue-reviews{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff}
.pending-reviews{background:linear-gradient(135deg,#feca57,#ff9ff3);color:#fff}
.btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:11px 22px;border-radius:8px;cursor:pointer;font-size:.95em;margin:5px;transition:.25s}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(102,126,234,.4)}
.btn-success{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.btn-info{background:linear-gradient(135deg,#3498db,#2980b9)}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
.btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22)}
.btn-sm{padding:6px 14px;font-size:.8em}
.data-status{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;font-size:.9em}
.filter-bar{background:#f8f9fa;padding:18px;border-radius:8px;margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
.form-group{margin-bottom:10px}
.form-group label{display:block;font-weight:600;margin-bottom:6px;color:#2c3e50;font-size:.85em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:.9em}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.reviews-list{max-height:400px;overflow:auto}
.review-item{background:#f8f9fa;border-left:4px solid #667eea;padding:14px;margin-bottom:9px;border-radius:0 8px 8px 0;display:flex;gap:10px;align-items:center;cursor:pointer;font-size:.82em}
.review-item.completed{background:#f2fdf5;border-left-color:#2ecc71;opacity:.85}
.review-item.today{border-left-color:#e74c3c}
.review-item.overdue{border-left-color:#f39c12}
.review-item:hover{background:#eef4ff}
.review-date{font-weight:600;color:#2c3e50}
.review-client{color:#667eea;font-weight:500;margin:4px 0}
.review-obs{font-style:italic;color:#555}
.review-obs-private{font-size:.9em;color:#8e44ad;font-style:italic;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px}
.complete-btn{background:#e0e0e0;border:none;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:14px}
.complete-btn:hover{background:#c7c7c7}
.review-item.completed .complete-btn{background:#2ecc71;color:#fff}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);z-index:1000}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:#fff;border-radius:14px;padding:28px;max-width:900px;width:95%;max-height:90vh;overflow:auto}
#alertModal .modal-content{border-top:10px solid var(--danger-color)}
#alertModal h2{color:var(--danger-color);text-align:center;margin-bottom:20px}
.close{float:right;font-size:26px;font-weight:700;color:#999;cursor:pointer;margin-top:-8px}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px}
.info-item{background:#fff;padding:10px;border-left:3px solid #667eea;border-radius:6px}
.info-label{font-size:.65em;text-transform:uppercase;color:#666;font-weight:600;letter-spacing:.5px}
.info-value{font-size:.85em;font-weight:500;color:#2c3e50;margin-top:2px;word-break:break-word}
.editable-field{cursor:pointer;padding:2px 4px;margin:-2px -4px}
.editable-field:hover{background:#eef5ff;border-radius:4px}
.history-item{background:#fff;border:1px solid #e0e0e0;border-left:4px solid #667eea;border-radius:6px;padding:12px;margin-bottom:10px;font-size:.9rem}
.history-item.completed{opacity:.6}
.history-date{font-size:.9em;font-weight:600;color:#667eea;margin-bottom:4px}
.history-revision-date{color:#c0392b;font-size:.85em;margin-top:4px}
.private-note-details{margin-top:10px}
.private-note-summary{cursor:pointer;font-weight:600;color:#8e44ad;-webkit-user-select:none;user-select:none;font-size:.9em}
.private-note-summary::-webkit-details-marker{display:none}
.private-note-summary:before{content:'‚ûï';display:inline-block;margin-right:8px}
.private-note-details[open] .private-note-summary:before{content:'‚ûñ'}
.private-note-content{background:#fdf5e6;border-left:3px solid #f39c12;padding:10px;margin-top:8px;border-radius:5px;font-style:italic;color:#666}
.history-item-mediacion{border-left-color:#1abc9c}
.history-tag{font-size:.8em;color:#fff;padding:2px 8px;border-radius:10px;margin-left:auto;font-weight:500;display:inline-block}
.tag-task{background-color:var(--secondary-color)}
.tag-mediacion{background-color:#1abc9c}
.form-section{background:#f8f9fa;padding:16px;border:1px solid #e0e0e0;border-radius:10px;margin-top:16px}
.action-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:18px}
.progress-bar-container{width:80%;margin:20px auto;height:20px;background-color:#ecf0f1;border-radius:10px;overflow:hidden}
.progress-bar{width:0;height:100%;background:linear-gradient(90deg,var(--secondary-color),var(--primary-color));transition:width .2s ease-out}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
@media (max-width:780px){.reviews-list{max-height:300px}.action-buttons .btn{flex:1 1 100%}}
@media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%;padding:20px}.btn,.no-print{display:none!important}#generatedLetterText{white-space:pre-wrap}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üö¶ Planilla de Siniestros</h1>
    <p>Garc√≠a & Asociados</p>
    <div class="header-clock-container">
        <div class="analog-clock">
            <div class="hand hour-hand"></div>
            <div class="hand min-hand"></div>
            <div class="hand second-hand"></div>
        </div>
        <div id="digital-clock"></div>
    </div>
  </div>

  <div class="main-content">
    <div id="dataStatus" class="data-status">Cargando datos...</div>
    <div id="driveStatus" class="data-status" style="display:none;"></div>

    <div class="dashboard">
      <div class="card today-reviews"><h3>Eventos de Hoy</h3><div class="reviews-list" id="todayReviews"></div></div>
      <div class="card overdue-reviews"><h3>Eventos Vencidos</h3><div class="reviews-list" id="overdueReviews"></div></div>
      <div class="card pending-reviews"><h3>Pr√≥ximos Eventos</h3><div class="reviews-list" id="upcomingReviews"></div></div>
    </div>

    <div style="text-align:center;margin-bottom:26px;">
      <button class="btn btn-success" onclick="showNewSiniestroModal()">‚ûï Agregar Siniestro</button>
      <button class="btn" onclick="showSiniestroSelectorModal()">üëÅÔ∏è Ver/Editar Siniestro</button>
      <button class="btn" onclick="exportToExcel()">üìä Exportar Excel</button>
      <button class="btn" onclick="exportData()">üíæ Exportar JSON</button>
      <button class="btn btn-warning" onclick="importData()">üì• Importar JSON</button>
    </div>

    <div style="text-align:center;border-top:1px solid #ddd;padding-top:18px;margin-bottom:25px;">
      <button id="connectDriveBtn" class="btn">üîó Conectar a Drive & Calendar</button>
      <button id="saveToDriveBtn" class="btn btn-success" style="display:none;">üì§ Guardar en Drive</button>
      <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;">üì• Cargar de Drive</button>
    </div>

    <div class="filter-bar">
      <div class="form-group"><label>B√∫squeda General</label><input type="text" id="searchInput" placeholder="Cliente, DNI, reclamo..." onkeyup="renderAllSiniestrosList()"></div>
      <div class="form-group"><label>Estado</label><select id="estadoFilter" onchange="renderAllSiniestrosList()"><option value="">Todos</option><option value="RECHAZADO">Rechazado</option><option value="SIN INICIAR">Sin iniciar</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA P">Finalizada P</option><option value="EJECUCION">Ejecuci√≥n</option><option value="DEMORADA">Demorada</option></select></div>
    </div>

    <div class="card">
      <h3>üìã Todos los Siniestros</h3>
      <div id="allSiniestros" class="reviews-list" style="max-height:580px;"></div>
    </div>
  </div>
</div>

<input type="file" id="importInput" accept=".json" style="display:none" onchange="handleImport(event)">
<input type="file" id="documentUploadInput" style="display:none" multiple>

<div id="newSiniestroModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroSelectorModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroInfoModal" class="modal"><div class="modal-content"></div></div>
<div id="alertModal" class="modal"><div class="modal-content"></div></div>
<div id="rescheduleModal" class="modal"><div class="modal-content"></div></div>
<div id="letterGenerationModal" class="modal"><div class="modal-content"></div></div>
<div id="documentModal" class="modal"><div class="modal-content"></div></div>

<script>
let siniestrosData=[];
let editingSiniestroId=null,editingField=null;

// --- URL DEL SERVIDOR EN RENDER ---
const API_BASE_URL = 'https://portal-backend-v2.onrender.com';
// ------------------------------------

function saveData(){localStorage.setItem('planilla_siniestros_data',JSON.stringify(siniestrosData));updateDataStatus('‚úÖ Datos guardados localmente');}
function loadData(){
  const saved=localStorage.getItem('planilla_siniestros_data');
  siniestrosData = saved ? JSON.parse(saved) : [];
  siniestrosData=sanitizeData(siniestrosData);
  updateDataStatus(saved?'‚úÖ Datos locales cargados':'üìã Planilla lista para usar.');
}
function sanitizeData(data){
  (data||[]).forEach(s=>{
    s.id=s.id||generateId(s);
    s.observaciones=Array.isArray(s.observaciones)?s.observaciones:[];
    s.mediaciones_list=Array.isArray(s.mediaciones_list)?s.mediaciones_list:[];
  });
  return data;
}
function updateDataStatus(msg,err=false){
  document.getElementById('dataStatus').textContent=msg;
}
function getTodayYMD(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function formatDate(d){if(!d) return 'No definida';const [y,m,day]=d.split('-');return `${day}/${m}/${y}`;}
function generateId(it){return `EVT_${(it.cliente||'S').slice(0,3).toUpperCase()}_${Date.now()}_${Math.floor(Math.random()*1000)}`}
function getDisplayName(s){return `${s.cliente||'S/N'} - Reclamo: ${s.numeroReclamo||'S/N'} (${s.estado||'S/E'})`}

// --- L√≥gica principal de la aplicaci√≥n ---

function renderAllSiniestrosList(){
  const container = document.getElementById('allSiniestros');
  container.innerHTML = siniestrosData.length ? siniestrosData.map(s => `
    <div class="review-item" onclick="showSiniestroModal('${s.id}')">
        <div>
            <div class="review-client">${s.cliente} - Reclamo: ${s.numeroReclamo||'S/N'}</div>
            <div class="review-obs">Pr√≥xima tarea: ${s.observacion || 'Ninguna'}</div>
        </div>
    </div>
  `).join('') : '<p>No hay siniestros cargados.</p>';
}

function showSiniestroModal(id){
  const s=siniestrosData.find(x=>x.id===id);
  if(!s)return;
  const modalContent = document.getElementById('siniestroInfoModal').querySelector('.modal-content');
  modalContent.innerHTML = `
    <span class="close" onclick="closeModal('siniestroInfoModal')">&times;</span><h2>üè• ${s.cliente}</h2>
    <div class="info-grid">
        ${Object.entries({cliente:'Cliente',dni:'DNI',celular:'Celular',estado:'Estado',aseguradoEn:'Asegurado En',contra:'Contra',numeroReclamo:'N¬∞ Reclamo',presupuesto:'Presupuesto'}).map(([k,l])=>`<div class="info-item"><div class="info-label">${l}</div><div class="info-value">${s[k] || 'S/D'}</div></div>`).join('')}
    </div>
    <div class="action-buttons">
        <button class="btn" onclick="startLetterGeneration('${s.id}')">‚úâÔ∏è Generar Carta Patrocinio</button>
    </div>
  `;
  document.getElementById('siniestroInfoModal').classList.add('active');
}

function showNewSiniestroModal() {
    const modalContent = document.getElementById('newSiniestroModal').querySelector('.modal-content');
    modalContent.innerHTML = `
        <span class="close" onclick="closeModal('newSiniestroModal')">&times;</span>
        <h2>‚ûï Nuevo Siniestro</h2>
        <form id="newSiniestroForm">
            <div class="info-grid">
                <div class="form-group"><label>Cliente *</label><input id="newCliente" type="text" required></div>
                <div class="form-group"><label>DNI</label><input id="newDni" type="number"></div>
                <div class="form-group"><label>Asegurado En</label><input id="newAseguradoEn"></div>
                <div class="form-group"><label>Contra (Aseguradora del Tercero)</label><input id="newContra"></div>
                <div class="form-group"><label>N¬∞ Reclamo</label><input id="newNumeroReclamo"></div>
                <div class="form-group"><label>Presupuesto</label><input id="newPresupuesto" type="number"></div>
            </div>
            <div style="text-align:center;margin-top:20px;"><button class="btn btn-success" type="submit">Guardar</button></div>
        </form>
    `;
    document.getElementById('newSiniestroModal').classList.add('active');
    document.getElementById('newSiniestroForm').addEventListener('submit', e => {
        e.preventDefault();
        const newSiniestro = {
            id: generateId({}),
            cliente: document.getElementById('newCliente').value,
            dni: document.getElementById('newDni').value,
            aseguradoEn: document.getElementById('newAseguradoEn').value,
            contra: document.getElementById('newContra').value,
            numeroReclamo: document.getElementById('newNumeroReclamo').value,
            presupuesto: document.getElementById('newPresupuesto').value,
            observaciones: []
        };
        siniestrosData.push(newSiniestro);
        saveData();
        renderAllSiniestrosList();
        closeModal('newSiniestroModal');
    });
}

function showSiniestroSelectorModal() {
    const modalContent = document.getElementById('siniestroSelectorModal').querySelector('.modal-content');
    let optionsHTML = '<option value="">-- Seleccione un siniestro --</option>';
    siniestrosData.forEach(s => {
        optionsHTML += `<option value="${s.id}">${getDisplayName(s)}</option>`;
    });
    modalContent.innerHTML = `
        <span class="close" onclick="closeModal('siniestroSelectorModal')">&times;</span>
        <h2>üëÅÔ∏è Ver/Editar Siniestro</h2>
        <div class="form-group">
            <select id="siniestroSelector">${optionsHTML}</select>
        </div>
    `;
    document.getElementById('siniestroSelector').addEventListener('change', (e) => {
        if (e.target.value) {
            showSiniestroModal(e.target.value);
            closeModal('siniestroSelectorModal');
        }
    });
    document.getElementById('siniestroSelectorModal').classList.add('active');
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }

// --- FUNCIONES PARA CARTA DE PATROCINIO ---

function startLetterGeneration(siniestroId) {
    const s = siniestrosData.find(x => x.id === siniestroId);
    if (!s) { alert("Error: Siniestro no encontrado para generar la carta."); return; }
    
    const modal = document.getElementById('letterGenerationModal');
    const today = new Date().toISOString().split('T')[0];
    const formHTML = `
        <span class="close" onclick="closeModal('letterGenerationModal')">&times;</span>
        <h2>‚úâÔ∏è Generar Carta de Patrocinio</h2>
        <form id="letterForm" onsubmit="processLetterData(event, '${siniestroId}')">
            <div class="info-grid">
                <div class="form-group"><label>Lugar de Emisi√≥n</label><input type="text" id="letterLugar" value="Bernal" required></div>
                <div class="form-group"><label>Aseguradora del TERCERO</label><input type="text" id="letterDestinatario" value="${s.contra || ''}" required></div>
                <div class="form-group"><label>Domicilio Aseguradora</label><input type="text" id="letterDestinatarioDom" required></div>
                <div class="form-group"><label>N¬∞ P√≥liza de TU CLIENTE</label><input type="text" id="letterPolizaCliente" required></div>
                <div class="form-group"><label>Aseguradora de TU CLIENTE</label><input type="text" id="letterAseguradoraCliente" value="${s.aseguradoEn || ''}" required></div>
                <div class="form-group"><label>Fecha del Siniestro</label><input type="date" id="letterFechaSiniestro" value="${today}" required></div>
                <div class="form-group"><label>Hora del Siniestro</label><input type="time" id="letterHoraSiniestro" required></div>
                <div class="form-group"><label>Lugar del Siniestro</label><input type="text" id="letterLugarSiniestro" required></div>
                <div class="form-group"><label>Veh√≠culo de TU CLIENTE</label><input type="text" id="letterVehiculoCliente" required></div>
                <div class="form-group"><label>Partes da√±adas (Cliente)</label><input type="text" id="letterPartesDanadas" required></div>
                <div class="form-group"><label>Nombre del TERCERO</label><input type="text" id="letterNombreTercero" required></div>
                <div class="form-group"><label>DNI del TERCERO (Opcional)</label><input type="text" id="letterDniTercero"></div>
            </div>
            <div class="form-section"><label>Relato de los hechos</label><textarea id="letterRelato" rows="4" required></textarea></div>
            <div class="form-section"><label>Infracciones del tercero</label><textarea id="letterInfracciones" rows="3" required></textarea></div>
            <div class="form-section"><input type="checkbox" id="checkLesiones" onchange="toggleLesiones(this.checked)"> <label for="checkLesiones">¬øHubo Lesiones?</label>
                <div id="lesionesFields" style="display:none;"><label>Descripci√≥n de lesiones</label><textarea id="letterLesionesDesc" rows="2"></textarea><label>Monto por Lesiones</label><input type="number" id="letterLesionesMonto"></div>
            </div>
            <div style="text-align:center;margin-top:20px;"><button class="btn btn-success" type="submit">ü§ñ Generar con IA</button></div>
        </form>
    `;
    modal.querySelector('.modal-content').innerHTML = formHTML;
    modal.classList.add('active');
}

function toggleLesiones(checked) {
    document.getElementById('lesionesFields').style.display = checked ? 'block' : 'none';
}

async function processLetterData(event, siniestroId) {
    event.preventDefault();
    const s = siniestrosData.find(x => x.id === siniestroId);
    if (!s) { alert("Error: No se pudo encontrar el siniestro para procesar."); return; }

    const modalContent = document.getElementById('letterGenerationModal').querySelector('.modal-content');
    modalContent.innerHTML = `<h2>üß† Redactando con IA... Espere por favor.</h2>`;

    const checkLesionesEl = document.getElementById('checkLesiones');
    const hayLesiones = checkLesionesEl ? checkLesionesEl.checked : false;
    const montoLesionesEl = document.getElementById('letterLesionesMonto');
    const montoLesiones = montoLesionesEl ? parseFloat(montoLesionesEl.value) || 0 : 0;
    const montoMateriales = parseFloat(s.presupuesto) || 0;

    const data = {
        siniestro: s,
        lugarEmision: document.getElementById('letterLugar').value,
        destinatario: document.getElementById('letterDestinatario').value,
        destinatarioDomicilio: document.getElementById('letterDestinatarioDom').value,
        polizaCliente: document.getElementById('letterPolizaCliente').value,
        aseguradoraCliente: document.getElementById('letterAseguradoraCliente').value,
        fechaSiniestro: formatDate(document.getElementById('letterFechaSiniestro').value),
        horaSiniestro: document.getElementById('letterHoraSiniestro').value,
        lugarSiniestro: document.getElementById('letterLugarSiniestro').value,
        vehiculoCliente: document.getElementById('letterVehiculoCliente').value,
        partesDanadas: document.getElementById('letterPartesDanadas').value,
        nombreTercero: document.getElementById('letterNombreTercero').value,
        dniTercero: document.getElementById('letterDniTercero').value,
        relato: document.getElementById('letterRelato').value,
        infracciones: document.getElementById('letterInfracciones').value,
        hayLesiones: hayLesiones,
        lesionesDesc: hayLesiones ? document.getElementById('letterLesionesDesc').value : '',
        montoLesiones: montoLesiones,
        montoTotal: montoMateriales + montoLesiones
    };

    const generatedLetter = await callAIApi(data);

    const resultHTML = `
        <span class="close" onclick="closeModal('letterGenerationModal')">&times;</span>
        <h2>‚úÖ Carta Generada</h2>
        <textarea id="generatedLetterText" readonly style="width:100%;height:45vh;font-family:monospace;">${generatedLetter}</textarea>
        <div class="action-buttons">
            <button class="btn btn-info" onclick="copyToClipboard('generatedLetterText')">üìã Copiar</button>
            <button class="btn btn-danger" onclick="downloadAsPDF()">üìÑ PDF</button>
            <button class="btn btn-success" onclick="downloadAsWord()">üìÑ Word</button>
        </div>
    `;
    modalContent.innerHTML = resultHTML;
}

async function callAIApi(data) {
    try {
        const response = await fetch(API_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data),
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.detalle || 'Error desconocido del servidor');
        }
        return await response.text();
    } catch (error) {
        console.error("Error al llamar a la API del servidor:", error);
        return `ERROR: No se pudo conectar con el servidor.\n\nDetalles: ${error.message}`;
    }
}

function copyToClipboard(elementId) {
    document.getElementById(elementId).select();
    document.execCommand('copy');
    updateDataStatus('‚úÖ Texto copiado.');
}

function downloadAsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const text = document.getElementById('generatedLetterText').value;
    const splitText = doc.splitTextToSize(text, 180);
    doc.text(splitText, 15, 20);
    doc.save('CartaDePatrocinio.pdf');
}

function downloadAsWord() {
    const text = document.getElementById('generatedLetterText').value;
    const content = `
        <!DOCTYPE html><html><head><meta charset="UTF-8"></head><body>
        <pre style="font-family: 'Courier New', monospace; white-space: pre-wrap;">${text}</pre>
        </body></html>
    `;
    const blob = htmlDocx.asBlob(content);
    saveAs(blob, 'CartaDePatrocinio.doc');
}


// --- L√≥gica de inicializaci√≥n ---
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  renderAllSiniestrosList();
});

window.addEventListener('click', e => {
    if (e.target.classList.contains('modal')) {
        closeModal(e.target.id);
    }
});
</script>
</body>
</html>
