<!DOCTYPE html>
<html lang="es-AR">
<head>
<meta charset="UTF-8">
<title>Planilla de Siniestros - Garc√≠a & Asociados</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
<style>
:root {
    --primary-color: #2980b9;
    --secondary-color: #3498db;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --success-color: #2ecc71;
    --info-color: #9b59b6; /* Color para Vencimientos */
    --light-bg: #ecf0f1;
    --dark-text: #2c3e50;
    --light-text: #ffffff;
    --border-radius: 12px;
    --shadow: 0 10px 30px rgba(0,0,0,0.1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px}
.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
.header{background:linear-gradient(135deg,#020c24 0%,#081e4b 100%);color:#fff;padding:30px;text-align:center}
.header h1{font-size:2.4em;margin-bottom:8px}
.header-clock-container{display:flex;align-items:center;justify-content:center;gap:20px;margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,.2)}
.analog-clock{width:60px;height:60px;background:rgba(255,255,255,.1);border-radius:50%;border:2px solid rgba(255,255,255,.5);position:relative;flex-shrink:0}
.analog-clock .hand{width:50%;height:2px;background:var(--light-text);position:absolute;top:50%;transform-origin:100%;transform:rotate(90deg);transition:none}
.analog-clock .hour-hand{width:35%;left:15%;background:var(--secondary-color);height:3px}
.analog-clock .min-hand{height:2px}
.analog-clock .second-hand{width:45%;left:5%;background:var(--danger-color);height:1px}
#digital-clock{font-size:1em;opacity:.9;font-weight:500;letter-spacing:.5px;text-align:left}
.main-content{padding:30px}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:30px;margin-bottom:40px}
.card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 8px 25px rgba(0,0,0,.1);border:1px solid #e0e0e0;transition:.3s}
.card:hover{transform:translateY(-5px);box-shadow:0 15px 35px rgba(0,0,0,.15)}
.card h3{color:#2c3e50;margin-bottom:18px;font-size:1.2em;display:flex;gap:8px;align-items:center}
.today-reviews{background:linear-gradient(135deg,#ff6b6b,#ee5a52);color:#fff}
.overdue-reviews{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff}
.pending-reviews{background:linear-gradient(135deg,#feca57,#ff9ff3);color:#fff}
.btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:11px 22px;border-radius:8px;cursor:pointer;font-size:.95em;margin:5px;transition:.25s}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(102,126,234,.4)}
.btn-success{background:linear-gradient(135deg,#2ecc71,#27ae60)}
.btn-info{background:linear-gradient(135deg,#3498db,#2980b9)}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b)}
.btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22)}
.btn-sm{padding:6px 14px;font-size:.8em}
.data-status{background:#d4edda;border:1px solid #c3e6cb;color:#155724;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center;font-size:.9em}
.filter-bar{background:#f8f9fa;padding:18px;border-radius:8px;margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
.form-group{margin-bottom:10px}
.form-group label{display:block;font-weight:600;margin-bottom:6px;color:#2c3e50;font-size:.85em}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:2px solid #e0e0e0;border-radius:8px;font-size:.9em}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.15)}
.reviews-list{max-height:400px;overflow:auto}
.review-item{background:#f8f9fa;border-left:4px solid #667eea;padding:14px;margin-bottom:9px;border-radius:0 8px 8px 0;display:flex;gap:10px;align-items:center;cursor:pointer;font-size:.82em}
.review-item.completed{background:#f2fdf5;border-left-color:#2ecc71;opacity:.85}
.review-item.today{border-left-color:#e74c3c}
.review-item.overdue{border-left-color:#f39c12}
.review-item:hover{background:#eef4ff}
.review-date{font-weight:600;color:#2c3e50}
.review-client{color:#667eea;font-weight:500;margin:4px 0}
.review-obs{font-style:italic;color:#555}
.review-obs-private{font-size:.9em;color:#8e44ad;font-style:italic;margin-top:5px;border-top:1px dashed #ddd;padding-top:5px}
.complete-btn{background:#e0e0e0;border:none;width:26px;height:26px;border-radius:50%;cursor:pointer;font-size:14px}
.complete-btn:hover{background:#c7c7c7}
.review-item.completed .complete-btn{background:#2ecc71;color:#fff}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);z-index:1000}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:#fff;border-radius:14px;padding:28px;max-width:900px;width:95%;max-height:90vh;overflow:auto}
#alertModal .modal-content{border-top:10px solid var(--danger-color)}
#alertModal h2{color:var(--danger-color);text-align:center;margin-bottom:20px}
.close{float:right;font-size:26px;font-weight:700;color:#999;cursor:pointer;margin-top:-8px}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px}
.info-item{background:#fff;padding:10px;border-left:3px solid #667eea;border-radius:6px}
.info-label{font-size:.65em;text-transform:uppercase;color:#666;font-weight:600;letter-spacing:.5px}
.info-value{font-size:.85em;font-weight:500;color:#2c3e50;margin-top:2px;word-break:break-word}
.editable-field{cursor:pointer;padding:2px 4px;margin:-2px -4px}
.editable-field:hover{background:#eef5ff;border-radius:4px}
.history-item{background:#fff;border:1px solid #e0e0e0;border-left:4px solid #667eea;border-radius:6px;padding:12px;margin-bottom:10px;font-size:.9rem}
.history-item.completed{opacity:.6}
.history-date{font-size:.9em;font-weight:600;color:#667eea;margin-bottom:4px}
.history-revision-date{color:#c0392b;font-size:.85em;margin-top:4px}
.private-note-details{margin-top:10px}
.private-note-summary{cursor:pointer;font-weight:600;color:#8e44ad;-webkit-user-select:none;user-select:none;font-size:.9em}
.private-note-summary::-webkit-details-marker{display:none}
.private-note-summary:before{content:'‚ûï';display:inline-block;margin-right:8px}
.private-note-details[open] .private-note-summary:before{content:'‚ûñ'}
.private-note-content{background:#fdf5e6;border-left:3px solid #f39c12;padding:10px;margin-top:8px;border-radius:5px;font-style:italic;color:#666}
.history-item-mediacion{border-left-color:#1abc9c}
.history-item-vencimiento{border-left-color:var(--info-color)} /* Estilo para Vencimiento */
.history-tag{font-size:.8em;color:#fff;padding:2px 8px;border-radius:10px;margin-left:auto;font-weight:500;display:inline-block}
.tag-task{background-color:var(--secondary-color)}
.tag-mediacion{background-color:#1abc9c}
.tag-vencimiento{background-color:var(--info-color)} /* Estilo para Vencimiento */
.form-section{background:#f8f9fa;padding:16px;border:1px solid #e0e0e0;border-radius:10px;margin-top:16px}
.action-buttons{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:18px}
.progress-bar-container{width:80%;margin:20px auto;height:20px;background-color:#ecf0f1;border-radius:10px;overflow:hidden}
.progress-bar{width:0;height:100%;background:linear-gradient(90deg,var(--secondary-color),var(--primary-color));transition:width .2s ease-out}
@media (max-width:780px){.reviews-list{max-height:300px}.action-buttons .btn{flex:1 1 100%}}
@media print{body *{visibility:hidden}.print-area,.print-area *{visibility:visible}.print-area{position:absolute;left:0;top:0;width:100%;padding:20px}.btn,.no-print{display:none!important}#generatedLetterText{white-space:pre-wrap}}

.weekly-glance{display:flex;justify-content:space-around;padding:15px 0 5px 0;gap:10px;flex-wrap:wrap;transition:all .4s ease-in-out}
.day-circle{display:flex;flex-direction:column;align-items:center;justify-content:center;width:70px;height:70px;border-radius:50%;background:#f0f4f7;border:2px solid #e1e8ed;transition:all .3s ease}
.day-circle.has-tasks{background:#fff9e6;border-color:var(--warning-color);font-weight:700;cursor:pointer}
.day-circle.has-tasks:hover{transform:scale(1.1);box-shadow:0 0 15px rgba(243,156,18,.5)}
.day-circle.is-today{background:#e8f2ff;border-color:var(--primary-color)}
.day-circle .day-name{font-size:.9em;font-weight:600;color:var(--dark-text)}
.day-circle .day-count{font-size:1.4em;color:var(--primary-color);margin-top:2px}
.day-circle.has-tasks .day-count{color:#d35400}
.toggle-icon{display:inline-block;margin-left:8px}
</style>
</head>
<body>

<datalist id="marcasVehiculosList"></datalist>

<div class="container">
  <div class="header">
    <h1>üö¶ Planilla de Siniestros</h1>
    <p>Garc√≠a & Asociados</p>
    <div class="header-clock-container">
        <div class="analog-clock">
            <div class="hand hour-hand"></div>
            <div class="hand min-hand"></div>
            <div class="hand second-hand"></div>
        </div>
        <div id="digital-clock"></div>
    </div>
  </div>

  <div class="main-content">
    <div id="dataStatus" class="data-status">Cargando datos...</div>
    <div id="driveStatus" class="data-status" style="display:none;"></div>

    <section class="card" style="margin-bottom: 30px;">
        <h3 onclick="toggleVisibility('weeklyGlanceContainer')" style="cursor: pointer; user-select: none;">
            üóìÔ∏è Resumen de la Pr√≥xima Semana
            <span class="toggle-icon">‚ûñ</span>
        </h3>
        <div id="weeklyGlanceContainer" class="weekly-glance"></div>
    </section>
    
    <section class="card" style="margin-bottom: 30px; background-color: #e7f5ff;">
        <h3 onclick="toggleVisibility('advanceNoticeContainer')" style="cursor: pointer; user-select: none; border-color: #b3e0ff;">
            üîî Avisos Previos (Vencimientos y Mediaciones) (<span id="advanceNoticeCount">0</span>)
            <span class="toggle-icon">‚ûñ</span>
        </h3>
        <div id="advanceNoticeContainer" class="reviews-list" style="max-height: 300px; display: block;"></div>
    </section>

    <div class="dashboard">
      <div class="card today-reviews"><h3>Eventos de Hoy</h3><div class="reviews-list" id="todayReviews"></div></div>
      <div class="card overdue-reviews"><h3>Eventos Vencidos</h3><div class="reviews-list" id="overdueReviews"></div></div>
      <div class="card pending-reviews"><h3>Pr√≥ximos Eventos</h3><div class="reviews-list" id="upcomingReviews"></div></div>
    </div>

    <div style="text-align:center;margin-bottom:26px;">
      <button class="btn btn-success" onclick="showNewSiniestroModal()">‚ûï Agregar Siniestro</button>
      <button class="btn" onclick="showSiniestroSelectorModal()">üëÅÔ∏è Ver/Editar Siniestro</button>
      <button class="btn" onclick="exportToExcel()">üìä Exportar Excel</button>
      <button class="btn" onclick="exportData()">üíæ Exportar JSON</button>
      <button class="btn btn-warning" onclick="importData()">üì• Importar JSON</button>
    </div>

    <div style="text-align:center;border-top:1px solid #ddd;padding-top:18px;margin-bottom:25px;">
      <button id="connectDriveBtn" class="btn" onclick="handleAuthClick()">üîó Conectar a Drive & Calendar</button>
      <button id="saveToDriveBtn" class="btn btn-success" style="display:none;" onclick="saveToDrive()">üì§ Guardar en Drive</button>
      <button id="loadFromDriveBtn" class="btn btn-warning" style="display:none;" onclick="loadFromDrive()">üì• Cargar de Drive</button>
    </div>

    <div class="filter-bar">
      <div class="form-group"><label>B√∫squeda General</label><input type="text" id="searchInput" placeholder="Cliente, DNI, reclamo..." onkeyup="renderAllSiniestrosList()"></div>
      <div class="form-group"><label>Estado</label><select id="estadoFilter" onchange="renderAllSiniestrosList()"><option value="">Todos</option><option value="RECHAZADO">Rechazado</option><option value="SIN INICIAR">Sin iniciar</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA P">Finalizada P</option><option value="EJECUCION">Ejecuci√≥n</option><option value="DEMORADA">Demorada</option></select></div>
    </div>

    <div class="card">
      <h3>üìã Todos los Siniestros</h3>
      <div id="allSiniestros" class="reviews-list" style="max-height:580px;"></div>
    </div>
  </div>
</div>

<input type="file" id="importInput" accept=".json" style="display:none" onchange="handleImport(event)">

<div id="newSiniestroModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroSelectorModal" class="modal"><div class="modal-content"></div></div>
<div id="siniestroInfoModal" class="modal"><div class="modal-content"></div></div>
<div id="alertModal" class="modal"><div class="modal-content"></div></div>
<div id="rescheduleModal" class="modal"><div class="modal-content"></div></div>
<div id="letterGenerationModal" class="modal"><div class="modal-content"></div></div>
<div id="dailyTasksModal" class="modal"><div class="modal-content"></div></div>

<script>
let siniestrosData=[];
let editingSiniestroId=null,editingField=null;

// --- INICIO: C√ìDIGO DE GOOGLE DRIVE Y CALENDAR ---
let tokenClient, gapiReady = false, gisReady = false, gdDataFileId = null;
const GD_CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
const GD_API_KEY = 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
const GD_SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/calendar.events';
const GD_DATA_FILE = 'datos_planilla_siniestros.json';

document.addEventListener('DOMContentLoaded', ()=>{ 
    loadData(); 
    renderAll(); 
    updateClock(); 
    setInterval(updateClock, 1000); 
    iniciarVigilanteDeMediaciones(); 
    revisarMediacionesVencidasAlCargar();
    // --- NUEVO: Listener para cerrar modales al hacer clic afuera ---
    window.addEventListener('click', e => { if (e.target.classList.contains('modal')) { closeModal(e.target.id); } });
});
function gapiLoaded(){ gapi.load('client', initializeGapiClient); }
async function initializeGapiClient(){ try{ await gapi.client.init({ apiKey: GD_API_KEY, discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest','https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'] }); gapiReady=true; }catch(e){ console.error("Error GAPI client init:",e); updateDriveStatus('‚ùå Error al inicializar APIs de Google.'); }}
function gisLoaded(){ try{ tokenClient=google.accounts.oauth2.initTokenClient({ client_id:GD_CLIENT_ID, scope:GD_SCOPES, callback:tokenResponseCallback }); gisReady=true; }catch(e){ console.error("Error GIS client init:",e); updateDriveStatus('‚ùå Error al inicializar autenticaci√≥n de Google.'); }}
function handleAuthClick(){ if(tokenClient){ tokenClient.requestAccessToken({prompt:'consent'}); }else{ updateDriveStatus('‚ùå La autenticaci√≥n de Google no est√° lista.'); }}
async function tokenResponseCallback(resp){ if(resp.error){ updateDriveStatus('‚ùå Error de autenticaci√≥n. Verifique pop-ups.'); return; } try{ gapi.client.setToken({access_token:resp.access_token}); document.getElementById('connectDriveBtn').style.display='none'; document.getElementById('saveToDriveBtn').style.display='inline-block'; document.getElementById('loadFromDriveBtn').style.display='inline-block'; updateDriveStatus('‚úÖ Conectado. Buscando respaldo...'); await findDataFile(); }catch(e){ console.error("Error en callback:",e); updateDriveStatus('‚ùå Ocurri√≥ un error despu√©s de conectar.'); }}
async function findDataFile(){ updateDriveStatus('üîé Buscando archivo de Drive...'); try{ const r=await gapi.client.drive.files.list({q:`name='${GD_DATA_FILE}' and trashed=false`,fields:'files(id,name)',spaces:'drive'}); if(r.result.files&&r.result.files.length>0){ gdDataFileId=r.result.files[0].id; updateDriveStatus('‚úÖ Conexi√≥n exitosa. Archivo encontrado.'); }else{ updateDriveStatus('‚ö†Ô∏è Conexi√≥n exitosa. No existe archivo (se crear√° al guardar).'); }}catch(e){ console.error("Error buscando archivo:",e); updateDriveStatus(`‚ùå Error buscando archivo: ${e.result?.error?.message}`); }}
async function saveToDrive(){ if(!gapi.client.getToken()?.access_token){alert('No est√° conectado a Google.');return;} if(!confirm('¬øGuardar datos en Drive?'))return; updateDriveStatus('üíæ Guardando en Drive...'); const content=JSON.stringify(siniestrosData,null,2); try{ let request; if(gdDataFileId){ request=gapi.client.request({path:`/upload/drive/v3/files/${gdDataFileId}`,method:'PATCH',params:{uploadType:'media'},body:content}); }else{ const metadata={name:GD_DATA_FILE,mimeType:'application/json'}; request=gapi.client.drive.files.create({resource:metadata,media:{mimeType:'application/json',body:content},fields:'id'}); } const response=await request; if(response.result.id)gdDataFileId=response.result.id; updateDriveStatus('‚úÖ Guardado en Drive con √©xito.'); }catch(e){ console.error('Error en saveToDrive:',e); updateDriveStatus(`‚ùå Error al guardar: ${e.result?.error?.message||e.message}`); }}
async function loadFromDrive(){ if(!gapi.client.getToken()?.access_token){alert('No est√° conectado a Google.');return;} if(!gdDataFileId){alert('No se ha encontrado un archivo de respaldo.');return;} if(!confirm('¬øReemplazar datos locales con la copia de Drive?'))return; updateDriveStatus('üì• Cargando desde Drive...'); try{ const response=await gapi.client.drive.files.get({fileId:gdDataFileId,alt:'media'}); const imported=JSON.parse(response.body); if(!Array.isArray(imported))throw new Error('Formato inv√°lido.'); siniestrosData=sanitizeData(imported); saveData(); renderAll(); updateDriveStatus('‚úÖ Datos cargados desde Drive.'); }catch(e){ console.error("Error cargando datos:",e); updateDriveStatus(`‚ùå Error al cargar: ${e.result?.error?.message||e.message}`); }}
function addEventToGoogleCalendar(siniestro,item,type){ if(!gapi.client.getToken()?.access_token){updateDriveStatus('‚ö†Ô∏è No conectado a Google. Evento no agendado.');return;} const title=`${type}: ${siniestro.cliente}`; const description=`Caso: ${siniestro.cliente} vs ${siniestro.contra||'N/A'}\nN¬∞ Reclamo: ${siniestro.numeroReclamo||'S/N'}\n\nDescripci√≥n: ${item.texto}`; const isAllDay=type==='Vencimiento'; let start,end; if(isAllDay){ start={date:item.fecha}; end={date:item.fecha}; }else{ const eventStartTime=new Date(`${item.fecha}T${item.hora}:00`); const eventEndTime=new Date(eventStartTime.getTime()+36e5); start={dateTime:eventStartTime.toISOString(),timeZone:'America/Argentina/Buenos_Aires'}; end={dateTime:eventEndTime.toISOString(),timeZone:'America/Argentina/Buenos_Aires'}; } const event={summary:title,description:description,start:start,end:end}; updateDriveStatus(`üóìÔ∏è Agendando ${type} en Google Calendar...`); gapi.client.calendar.events.insert({calendarId:'primary',resource:event}).then(r=>{console.log('Evento creado:',r.result);updateDriveStatus(`‚úÖ ${type} agendado en Google Calendar.`);}).catch(e=>{console.error("Error creando evento:",e);updateDriveStatus(`‚ùå Error al crear evento: ${e.result?.error?.message||'Error'}`);});}
// --- FIN: C√ìDIGO DE GOOGLE DRIVE Y CALENDAR ---

function saveData(){ try{ localStorage.setItem('planilla_siniestros_data',JSON.stringify(siniestrosData)); }catch(e){ console.error('Error al guardar:',e); updateDataStatus('‚ùå Error al guardar datos',true); }}
function loadData(){ try{ const saved=localStorage.getItem('planilla_siniestros_data'); if(saved){ siniestrosData=JSON.parse(saved); siniestrosData=sanitizeData(siniestrosData); }else{ siniestrosData=[]; updateDataStatus('üìã Planilla lista para usar'); }}catch(e){ console.error('Error al cargar:',e); siniestrosData=[]; updateDataStatus('‚ùå Error al cargar datos',true); }}
function sanitizeData(data){ if(!Array.isArray(data))data=[]; (data||[]).forEach(s=>{ if(!s||typeof s!=='object')return; s.id=s.id||generateId(s); s.observaciones=Array.isArray(s.observaciones)?s.observaciones:[]; s.mediaciones_list=Array.isArray(s.mediaciones_list)?s.mediaciones_list:[]; s.vencimientos_list=Array.isArray(s.vencimientos_list)?s.vencimientos_list:[]; s.observaciones.forEach(o=>{o.id=o.id||generateId({});o.completed=typeof o.completed==='boolean'?o.completed:false;}); s.mediaciones_list.forEach(m=>{m.id=m.id||generateId({});m.completed=typeof m.completed==='boolean'?m.completed:false;m.alertaMostrada=typeof m.alertaMostrada==='boolean'?m.alertaMostrada:false;m.avisoPrevio=m.avisoPrevio||'1';}); s.vencimientos_list.forEach(v=>{v.id=v.id||generateId({});v.completed=typeof v.completed==='boolean'?v.completed:false;v.avisoPrevio=v.avisoPrevio||'1';}); try{updateSiniestroNextRevision(s);}catch(e){console.error('Error en revisi√≥n:',e);}}); return data; }
function updateDataStatus(msg,isError=false){ const el=document.getElementById('dataStatus'); if(el){el.textContent=msg;el.style.background=isError?'#f8d7da':'#d4edda';el.style.color=isError?'#721c24':'#155724';}}
function updateDriveStatus(msg){ const el=document.getElementById('driveStatus'); if(el){el.textContent=msg;el.style.display='block';el.style.background='#d1ecf1';el.style.color='#0c5460';setTimeout(()=>{el.style.display='none';},5e3);}}
const todayYMD = (d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`)(new Date());
function formatDate(d){ if(!d)return'No definida'; const date=new Date(d); const adjustedDate=new Date(date.getTime()+date.getTimezoneOffset()*6e4); const[y,m,day]=adjustedDate.toISOString().split('T')[0].split('-'); return`${day}/${m}/${y}`; }
function formatTime(t){ return t||''; }
function isToday(d){ return d&&d===todayYMD; }
function isPastDue(d){ return d&&d<todayYMD; }
function getDaysDifference(d){ if(!d)return 999; return Math.ceil((new Date(d)-new Date(todayYMD))/864e5); }
function generateId(it){ return`EVT_${(it.cliente||'S').slice(0,3).toUpperCase()}_${Date.now()}_${Math.floor(Math.random()*1e3)}`; }
function getDisplayName(s){ return`${s.cliente||'S/N'} - Reclamo: ${s.numeroReclamo||'S/N'} (${s.estado||'S/E'})`; }
function formatCurrency(v){ if(v==null||v==='')return'S/D'; return new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'}).format(v); }
function toggleVisibility(id){ const el=document.getElementById(id),icon=el.previousElementSibling.querySelector('.toggle-icon'); const isFlex=el.classList.contains('weekly-glance'); if(getComputedStyle(el).display==='none'){el.style.display=isFlex?'flex':'block';icon.textContent='‚ûñ';}else{el.style.display='none';icon.textContent='‚ûï';}}
function updateSiniestroNextRevision(s){ if(!s)return; const future=(s.observaciones||[]).filter(o=>!o.completed&&o.proximaRevision).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision)); if(future.length){s.fechaRevision=future[0].proximaRevision;s.observacion=future[0].texto;if(future[0].textoPrivado)s.observacion+=` (Privado: ${future[0].textoPrivado})`;}else{s.fechaRevision='';s.observacion='No hay tareas pendientes';}}
function toggleCompleted(e,sid,oid,type='task'){ e.stopPropagation(); const s=siniestrosData.find(x=>x.id===sid); if(!s)return; let list; if(type==='task')list=s.observaciones; else if(type==='mediacion')list=s.mediaciones_list; else if(type==='vencimiento')list=s.vencimientos_list; if(list){const item=list.find(y=>y.id===oid);if(item)item.completed=!item.completed;} if(type==='task')updateSiniestroNextRevision(s); saveData(); renderAll(); }
function renderAll(){ try{ siniestrosData.forEach(updateSiniestroNextRevision); renderWeeklyGlance(); renderAdvanceNotices(); renderDashboardLists(); renderAllSiniestrosList(); }catch(e){ console.error('Error al renderizar:',e); updateDataStatus('‚ùå Error al actualizar la vista',true); }}
function renderWeeklyGlance(){ const container=document.getElementById('weeklyGlanceContainer'); if(!container)return; const counts=Array(7).fill(0); const today=new Date(); today.setHours(0,0,0,0); const allItems=siniestrosData.flatMap(s=>[...(s.observaciones||[]).filter(o=>!o.completed&&o.proximaRevision).map(o=>({reviewDate:o.proximaRevision})),...(s.mediaciones_list||[]).filter(m=>m.fecha&&!m.completed).map(m=>({reviewDate:m.fecha})),...(s.vencimientos_list||[]).filter(v=>v.fecha&&!v.completed).map(v=>({reviewDate:v.fecha}))]); allItems.forEach(item=>{if(!item.reviewDate)return; const diffDays=Math.round((new Date(item.reviewDate+'T00:00:00')-today)/864e5); if(diffDays>=0&&diffDays<7)counts[diffDays]++;}); const dayNames=['D','L','M','M','J','V','S']; let html=''; for(let i=0;i<7;i++){ const date=new Date(today); date.setDate(today.getDate()+i); const isoDateString=`${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`; const hasTasks=counts[i]>0; html+=`<div class="day-circle ${hasTasks?'has-tasks':''} ${i===0?'is-today':''}" title="${date.toLocaleDateString('es-AR',{weekday:'long',day:'numeric',month:'long'})}" ${hasTasks?`onclick="showTasksForDate('${isoDateString}')"`:''}> <span class="day-name">${dayNames[date.getDay()]} ${date.getDate()}</span> <span class="day-count">${counts[i]}</span> </div>`; } container.innerHTML=html||'<p>No hay tareas en los pr√≥ximos 7 d√≠as.</p>'; }
function renderAdvanceNotices(){ const container=document.getElementById('advanceNoticeContainer'); if(!container)return; const itemsToNotice=[]; siniestrosData.forEach(s=>{ const criticalItems=[...(s.mediaciones_list||[]).map(item=>({...item,dueDate:item.fecha,type:'mediacion',text:`MEDIACI√ìN: ${item.texto}`})),...(s.vencimientos_list||[]).map(item=>({...item,dueDate:item.fecha,type:'vencimiento',text:`VENCIMIENTO: ${item.texto}`}))]; criticalItems.forEach(item=>{ const noticeDays=parseInt(item.avisoPrevio,10); if(!item.completed&&noticeDays>0&&item.dueDate){ const daysDifference=getDaysDifference(item.dueDate); if(daysDifference>0&&daysDifference<=noticeDays)itemsToNotice.push({siniestro:s,item,daysDifference}); }}); }); itemsToNotice.sort((a,b)=>a.item.dueDate.localeCompare(b.item.dueDate)); document.getElementById('advanceNoticeCount').textContent=itemsToNotice.length; if(itemsToNotice.length===0){container.innerHTML='<p style="text-align:center;color:#666;">No hay avisos previos.</p>';return;} container.innerHTML=itemsToNotice.map(({siniestro,item,daysDifference})=>{ const dateInfo=`Vence en ${daysDifference} d√≠a${daysDifference>1?'s':''} (${formatDate(item.dueDate)})`; return`<div class="review-item" onclick="showSiniestroModal('${siniestro.id}')"><div class="review-item-content"><div class="review-date">${dateInfo}</div><div class="review-client">${getDisplayName(siniestro)}</div><div class="review-obs">${item.text}</div></div></div>`; }).join(''); }
function showTasksForDate(dateString){ const formattedDate=formatDate(dateString); const modal=document.getElementById('dailyTasksModal'); const tasksForDate=siniestrosData.flatMap(s=>[...(s.observaciones||[]).filter(o=>!o.completed&&o.proximaRevision===dateString).map(o=>({...o,siniestro:s,type:'task'})),...(s.mediaciones_list||[]).filter(m=>!m.completed&&m.fecha===dateString).map(m=>({...m,siniestro:s,type:'mediacion'})),...(s.vencimientos_list||[]).filter(v=>!v.completed&&v.fecha===dateString).map(v=>({...v,siniestro:s,type:'vencimiento'}))]); const content=` <span class="close" onclick="closeModal('dailyTasksModal')">&times;</span><h2>Tareas para ${formattedDate}</h2> <div class="reviews-list" style="max-height:60vh;"> ${tasksForDate.length===0?'<p style="text-align:center;color:#666;">No hay tareas para esta fecha.</p>':tasksForDate.map(item=>{ const toggleFunc=`toggleCompleted(event,'${item.siniestro.id}','${item.id}','${item.type}')`; let timeLabel='',label=''; if(item.type==='mediacion'){timeLabel=formatTime(item.hora);label='MEDIACI√ìN:';} if(item.type==='vencimiento'){label='VENCIMIENTO:';} return`<div class="review-item"> <button class="complete-btn" onclick="${toggleFunc}">‚úî</button> <div class="review-item-content" onclick="showSiniestroModal('${item.siniestro.id}')"> <div class="review-date">${timeLabel}</div> <div class="review-client">${item.siniestro.cliente}</div> <div class="review-obs"><b>${label}</b> ${item.texto}</div> ${item.type==='task'&&item.textoPrivado?`<div class="review-obs-private">üîí ${item.textoPrivado}</div>`:''} </div> </div>`; }).join('')} </div>`; modal.querySelector('.modal-content').innerHTML=content; modal.classList.add('active'); }
function renderDashboardLists(){ const tasks=siniestrosData.flatMap(s=>(s.observaciones||[]).filter(o=>!o.completed&&o.proximaRevision).map(o=>({...o,siniestro:s,type:'task'}))); const mediaciones=siniestrosData.flatMap(s=>(s.mediaciones_list||[]).filter(m=>!m.completed&&m.fecha).map(m=>({...m,siniestro:s,type:'mediacion',proximaRevision:m.fecha}))); const vencimientos=siniestrosData.flatMap(s=>(s.vencimientos_list||[]).filter(v=>!v.completed&&v.fecha).map(v=>({...v,siniestro:s,type:'vencimiento',proximaRevision:v.fecha}))); const allItems=[...tasks,...mediaciones,...vencimientos]; const today=allItems.filter(t=>isToday(t.proximaRevision)); const overdue=allItems.filter(t=>isPastDue(t.proximaRevision)).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision)); const upcoming=allItems.filter(t=>getDaysDifference(t.proximaRevision)>0).sort((a,b)=>a.proximaRevision.localeCompare(b.proximaRevision)); renderReviewList('todayReviews',today,'No hay eventos para hoy','today'); renderReviewList('overdueReviews',overdue,'No hay eventos vencidos','overdue'); renderReviewList('upcomingReviews',upcoming,'No hay pr√≥ximos eventos','upcoming'); }
function renderReviewList(id,items,empty,type){ const c=document.getElementById(id); if(!c)return; const listColor=(id==='todayReviews'||id==='overdueReviews'||id==='upcomingReviews')?'var(--light-text)':'rgba(0,0,0,0.6)'; if(!items.length){c.innerHTML=`<p style="color:${listColor};text-align:center;">${empty}</p>`;return;} c.innerHTML=items.map(item=>{ let dateInfo=formatDate(item.proximaRevision); if(type==='today')dateInfo='HOY'; else if(type==='overdue')dateInfo=`VENCIDA - ${dateInfo}`; else dateInfo=`En ${getDaysDifference(item.proximaRevision)} d√≠as - ${dateInfo}`; let label='',timeLabel=''; if(item.type==='mediacion'){label='MEDIACI√ìN:';timeLabel=formatTime(item.hora);} if(item.type==='vencimiento'){label='VENCIMIENTO:';} const toggleFunc=`toggleCompleted(event,'${item.siniestro.id}','${item.id}','${item.type}')`; const privateNoteHtml=item.type==='task'&&item.textoPrivado?`<div class="review-obs-private">üîí ${item.textoPrivado}</div>`:''; return`<div class="review-item"><button class="complete-btn" onclick="${toggleFunc}">‚úî</button><div class="review-item-content" onclick="showSiniestroModal('${item.siniestro.id}')"><div class="review-date">${dateInfo} ${timeLabel}</div><div class="review-client">${item.siniestro.cliente}</div><div class="review-obs"><b>${label}</b> ${item.texto}</div>${privateNoteHtml}</div></div>`; }).join(''); }
function renderAllSiniestrosList(){ const sterm=document.getElementById('searchInput').value.toLowerCase(); const estado=document.getElementById('estadoFilter').value; const filtrados=siniestrosData.filter(s=>{ const searchString=Object.values(s).flat().join(' ').toLowerCase(); const matchS=!sterm||searchString.includes(sterm); const matchE=!estado||s.estado===estado; return matchS&&matchE; }).sort((a,b)=>(a.fechaRevision||'9999').localeCompare(b.fechaRevision||'9999')); const container=document.getElementById('allSiniestros'); if(!container)return; container.innerHTML=filtrados.length?filtrados.map(s=>{ const pending=(s.observaciones||[]).some(o=>!o.completed&&o.proximaRevision); const cls=`review-item ${!pending?'completed':''} ${isToday(s.fechaRevision)?'today':''} ${isPastDue(s.fechaRevision)?'overdue':''}`; const lastWorkedObs=(s.observaciones||[]).filter(o=>o.fechaTrabajado).sort((a,b)=>b.fechaTrabajado.localeCompare(a.fechaTrabajado))[0]; const lastWorkedDate=lastWorkedObs?lastWorkedObs.fechaTrabajado:null; return`<div class="${cls}" onclick="showSiniestroModal('${s.id}')"><div class="review-item-content"><div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;"><div class="review-date">Pr√≥x. Tarea: ${formatDate(s.fechaRevision)}</div>${lastWorkedDate?`<div class="review-date" style="color:#27ae60;">Trabajado: ${formatDate(lastWorkedDate)}</div>`:''}</div><div class="review-client">${s.cliente} - Reclamo: ${s.numeroReclamo||'S/N'}</div><div class="review-obs">${s.observacion}</div></div></div>`; }).join(''):'<p>No se encontraron siniestros.</p>'; }
function showNewSiniestroModal(){ const modal=document.getElementById('newSiniestroModal'); const content=` <span class="close" onclick="closeModal('newSiniestroModal')">&times;</span><h2>Agregar Nuevo Siniestro</h2> <form onsubmit="addNewSiniestro(event)"><div class="info-grid"> <div class="form-group"><label>Cliente</label><input type="text" id="newCliente" required></div> <div class="form-group"><label>DNI</label><input type="text" id="newDni"></div> <div class="form-group"><label>Celular</label><input type="text" id="newCelular"></div> <div class="form-group"><label>Mail Cliente</label><input type="email" id="newMailCliente"></div> <div class="form-group"><label>Estado</label><select id="newEstado"><option value="SIN INICIAR">Sin iniciar</option><option value="EJECUCION">Ejecuci√≥n</option><option value="DEMORADA">Demorada</option><option value="FINALIZADA">Finalizada</option><option value="FINALIZADA P">Finalizada P</option><option value="RECHAZADO">Rechazado</option></select></div> <div class="form-group"><label>Asegurado En</label><input type="text" id="newAseguradoEn"></div> <div class="form-group"><label>Contra</label><input type="text" id="newContra"></div> <div class="form-group"><label>N¬∞ Reclamo</label><input type="text" id="newNumeroReclamo"></div> <div class="form-group"><label>Presupuesto</label><input type="number" id="newPresupuesto" step="0.01"></div> <div class="form-group"><label>Indemnizaci√≥n</label><input type="number" id="newIndemnizacion" step="0.01"></div> <div class="form-group"><label>Honorarios</label><input type="number" id="newHonorarios" step="0.01"></div> </div><div style="text-align:center;margin-top:20px;"><button type="submit" class="btn btn-success">Guardar Siniestro</button><button type="button" class="btn" onclick="closeModal('newSiniestroModal')">Cancelar</button></div></form>`; modal.querySelector('.modal-content').innerHTML=content; modal.classList.add('active'); }
function addNewSiniestro(e){ e.preventDefault(); const newSiniestro={id:generateId({cliente:document.getElementById('newCliente').value}),cliente:document.getElementById('newCliente').value,dni:document.getElementById('newDni').value,celular:document.getElementById('newCelular').value,mailCliente:document.getElementById('newMailCliente').value,estado:document.getElementById('newEstado').value,aseguradoEn:document.getElementById('newAseguradoEn').value,contra:document.getElementById('newContra').value,numeroReclamo:document.getElementById('newNumeroReclamo').value,presupuesto:document.getElementById('newPresupuesto').value,indemnizacion:document.getElementById('newIndemnizacion').value,honorarios:document.getElementById('newHonorarios').value,observaciones:[],mediaciones_list:[],vencimientos_list:[],cobradoCliente:'No',cobradoEstudio:'No',fechaCobro:''}; siniestrosData.push(newSiniestro); saveData(); renderAll(); closeModal('newSiniestroModal'); }
function showSiniestroSelectorModal(){ const modal=document.getElementById('siniestroSelectorModal'); modal.querySelector('.modal-content').innerHTML=`<span class="close" onclick="closeModal('siniestroSelectorModal')">&times;</span><h2>Seleccionar Siniestro</h2><div class="form-group"><select id="siniestroSelector" class="form-control" onchange="loadSiniestroInfo()"><option value="">-- Seleccionar --</option>${[...siniestrosData].sort((a,b)=>(a.cliente||'').localeCompare(b.cliente||'')).map(s=>`<option value="${s.id}">${getDisplayName(s)}</option>`).join('')}</select></div><div style="text-align:center;margin-top:20px;"><button class="btn" onclick="closeModal('siniestroSelectorModal')">Cancelar</button></div>`; modal.classList.add('active'); }
function loadSiniestroInfo(){ const id=document.getElementById('siniestroSelector').value; if(id){closeModal('siniestroSelectorModal');showSiniestroModal(id);} }
function closeModal(id){ const modal=document.getElementById(id); if(modal)modal.classList.remove('active'); editingSiniestroId=null; editingField=null; }
function showSiniestroModal(id){ const s=siniestrosData.find(x=>x.id===id); if(!s)return; updateSiniestroNextRevision(s); const aseguradoras=[...new Set(siniestrosData.map(s=>s.aseguradoEn).filter(Boolean))]; const contras=[...new Set(siniestrosData.map(s=>s.contra).filter(Boolean))]; const datalistsHTML=`<datalist id="aseguradorasList">${aseguradoras.map(a=>`<option value="${a}"></option>`).join('')}</datalist><datalist id="contrasList">${contras.map(c=>`<option value="${c}"></option>`).join('')}</datalist>`; const html=` <span class="close" onclick="closeModal('siniestroInfoModal')">&times;</span><h2 style="margin-bottom:12px;">üè• ${s.cliente}</h2> <div class="info-grid">${Object.entries({cliente:'Cliente (Titular)',dni:'DNI (Titular)',celular:'Celular',mailCliente:'Mail Cliente',estado:'Estado',conductorNombre:'Nombre Conductor',conductorDni:'DNI Conductor',aseguradoEn:'Aseguradora Cliente',polizaCliente:'P√≥liza Cliente',marcaCliente:'Marca Veh. Cliente',modeloCliente:'Modelo Veh. Cliente',dominioCliente:'Dominio Veh. Cliente',anoCliente:'A√±o Veh. Cliente',contra:'Aseguradora Tercero',numeroReclamo:'N¬∞ Reclamo',fechaSiniestro:'Fecha Siniestro',horaSiniestro:'Hora Siniestro',lugarSiniestro:'Lugar Siniestro',nombreTercero:'Nombre Tercero',mailTercero:'Mail Tercero',telefonoTercero:'Tel√©fono Tercero',marcaTercero:'Marca Veh. Tercero',modeloTercero:'Modelo Veh. Tercero',dominioTercero:'Dominio Veh. Tercero',anoTercero:'A√±o Veh. Tercero',presupuesto:'Presupuesto',indemnizacion:'Indemnizaci√≥n',honorarios:'Honorarios',acuerdo:'Acuerdo',fechaPago:'Fecha Pago Cliente',factura:'Factura'}).map(([k,l])=>`<div class="info-item"><div class="info-label">${l}</div><div class="info-value editable-field" id="field-${k}" onclick="editField('${s.id}','${k}',this)">${/presupuesto|indemnizacion|honorarios/.test(k)?formatCurrency(s[k]):(k.includes('fecha')?formatDate(s[k]):(s[k]||'S/D'))}</div></div>`).join('')}<div class="info-item"><div class="info-label">Pr√≥xima Tarea</div><div class="info-value" style="color:#e74c3c;font-weight:700">${formatDate(s.fechaRevision)}</div></div></div> <div class="form-section" style="margin-top:20px;"><h4>üí∞ Informaci√≥n de Cobro</h4><div class="info-grid"><div class="info-item"><div class="info-label">Cobrado por Cliente</div><div class="info-value editable-field" onclick="editField('${s.id}','cobradoCliente',this)">${s.cobradoCliente||'No'}</div></div><div class="info-item"><div class="info-label">Cobrado por Estudio</div><div class="info-value editable-field" onclick="editField('${s.id}','cobradoEstudio',this)">${s.cobradoEstudio||'No'}</div></div><div class="info-item"><div class="info-label">Fecha de Cobro Estudio</div><div class="info-value editable-field" onclick="editField('${s.id}','fechaCobro',this)">${s.fechaCobro?formatDate(s.fechaCobro):'S/F'}</div></div></div></div> <div style="margin-top:18px;"><h4 style="margin-bottom:8px;font-size:.9em;">Historial de Eventos</h4><div id="history-list-${s.id}" style="max-height:230px;overflow:auto;padding-right:5px;">${renderHistoryList(s)}</div></div> <div style="display:grid;grid-template-columns:1fr;gap:15px;margin-top:15px;"> <div class="form-section"><h4>üìù Agregar Tarea</h4><form onsubmit="addObservation(event,'${s.id}')"><div class="form-group"><label>Texto (P√∫blico)</label><textarea id="newObsText" rows="2"></textarea></div><div class="form-group"><label>Notas (Privadas)</label><textarea id="newObsTextPrivate" rows="2"></textarea></div><div class="form-group"><label>Fecha de Revisi√≥n</label><input type="date" id="newRevisionDate" required></div><button class="btn btn-success" type="submit">Guardar Tarea</button></form></div> <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:15px;"> <div class="form-section"><h4 onclick="toggleVisibility('mediacion-form-fields')" style="cursor:pointer;user-select:none;"><span class="toggle-icon">‚ûï</span> Agendar Mediaci√≥n</h4><form id="mediacion-form-fields" onsubmit="addMediacion(event,'${s.id}')" style="display:none;margin-top:15px;"><div class="form-group"><label>Descripci√≥n</label><textarea id="newMediacionText" rows="2" required></textarea></div><div class="form-group"><label>Fecha</label><input type="date" id="newMediacionDate" required></div><div class="form-group"><label>Hora</label><input type="time" id="newMediacionTime" required></div><div class="form-group"><label>Aviso Previo</label><select id="newMediacionAvisoPrevio"><option value="1" selected>1 d√≠a antes</option><option value="2">2 d√≠as</option><option value="7">1 semana</option><option value="0">Sin aviso</option></select></div><button class="btn btn-success" type="submit">Guardar Mediaci√≥n</button></form></div> <div class="form-section"><h4 onclick="toggleVisibility('vencimiento-form-fields')" style="cursor:pointer;user-select:none;"><span class="toggle-icon">‚ûï</span> Agregar Vencimiento</h4><form id="vencimiento-form-fields" onsubmit="addVencimiento(event,'${s.id}')" style="display:none;margin-top:15px;"><div class="form-group"><label>Descripci√≥n</label><textarea id="newVencimientoText" rows="2" required></textarea></div><div class="form-group"><label>Fecha</label><input type="date" id="newVencimientoDate" required></div><div class="form-group"><label>Aviso Previo</label><select id="newVencimientoAvisoPrevio"><option value="1" selected>1 d√≠a antes</option><option value="3">3 d√≠as</option><option value="7">1 semana</option><option value="0">Sin aviso</option></select></div><button class="btn btn-success" type="submit">Guardar Vencimiento</button></form></div> </div> </div> <div class="action-buttons"><button class="btn btn-info" onclick="printFicha('${s.id}')">üñ®Ô∏è Ficha</button><button class="btn" onclick="startLetterGeneration('${s.id}')">‚úâÔ∏è Generar Carta Patrocinio</button><button class="btn btn-danger" onclick="deleteSiniestro('${s.id}')">üóëÔ∏è Eliminar</button></div>${datalistsHTML}`; document.getElementById('siniestroInfoModal').querySelector('.modal-content').innerHTML=html; document.getElementById('siniestroInfoModal').classList.add('active'); }
function renderHistoryList(s){ const tasks=(s.observaciones||[]).map(o=>({...o,type:'task',date:o.proximaRevision})); const mediaciones=(s.mediaciones_list||[]).map(m=>({...m,type:'mediacion',date:m.fecha})); const vencimientos=(s.vencimientos_list||[]).map(v=>({...v,type:'vencimiento',date:v.fecha})); const allEvents=[...tasks,...mediaciones,...vencimientos].sort((a,b)=>(b.date||'').localeCompare(a.date||'')); return allEvents.length?allEvents.map(item=>{ let tagClass,tagText,itemClass,dateLabel,dateValue,deleteFunc,timeValue=''; switch(item.type){ case'task':tagClass='tag-task';tagText='TAREA';dateLabel='Creaci√≥n';dateValue=item.fecha;deleteFunc=`deleteObs('${s.id}','${item.id}')`;break; case'mediacion':tagClass='tag-mediacion';tagText='MEDIACI√ìN';itemClass='history-item-mediacion';dateLabel='Fecha';dateValue=item.fecha;timeValue=formatTime(item.hora);deleteFunc=`deleteMediacion('${s.id}','${item.id}')`;break; case'vencimiento':tagClass='tag-vencimiento';tagText='VENCIMIENTO';itemClass='history-item-vencimiento';dateLabel='Fecha';dateValue=item.fecha;deleteFunc=`deleteVencimiento('${s.id}','${item.id}')`;break; } const privateNoteHtml=item.type==='task'&&item.textoPrivado?`<details class="private-note-details"><summary class="private-note-summary">üîí Ver Nota Privada</summary><div class="private-note-content">${item.textoPrivado}</div></details>`:''; return`<div class="history-item ${itemClass||''} ${item.completed?'completed':''}" id="${item.type}-item-${item.id}"><div style="display:flex;align-items:center;"><div class="history-date">${dateLabel}: ${formatDate(dateValue)} ${timeValue}</div><span class="history-tag ${tagClass}">${tagText}</span></div>${item.type==='task'&&item.fechaTrabajado?`<div class="history-date" style="color:#27ae60;">Trabajado: ${formatDate(item.fechaTrabajado)}</div>`:''}<div>${item.texto}</div>${privateNoteHtml}${item.type==='task'?`<div class="history-revision-date">Revisi√≥n: ${formatDate(item.proximaRevision)}</div>`:''}<div style="margin-top:6px;display:flex;gap:6px;">${item.type==='task'?`<button class="btn btn-sm" onclick="editObs('${s.id}','${item.id}')">Editar</button>`:''}<button class="btn btn-danger btn-sm" onclick="${deleteFunc}">Eliminar</button></div></div>`; }).join(''):'<p style="font-size:.8em;">Sin eventos.</p>'; }
function editObs(sid,oid){ const s=siniestrosData.find(x=>x.id===sid),o=s.observaciones.find(k=>k.id===oid); const el=document.getElementById(`task-item-${o.id}`); if(el)el.innerHTML=`<div class="form-group"><label>Texto P√∫blico</label><textarea id="edit-obs-text-${o.id}" rows="2" style="font-size:1rem;min-height:60px;">${o.texto}</textarea></div><div class="form-group"><label>Notas Privadas</label><textarea id="edit-obs-private-${o.id}" rows="2" style="font-size:1rem;min-height:60px;">${o.textoPrivado||''}</textarea></div><div class="form-group"><label>Fecha Revisi√≥n</label><input type="date" id="edit-obs-revision-${o.id}" value="${o.proximaRevision}"></div><button class="btn btn-success btn-sm" onclick="saveObs('${sid}','${o.id}')">Guardar</button><button class="btn btn-sm" onclick="showSiniestroModal('${sid}')">Cancelar</button>`; }
function saveObs(sid,oid){ const s=siniestrosData.find(x=>x.id===sid),o=s.observaciones.find(k=>k.id===oid); o.texto=document.getElementById(`edit-obs-text-${o.id}`).value;o.textoPrivado=document.getElementById(`edit-obs-private-${o.id}`).value;o.proximaRevision=document.getElementById(`edit-obs-revision-${o.id}`).value; updateSiniestroNextRevision(s);saveData();renderAll();showSiniestroModal(sid); }
function deleteObs(sid,oid){ if(!confirm('¬øEliminar tarea?'))return; const s=siniestrosData.find(x=>x.id===sid); s.observaciones=s.observaciones.filter(o=>o.id!==oid); updateSiniestroNextRevision(s);saveData();renderAll();showSiniestroModal(sid); }
function addVencimiento(e,sid){ e.preventDefault(); const s=siniestrosData.find(x=>x.id===sid); const newVencimiento={id:generateId({}),fecha:document.getElementById('newVencimientoDate').value,texto:document.getElementById('newVencimientoText').value,completed:false,avisoPrevio:document.getElementById('newVencimientoAvisoPrevio').value}; s.vencimientos_list.push(newVencimiento); saveData(); addEventToGoogleCalendar(s,newVencimiento,'Vencimiento'); renderAll(); showSiniestroModal(sid); }
function deleteVencimiento(sid,vid){ if(!confirm('¬øEliminar vencimiento?'))return; const s=siniestrosData.find(x=>x.id===sid); s.vencimientos_list=s.vencimientos_list.filter(v=>v.id!==vid); saveData(); renderAll(); showSiniestroModal(sid); }
function addMediacion(e,sid){ e.preventDefault(); const s=siniestrosData.find(x=>x.id===sid); const newMediacion={id:generateId({}),fecha:document.getElementById('newMediacionDate').value,hora:document.getElementById('newMediacionTime').value,texto:document.getElementById('newMediacionText').value,completed:false,alertaMostrada:false,avisoPrevio:document.getElementById('newMediacionAvisoPrevio').value}; s.mediaciones_list.push(newMediacion); saveData(); addEventToGoogleCalendar(s,newMediacion,'Mediaci√≥n'); renderAll(); showSiniestroModal(sid); }
function deleteMediacion(sid,mid){ if(!confirm('¬øEliminar mediaci√≥n?'))return; const s=siniestrosData.find(x=>x.id===sid); s.mediaciones_list=s.mediaciones_list.filter(m=>m.id!==mid); saveData(); renderAll(); showSiniestroModal(sid); }
function editField(sid,field,element){ if(editingField)return; editingSiniestroId=sid; editingField=field; const s=siniestrosData.find(x=>x.id===sid),currentValue=s[field]||''; let inputType='text'; if(field==='cobradoCliente'||field==='cobradoEstudio')inputType='select'; else if(/presupuesto|indemnizacion|honorarios|dni|celular|conductorDni|anoCliente|anoTercero|telefonoTercero/.test(field))inputType='number'; else if(field.includes('fecha'))inputType='date'; else if(field==='horaSiniestro')inputType='time'; else if(/mail/.test(field))inputType='email'; const input=document.createElement(inputType==='select'?'select':'input'); if(inputType==='select'){['S√≠','No'].forEach(opt=>{const o=document.createElement('option');o.value=o.textContent=opt;if(opt===currentValue)o.selected=true;input.appendChild(o);});} else{input.type=inputType;input.value=currentValue;} input.style.cssText='width:100%;font-size:0.85em;border:1px solid #667eea;padding:2px;'; if(field==='aseguradoEn')input.setAttribute('list','aseguradorasList'); if(field==='contra')input.setAttribute('list','contrasList'); if(/marca/.test(field))input.setAttribute('list','marcasVehiculosList'); const save=()=>{s[editingField]=input.value;saveData();editingSiniestroId=null;editingField=null;showSiniestroModal(sid);}; input.addEventListener('blur',save);input.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();input.blur();}}); element.innerHTML='';element.appendChild(input);input.focus();const valLength=input.value.length;input.setSelectionRange(valLength,valLength); }
function deleteSiniestro(id){ if(!confirm('¬øEliminar siniestro y todo su historial?'))return; siniestrosData=siniestrosData.filter(s=>s.id!==id); saveData(); renderAll(); closeModal('siniestroInfoModal'); }
function addObservation(e,sid){ e.preventDefault(); const s=siniestrosData.find(x=>x.id===sid); s.observaciones.push({id:generateId({}),fecha:todayYMD,texto:document.getElementById('newObsText').value,textoPrivado:document.getElementById('newObsTextPrivate').value,proximaRevision:document.getElementById('newRevisionDate').value,completed:false,fechaTrabajado:todayYMD}); updateSiniestroNextRevision(s);saveData();renderAll();showSiniestroModal(sid); }
function exportToExcel(){ const rows=siniestrosData.map(s=>{const hist=(s.observaciones||[]).map(o=>`${formatDate(o.fecha)} (Rev:${formatDate(o.proximaRevision)}) P√∫blico: ${o.texto} | Privado: ${o.textoPrivado||''}`).join(' | ');const med=(s.mediaciones_list||[]).map(m=>`${formatDate(m.fecha)} ${formatTime(m.hora)}: ${m.texto}`).join(' | ');const venc=(s.vencimientos_list||[]).map(v=>`${formatDate(v.fecha)}: ${v.texto}`).join(' | ');return{'Cliente':s.cliente,'DNI':s.dni,'Celular':s.celular,'Mail Cliente':s.mailCliente,'Conductor':s.conductorNombre,'DNI Conductor':s.conductorDni,'Estado':s.estado,'N¬∞ Reclamo':s.numeroReclamo,'Aseguradora Cliente':s.aseguradoEn,'P√≥liza Cliente':s.polizaCliente,'Marca Veh. Cliente':s.marcaCliente,'Modelo Veh. Cliente':s.modeloCliente,'Dominio Veh. Cliente':s.dominioCliente,'A√±o Veh. Cliente':s.anoCliente,'Fecha Siniestro':formatDate(s.fechaSiniestro),'Hora Siniestro':s.horaSiniestro,'Lugar Siniestro':s.lugarSiniestro,'Tercero':s.nombreTercero,'Aseguradora Tercero':s.contra,'Tel. Tercero':s.telefonoTercero,'Mail Tercero':s.mailTercero,'Marca Veh. Tercero':s.marcaTercero,'Modelo Veh. Tercero':s.modeloTercero,'Dominio Veh. Tercero':s.dominioTercero,'A√±o Veh. Tercero':s.anoTercero,'Pr√≥xima Revisi√≥n':formatDate(s.fechaRevision),'√öltima Tarea':s.observacion,'Presupuesto':s.presupuesto,'Indemnizaci√≥n':s.indemnizacion,'Honorarios':s.honorarios,'Cobrado Cliente':s.cobradoCliente,'Cobrado Estudio':s.cobradoEstudio,'Fecha Cobro Estudio':formatDate(s.fechaCobro),'Historial Tareas':hist,'Historial Mediaciones':med,'Historial Vencimientos':venc};}); const ws=XLSX.utils.json_to_sheet(rows);const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Siniestros');XLSX.writeFile(wb,`Siniestros_${todayYMD}.xlsx`); }
function exportData(){ const data=JSON.stringify(siniestrosData,null,2); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download=`siniestros_${todayYMD}.json`; a.click(); }
function importData(){ document.getElementById('importInput').click(); }
function handleImport(ev){ const f=ev.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=e=>{try{const imp=JSON.parse(e.target.result);if(Array.isArray(imp)&&confirm(`Importar ${imp.length} registros? Esto sobreescribir√° los datos locales.`)){siniestrosData=sanitizeData(imp);saveData();renderAll();}}catch(err){alert('Error al importar el archivo.');}}; r.readAsText(f); ev.target.value=''; }
function printFicha(id){ const s=siniestrosData.find(x=>x.id===id); if(!s)return; const html=`<div class="print-area"><h2>Ficha</h2><h3>${getDisplayName(s)}</h3><div>${Object.entries({cliente:'Cliente',dni:'DNI',celular:'Celular',mailCliente:'Mail',estado:'Estado',aseguradoEn:'Asegurado En',contra:'Contra',numeroReclamo:'Reclamo',marcaCliente:'Veh. Cliente',nombreTercero:'Tercero',marcaTercero:'Veh. Tercero',presupuesto:'Presupuesto',indemnizacion:'Indemnizaci√≥n',honorarios:'Honorarios',acuerdo:'Acuerdo',fechaPago:'Fecha Pago Cliente',factura:'Factura',cobradoCliente:'Cobrado Cliente',cobradoEstudio:'Cobrado Estudio',fechaCobro:'Fecha de Cobro Estudio'}).map(([k,l])=>{let val=s[k];if(k==='marcaCliente')val=`${s.marcaCliente||''} ${s.modeloCliente||''} (${s.dominioCliente||''})`;if(k==='marcaTercero')val=`${s.marcaTercero||''} ${s.modeloTercero||''} (${s.dominioTercero||''})`;return`<div style="margin:4px 0;"><b>${l}:</b> ${/presupuesto|indemnizacion|honorarios/.test(k)?formatCurrency(val):(k.includes('fecha')?formatDate(val):(val||'S/D'))}</div>`;}).join('')}</div></div>`; const w=window.open('','_blank'); w.document.write(`<html><head><title>Ficha</title><style>${document.querySelector('style').innerHTML}</style></head><body>${html}</body></html>`); w.document.close(); setTimeout(()=>{w.print();w.close();},250); }
function updateClock(){ const now=new Date(),h=now.getHours(),m=now.getMinutes(),s=now.getSeconds(); const hD=(h%12)*30+m*0.5,mD=m*6+s*0.1,sD=s*6; const hourHand=document.querySelector('.hour-hand'),minHand=document.querySelector('.min-hand'),secondHand=document.querySelector('.second-hand'),digitalClock=document.getElementById('digital-clock'); if(hourHand)hourHand.style.transform=`rotate(${hD}deg)`; if(minHand)minHand.style.transform=`rotate(${mD}deg)`; if(secondHand)secondHand.style.transform=`rotate(${sD}deg)`; if(digitalClock)digitalClock.innerHTML=`${now.toLocaleDateString('es-AR',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}<br>${now.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}`; }
function mostrarAlertaDeMediaciones(mediacionesPorAlertar){ if(mediacionesPorAlertar.length===0)return; const modal=document.getElementById('alertModal'); if(modal.classList.contains('active'))return; const content=`<span class="close" onclick="closeModal('alertModal')">&times;</span><h2>‚ö†Ô∏è ¬°Alerta de Mediaciones para Hoy!</h2><div class="reviews-list" style="max-height:60vh;">${mediacionesPorAlertar.map(alert=>`<div class="review-item today"><div class="review-item-content" style="width:100%;"><div class="review-date" style="font-size:1.1em;color:var(--danger-color);">HOY - ${formatTime(alert.item.hora)}</div><div class="review-client">${getDisplayName(alert.siniestro)}</div><div class="review-obs"><strong>Mediaci√≥n:</strong> ${alert.item.texto}</div><div style="text-align:center;margin-top:15px;display:flex;flex-wrap:wrap;gap:8px;justify-content:center;"><button class="btn btn-success btn-sm" onclick="marcarMediacionCompleta('${alert.siniestro.id}','${alert.item.id}')">‚úÖ Hecho</button><button class="btn btn-warning btn-sm" onclick="showRescheduleModal('${alert.siniestro.id}','${alert.item.id}')">üóìÔ∏è Posponer</button></div></div></div>`).join('')}</div>`; modal.querySelector('.modal-content').innerHTML=content; modal.classList.add('active'); mediacionesPorAlertar.forEach(alerta=>{const s=siniestrosData.find(s=>s.id===alerta.siniestro.id); const m=s.mediaciones_list.find(m=>m.id===alerta.item.id); if(m)m.alertaMostrada=true;}); saveData(); }
function revisarMediacionesVencidasAlCargar(){ const ahora=new Date(),horaActual=`${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`; const mediacionesVencidas=siniestrosData.flatMap(s=>(s.mediaciones_list||[]).filter(m=>isToday(m.fecha)&&m.hora&&m.hora<=horaActual&&!m.completed&&!m.alertaMostrada).map(m=>({siniestro:s,item:m}))); mostrarAlertaDeMediaciones(mediacionesVencidas); }
function iniciarVigilanteDeMediaciones(){ setInterval(()=>{const ahora=new Date(),horaActual=`${String(ahora.getHours()).padStart(2,'0')}:${String(ahora.getMinutes()).padStart(2,'0')}`; const mediacionesPorAlertar=siniestrosData.flatMap(s=>(s.mediaciones_list||[]).filter(m=>isToday(m.fecha)&&m.hora&&m.hora<=horaActual&&!m.completed&&!m.alertaMostrada).map(m=>({siniestro:s,item:m}))); if(mediacionesPorAlertar.length>0)mostrarAlertaDeMediaciones(mediacionesPorAlertar);},60000); }
function marcarMediacionCompleta(sid,mid){const s=siniestrosData.find(x=>x.id===sid);if(s){const m=s.mediaciones_list.find(y=>y.id===mid);if(m)m.completed=true;}saveData();renderAll();closeModal('alertModal');}
function showRescheduleModal(sid,mid){ const modal=document.getElementById('rescheduleModal'),s=siniestrosData.find(x=>x.id===sid),m=s.mediaciones_list.find(y=>y.id===mid); const content=`<span class="close" onclick="closeModal('rescheduleModal')">&times;</span><h3>Reprogramar Mediaci√≥n</h3><p><b>Caso:</b> ${s.cliente}</p><div class="form-group" style="margin-top:15px;"><label for="rescheduleDate">Nueva Fecha</label><input type="date" id="rescheduleDate" value="${m.fecha}" class="form-control"></div><div class="form-group"><label for="rescheduleTime">Nueva Hora</label><input type="time" id="rescheduleTime" value="${m.hora}" class="form-control"></div><div style="text-align:center;margin-top:20px;"><button class="btn btn-success" onclick="confirmReschedule('${sid}','${mid}')">Confirmar</button></div>`; modal.querySelector('.modal-content').innerHTML=content; closeModal('alertModal'); modal.classList.add('active'); }
function confirmReschedule(sid,mid){ const s=siniestrosData.find(x=>x.id===sid); if(s){const m=s.mediaciones_list.find(y=>y.id===mid); if(m){m.fecha=document.getElementById('rescheduleDate').value;m.hora=document.getElementById('rescheduleTime').value;m.alertaMostrada=false;}} saveData(); renderAll(); closeModal('rescheduleModal'); updateDataStatus(`‚úÖ Mediaci√≥n reprogramada para el ${formatDate(document.getElementById('rescheduleDate').value)}`); }

// --- INICIO: FUNCIONES DE CARTA PATROCINIO ---
function startLetterGeneration(siniestroId) { const s = siniestrosData.find(x => x.id === siniestroId); if (!s) return; const vehiculoClienteString = [s.marcaCliente, s.modeloCliente, s.anoCliente, s.dominioCliente].filter(Boolean).join(', '); const vehiculoTerceroString = [s.marcaTercero, s.modeloTercero, s.anoTercero, s.dominioTercero].filter(Boolean).join(', '); const modal = document.getElementById('letterGenerationModal'); modal.querySelector('.modal-content').innerHTML = ` <span class="close" onclick="closeModal('letterGenerationModal')">&times;</span> <h2 style="margin-bottom:14px;">‚úâÔ∏è Generar Carta de Patrocinio</h2> <p style="font-size:.9em;margin-bottom:20px;">Verifica y completa los datos. La IA redactar√° la carta.</p> <form id="letterForm" onsubmit="processLetterData(event, '${siniestroId}')"> <div class="info-grid"> <div class="form-group"><label>Lugar de Emisi√≥n</label><input type="text" id="letterLugar" value="Bernal" required></div> <div class="form-group"><label>Aseguradora del TERCERO</label><input type="text" id="letterDestinatario" value="${s.contra || ''}" required></div> <div class="form-group"><label>Domicilio Aseguradora</label><input type="text" id="letterDestinatarioDom" placeholder="Calle, N¬∞, Localidad" required></div> <div class="form-group"><label>N¬∞ P√≥liza de TU CLIENTE</label><input type="text" id="letterPolizaCliente" value="${s.polizaCliente || ''}" placeholder="Ej: 123456789" required></div> <div class="form-group"><label>Aseguradora de TU CLIENTE</label><input type="text" id="letterAseguradoraCliente" value="${s.aseguradoEn || ''}" required></div> <div class="form-group"><label>Fecha del Siniestro</label><input type="date" id="letterFechaSiniestro" value="${s.fechaSiniestro || ''}" required></div> <div class="form-group"><label>Hora del Siniestro</label><input type="time" id="letterHoraSiniestro" value="${s.horaSiniestro || ''}" required></div> <div class="form-group"><label>Lugar del Siniestro</label><input type="text" id="letterLugarSiniestro" value="${s.lugarSiniestro || ''}" placeholder="Ej: Av. Mitre esq. 9 de Julio" required></div> <div class="form-group"><label>Veh√≠culo de TU CLIENTE</label><input type="text" id="letterVehiculoCliente" value="${vehiculoClienteString}" placeholder="Marca, Modelo, A√±o, Dominio" required></div> <div class="form-group"><label>Partes da√±adas (Cliente)</label><input type="text" id="letterPartesDanadas" placeholder="Ej: paragolpes trasero, faro" required></div> <div class="form-group"><label>Nombre del TERCERO</label><input type="text" id="letterNombreTercero" value="${s.nombreTercero || ''}" required></div> <div class="form-group"><label>Veh√≠culo del TERCERO</label><input type="text" id="letterVehiculoTercero" value="${vehiculoTerceroString}" placeholder="Marca, Modelo, A√±o, Dominio"></div> </div> <div class="form-section" style="border-left:4px solid var(--secondary-color);margin-top:15px;"><div class="form-group" style="display:flex;align-items:center;gap:10px;margin-bottom:0;"><input type="checkbox" id="conductorEsTitular" onchange="toggleConductorFields(!this.checked)" style="width:auto;" checked><label for="conductorEsTitular" style="margin-bottom:0;font-weight:700;">¬øEl conductor es el titular?</label></div><div id="conductorFields" style="display:none;margin-top:15px;border-top:1px dashed #ccc;padding-top:15px;"><p style="font-size:.9em;margin-bottom:10px;">Completa los datos del conductor.</p><div class="info-grid"><div class="form-group"><label>Nombre Conductor</label><input type="text" id="letterConductorNombre" value="${s.conductorNombre || ''}"></div><div class="form-group"><label>DNI Conductor</label><input type="text" id="letterConductorDni" value="${s.conductorDni || ''}"></div></div></div></div> <div class="form-section" style="margin-top:15px;"><div class="form-group"><label>Relato de los hechos</label><textarea id="letterRelato" rows="4" placeholder="Describe c√≥mo ocurri√≥ el accidente." required></textarea></div><div class="form-group"><label>Infracciones del tercero</label><textarea id="letterInfracciones" rows="3" placeholder="Ej: Cruz√≥ en rojo, no respet√≥ prioridad, etc." required></textarea></div></div> <div class="form-section" style="border-left:4px solid var(--warning-color);margin-top:15px;"><div class="form-group" style="display:flex;align-items:center;gap:10px;margin-bottom:0;"><input type="checkbox" id="checkLesiones" onchange="toggleLesiones(this.checked)" style="width:auto;"><label for="checkLesiones" style="margin-bottom:0;font-weight:700;">¬øHubo Lesiones?</label></div><div id="lesionesFields" style="display:none;margin-top:15px;border-top:1px dashed #ccc;padding-top:15px;"><p style="font-size:.9em;margin-bottom:10px;">Completa datos de lesiones (opcional).</p><div class="form-group"><label>Descripci√≥n de lesiones</label><textarea id="letterLesionesDesc" rows="2"></textarea></div><div class="form-group"><label>Monto reclamado por Lesiones</label><input type="number" id="letterLesionesMonto" placeholder="0"></div></div></div> <div style="text-align:center;margin-top:20px;"><button class="btn btn-success" type="submit">ü§ñ Generar con IA</button></div> </form>`; modal.classList.add('active'); }
function toggleLesiones(checked){ document.getElementById('lesionesFields').style.display=checked?'block':'none'; }
function toggleConductorFields(show){ document.getElementById('conductorFields').style.display=show?'block':'none'; }
async function processLetterData(event,siniestroId){ event.preventDefault(); const s=siniestrosData.find(x=>x.id===siniestroId); if(!s){alert("Error: Siniestro no encontrado.");return;} const hayLesiones=document.getElementById('checkLesiones').checked; const montoLesiones=parseFloat(document.getElementById('letterLesionesMonto').value)||0; const montoMateriales=parseFloat(s.presupuesto)||0; let relatoOriginal=document.getElementById('letterRelato').value; if(!document.getElementById('conductorEsTitular').checked){const nombreConductor=document.getElementById('letterConductorNombre').value;const dniConductor=document.getElementById('letterConductorDni').value;let infoConductor=`Aclaraci√≥n: El veh√≠culo de mi mandante era conducido por ${nombreConductor}`;if(dniConductor){infoConductor+=`, DNI N¬∞ ${dniConductor}`;}infoConductor+='. ';relatoOriginal=infoConductor+relatoOriginal;} const data={siniestro:s,lugarEmision:document.getElementById('letterLugar').value,destinatario:document.getElementById('letterDestinatario').value,destinatarioDomicilio:document.getElementById('letterDestinatarioDom').value,polizaCliente:document.getElementById('letterPolizaCliente').value,aseguradoraCliente:document.getElementById('letterAseguradoraCliente').value,fechaSiniestro:formatDate(document.getElementById('letterFechaSiniestro').value),horaSiniestro:document.getElementById('letterHoraSiniestro').value,lugarSiniestro:document.getElementById('letterLugarSiniestro').value,vehiculoCliente:document.getElementById('letterVehiculoCliente').value,partesDanadas:document.getElementById('letterPartesDanadas').value,nombreTercero:document.getElementById('letterNombreTercero').value,vehiculoTercero:document.getElementById('letterVehiculoTercero').value,relato:relatoOriginal,infracciones:document.getElementById('letterInfracciones').value,hayLesiones:hayLesiones,lesionesDesc:hayLesiones?document.getElementById('letterLesionesDesc').value:'',montoLesiones:montoLesiones,montoTotal:montoMateriales+montoLesiones}; const modalContent=document.getElementById('letterGenerationModal').querySelector('.modal-content'); modalContent.innerHTML=`<h2 style="text-align:center;margin-bottom:20px;">üß† Redactando con IA...</h2><p id="progress-text" style="text-align:center;margin-bottom:10px;font-style:italic;color:#555;">Iniciando proceso...</p><div class="progress-bar-container"><div id="progressBar" class="progress-bar"></div></div>`; const progressBar=document.getElementById('progressBar'); const progressText=document.getElementById('progress-text'); let width=0; const interval=setInterval(()=>{width+=5;if(width>=95)return; progressBar.style.width=width+'%'; if(width>30&&width<70)progressText.textContent="Analizando mec√°nica del hecho..."; else if(width>=70)progressText.textContent="Dando formato legal...";},150); const result=await callAIApi(data); clearInterval(interval); progressBar.style.width='100%'; let resultHTML; if(result.success){ progressText.textContent="¬°Generado con √©xito!"; resultHTML=` <div class="print-area"> <span class="close no-print" onclick="closeModal('letterGenerationModal')">&times;</span> <h2 style="margin-bottom:14px;">‚úÖ Carta de Patrocinio Generada</h2> <textarea id="generatedLetterText" readonly style="width:100%;height:45vh;font-family:monospace;font-size:0.9em;padding:10px;border:1px solid #ccc;border-radius:8px;">${result.letter}</textarea> </div> <div class="action-buttons no-print" style="margin-top:15px;"> <button class="btn btn-info" onclick="copyToClipboard('generatedLetterText')">üìã Copiar Texto</button> <button class="btn" onclick="window.print()">üñ®Ô∏è Imprimir</button> <button class="btn btn-danger" onclick="downloadAsPDF()">üìÑ Descargar PDF</button> <button class="btn btn-success" onclick="downloadAsWord()">üìÑ Descargar Word</button> </div>`; }else{ progressText.textContent="Error en la generaci√≥n"; resultHTML=` <span class="close no-print" onclick="closeModal('letterGenerationModal')">&times;</span> <h2 style="color:var(--danger-color);text-align:center;">‚ùå Ocurri√≥ un Error</h2> <p style="margin-top:15px;font-size:1em;text-align:center;">No se pudo generar la carta. Motivo:</p> <textarea readonly style="width:100%;height:200px;margin-top:10px;background-color:#f3f3f3;border:1px solid #ccc;padding:10px;font-family:monospace;">${result.error}</textarea> <div class="action-buttons no-print" style="margin-top:15px;"> <button class="btn btn-warning" onclick="closeModal('letterGenerationModal')">Cerrar</button> </div>`; } modalContent.innerHTML=resultHTML; }
async function callAIApi(data){ console.log("Enviando datos al servidor:",data); const API_URL='https://portal-backend-production-3ea3.up.railway.app/api/generar-carta'; const controller=new AbortController(); const timeoutId=setTimeout(()=>controller.abort(),60000); try{ const response=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data),signal:controller.signal}); clearTimeout(timeoutId); if(!response.ok){ const errorText=await response.text(); let errorJson; try{ errorJson=JSON.parse(errorText); throw new Error(errorJson.detalle||errorJson.error||'Error desconocido del servidor.'); }catch(e){ throw new Error(errorText||`Error del servidor: ${response.status}`); }} const generatedLetter=await response.text(); return{success:true,letter:generatedLetter}; }catch(error){ clearTimeout(timeoutId); console.error("Error al llamar a la API:",error); let errorMessage=`ERROR: No se pudo conectar con el servidor para generar la carta.`; if(error.name==='AbortError'){ errorMessage=`ERROR: La solicitud tard√≥ demasiado (m√°s de 60s) y fue cancelada. Puede que el servidor est√© "despertando". Intenta de nuevo en un momento.`; }else{ errorMessage+=`\n\nDetalles: ${error.message}`; } return{success:false,error:errorMessage}; }}
function copyToClipboard(elementId){ const textArea=document.getElementById(elementId); textArea.select(); document.execCommand('copy'); updateDataStatus('‚úÖ Texto copiado al portapapeles.'); }
function downloadAsPDF(){ const{jsPDF}=window.jspdf; const doc=new jsPDF({orientation:'p',unit:'mm',format:'a4'}); const text=document.getElementById('generatedLetterText').value; const splitText=doc.splitTextToSize(text,180); const pageHeight=doc.internal.pageSize.getHeight(); let y=15; doc.setFontSize(11); for(let i=0;i<splitText.length;i++){ if(y>pageHeight-15){doc.addPage();y=15;} doc.text(splitText[i],15,y); y+=7; } doc.save('CartaDePatrocinio.pdf'); }
function downloadAsWord(){ const text=document.getElementById('generatedLetterText').value; const content=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Arial,sans-serif;font-size:12pt;}pre{font-family:Times New Roman,sans-serif;font-size:12pt;white-space:pre-wrap;word-wrap:break-word;}</style></head><body><pre>${text}</pre></body></html>`; const blob=htmlDocx.asBlob(content); saveAs(blob,'CartaDePatrocinio.doc'); }
// --- FIN: FUNCIONES DE CARTA PATROCINIO ---
</script>

<script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
