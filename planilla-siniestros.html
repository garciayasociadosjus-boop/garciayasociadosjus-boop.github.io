<!DOCTYPE html>
<html>
<head>
    <title>Prueba de Conexión a Google Drive</title>
    <style>
        body { font-family: sans-serif; padding: 2em; }
        button { font-size: 1em; padding: 10px 15px; margin-right: 10px; }
        #status { margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Prueba de Diagnóstico - Google Drive</h1>
    <p>Esta página prueba la funcionalidad más básica: conectar y crear un archivo.</p>

    <button id="connectBtn">1. Conectar a Google</button>
    <button id="createFileBtn" style="display:none;">2. Crear Archivo de Prueba</button>

    <div id="status">Estado: Esperando conexión...</div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script>
        const CLIENT_ID = '976943805178-lr5pvivhpstfnjp4leoolopo0kvb1cif.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDSMWMM3lJM4ZNqRezhH-8uxaE1GVOjrrM';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let gapiReady = false;
        let gisReady = false;

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
                });
                gapiReady = true;
                maybeEnableButtons();
            } catch (e) {
                document.getElementById('status').innerText = 'Error fatal al inicializar GAPI: ' + e.message;
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: tokenResponseCallback,
                });
                gisReady = true;
                maybeEnableButtons();
            } catch (e) {
                document.getElementById('status').innerText = 'Error fatal al inicializar GIS: ' + e.message;
            }
        }

        function maybeEnableButtons() {
            if (gapiReady && gisReady) {
                document.getElementById('connectBtn').onclick = () => tokenClient.requestAccessToken({ prompt: 'consent' });
                document.getElementById('status').innerText = 'Estado: Listo para conectar.';
            }
        }

        async function tokenResponseCallback(resp) {
            if (resp.error) {
                document.getElementById('status').innerText = 'Error de autenticación: ' + resp.error;
                return;
            }
            try {
                gapi.client.setToken({ access_token: resp.access_token });
                document.getElementById('status').innerText = 'Estado: Conectado con éxito. Listo para crear archivo.';
                document.getElementById('connectBtn').style.display = 'none';
                document.getElementById('createFileBtn').style.display = 'inline-block';
                document.getElementById('createFileBtn').onclick = createTestFile;
            } catch (e) {
                document.getElementById('status').innerText = 'Error en callback: ' + e.message;
            }
        }

        async function createTestFile() {
            document.getElementById('status').innerText = 'Creando archivo de prueba...';
            try {
                const fileMetadata = {
                    'name': 'archivo_de_prueba.txt',
                    'mimeType': 'text/plain'
                };
                const fileContent = 'Este archivo se creó con éxito a las ' + new Date().toLocaleString();

                const request = gapi.client.drive.files.create({
                    resource: fileMetadata,
                    media: {
                        mimeType: 'text/plain',
                        body: fileContent
                    },
                    fields: 'id, name'
                });

                const response = await request;
                document.getElementById('status').innerText = `¡ÉXITO! Se creó el archivo "${response.result.name}" en su Google Drive.`;

            } catch (e) {
                console.error(e);
                const errorMsg = e.result?.error?.message || e.message || "Error desconocido.";
                document.getElementById('status').innerText = 'FALLO AL CREAR ARCHIVO: ' + errorMsg;
            }
        }
    </script>
</body>
</html>
