<!doctype html>
<html lang="es" class="notranslate" translate="no">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Language" content="es">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google" content="notranslate">
  <title>Planilla Siniestros</title>
  <link rel="icon" href="activos/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="activos/style.css">
</head>
<body class="notranslate" translate="no" data-page="siniestros">
  <header class="site-header">
    <div class="brand">
      <div class="logo">G&A</div>
      <div class="titles">
        <h1 class="notranslate" translate="no">Planilla Siniestros</h1>
        <p class="muted">Gestión de reclamos de seguros</p>
      </div>
    </div>
    <nav class="top-actions">
      <a class="btn ghost" href="index.html">← Volver al portal</a>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <h2>Agregar nuevo reclamo (solo se guarda en este navegador)</h2>
      <form id="form-nuevo" class="grid-form">
        <div>
          <label for="f_cliente">Cliente</label>
          <input id="f_cliente" required>
        </div>
        <div>
          <label for="f_dni">DNI</label>
          <input id="f_dni">
        </div>
        <div>
          <label for="f_estado">Estado</label>
          <input id="f_estado" placeholder="p.ej. EN GESTIÓN">
        </div>
        <div>
          <label for="f_asegurado">Asegurado en</label>
          <input id="f_asegurado">
        </div>
        <div>
          <label for="f_contra">Contra</label>
          <input id="f_contra">
        </div>
        <div>
          <label for="f_num">N° Reclamo</label>
          <input id="f_num">
        </div>
        <div>
          <label for="f_presupuesto">Presupuesto</label>
          <input id="f_presupuesto" inputmode="numeric">
        </div>
        <div>
          <label for="f_indemnizacion">Indemnización</label>
          <input id="f_indemnizacion" inputmode="numeric">
        </div>
        <div>
          <label for="f_honorarios">Honorarios</label>
          <input id="f_honorarios" inputmode="numeric">
        </div>
        <div class="full">
          <label for="f_observacion">Observación</label>
          <input id="f_observacion">
        </div>
        <div>
          <label for="f_prox">Próxima revisión</label>
          <input id="f_prox" type="date">
        </div>
        <div class="actions">
          <button class="btn" type="submit">Agregar reclamo</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>Filtros</h2>
      <div class="filters">
        <input id="q" placeholder="Buscar (cliente, estado, aseguradora, contra, número)">
        <select id="f_estado_sel">
          <option value="">Todos los estados</option>
        </select>
        <input id="f_aseg_sel" placeholder="Filtrar por aseguradora">
        <div class="range">
          <label for="f_desde">Fecha desde</label>
          <input id="f_desde" type="date">
        </div>
        <div class="range">
          <label for="f_hasta">Fecha hasta</label>
          <input id="f_hasta" type="date">
        </div>
        <select id="f_prox_sel" title="Próximas revisiones">
          <option value="">Todas las revisiones</option>
          <option value="hoy">Hoy</option>
          <option value="7">Próximos 7 días</option>
          <option value="30">Próximos 30 días</option>
          <option value="vencidas">Vencidas</option>
        </select>
        <div class="spacer"></div>
        <button id="btn_export_json" class="btn ghost">Exportar JSON</button>
        <button id="btn_export_csv" class="btn ghost">Exportar CSV</button>
      </div>
    </section>

    <section class="card">
      <div class="table-wrap">
        <table class="table notranslate" translate="no" aria-label="Tabla de siniestros">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>DNI</th>
              <th>Estado</th>
              <th>Asegurado en</th>
              <th>Contra</th>
              <th>N° Reclamo</th>
              <th>Presupuesto</th>
              <th>Indemnización</th>
              <th>Honorarios</th>
              <th>Observación</th>
              <th>Próxima revisión</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p id="msg" class="muted"></p>
    </section>
  </main>

  <!-- Modal Observaciones -->
  <dialog id="modal">
    <form method="dialog" class="modal">
      <header class="modal-header">
        <h3>Observaciones</h3>
        <button class="icon-btn" value="close" aria-label="Cerrar">✖</button>
      </header>
      <div class="modal-body">
        <ul id="obs_list" class="obs-list"></ul>
        <fieldset>
          <legend>Agregar observación</legend>
          <div class="grid-form">
            <div>
              <label for="obs_fecha">Fecha</label>
              <input id="obs_fecha" type="date" required>
            </div>
            <div class="full">
              <label for="obs_texto">Texto</label>
              <textarea id="obs_texto" rows="3" required></textarea>
            </div>
            <div>
              <label for="obs_prox">Próxima revisión</label>
              <input id="obs_prox" type="date">
            </div>
            <div>
              <label for="obs_done">Completada</label>
              <input id="obs_done" type="checkbox">
            </div>
          </div>
          <div class="actions right">
            <button class="btn" id="obs_guardar" type="button">Guardar</button>
          </div>
        </fieldset>
      </div>
    </form>
  </dialog>

  <script src="activos/app.js"></script>
  <script>
    enforceNotranslate();

    const DATA_URL = 'datos_planilla_siniestros.json';
    const LS_ADDED_KEY = 'siniestros:added:v1';
    const LS_OBS_KEY = 'siniestros:obs:v1';

    let baseData = [];
    let viewData = [];
    let currentObsId = null;

    const tbody = document.getElementById('tbody');
    const msg = document.getElementById('msg');
    const estadoSel = document.getElementById('f_estado_sel');
    const asegSel = document.getElementById('f_aseg_sel');
    const q = document.getElementById('q');
    const fDesde = document.getElementById('f_desde');
    const fHasta = document.getElementById('f_hasta');
    const fProxSel = document.getElementById('f_prox_sel');

    fetch(DATA_URL)
      .then(r => {
        if (!r.ok) throw new Error('No se pudo cargar el archivo de datos.');
        return r.json();
      })
      .then(data => {
        baseData = Array.isArray(data) ? data : [];
        renderEstados(baseData);
        applyAndRender();
      })
      .catch(e => {
        msg.textContent = 'Error cargando datos iniciales. Si el problema persiste, verifique GitHub Pages.';
        console.error(e);
        baseData = [];
        applyAndRender();
      });

    function renderEstados(data) {
      const set = new Set(
        data.map(x => (x.estado || '').trim()).filter(Boolean)
      );
      getLocalAdded().forEach(x => set.add((x.estado || '').trim()));
      estadoSel.innerHTML = '<option value="">Todos los estados</option>' +
        Array.from(set).sort().map(s => `<option>${escapeHtml(s)}</option>`).join('');
    }

    function getLocalAdded() { return loadLSArray(LS_ADDED_KEY); }
    function getLocalObsMap() { return loadLSMap(LS_OBS_KEY); }

    function applyAndRender() {
      const merged = mergeBaseWithLocal(baseData, getLocalAdded(), 'id');
      const obsMap = getLocalObsMap();
      merged.forEach(it => {
        const baseObs = Array.isArray(it.observaciones) ? it.observaciones : [];
        const localObs = obsMap[it.id] || [];
        it._obsMerged = [...baseObs, ...localObs];
      });

      const term = (q.value || '').toLowerCase();
      const est = (estadoSel.value || '').toLowerCase();
      const aseg = (asegSel.value || '').toLowerCase();
      const d1 = fDesde.value ? new Date(fDesde.value) : null;
      const d2 = fHasta.value ? new Date(fHasta.value) : null;
      const proxMode = fProxSel.value;

      viewData = merged.filter(it => {
        const hay = (s) => (s || '').toLowerCase().includes(term);
        const passTerm = !term || [it.cliente, it.estado, it.aseguradoEn, it.contra, it.numeroReclamo].some(hay);
        const passEst = !est || (it.estado || '').toLowerCase() === est;
        const passAseg = !aseg || (it.aseguradoEn || '').toLowerCase().includes(aseg);

        const f = parseYmd(it.fechaRevision || '');
        const passFecha = (!d1 || (f && f >= d1)) && (!d2 || (f && f <= d2));

        let passProx = true;
        if (proxMode) {
          const pr = parseYmd(it.fechaRevision || '');
          const today = truncDate(new Date());
          if (!pr) {
            passProx = false;
          } else if (proxMode === 'hoy') {
            passProx = sameDay(pr, today);
          } else if (proxMode === '7' || proxMode === '30') {
            const days = Number(proxMode);
            const limit = addDays(today, days);
            passProx = pr >= today && pr <= limit;
          } else if (proxMode === 'vencidas') {
            passProx = pr < today;
          }
        }

        return passTerm && passEst && passAseg && passFecha && passProx;
      });

      renderTable(viewData);
      msg.textContent = `${viewData.length} resultado(s)`;
    }

    function renderTable(rows) {
      tbody.innerHTML = rows.map(r => {
        const prox = r.fechaRevision || '';
        const badge = statusBadge(prox);
        return `
          <tr>
            <td>${escapeHtml(r.cliente || '')}</td>
            <td>${escapeHtml(r.dni || '')}</td>
            <td>${escapeHtml(r.estado || '')}</td>
            <td>${escapeHtml(r.aseguradoEn || '')}</td>
            <td>${escapeHtml(r.contra || '')}</td>
            <td>${escapeHtml(r.numeroReclamo || '')}</td>
            <td>${escapeHtml(r.presupuesto || '')}</td>
            <td>${escapeHtml(r.indemnizacion || '')}</td>
            <td>${escapeHtml(r.honorarios || '')}</td>
            <td>${escapeHtml(r.observacion || '')}</td>
            <td>${escapeHtml(prox)} ${badge}</td>
            <td><button class="btn small" data-obs="${r.id}">Ver/Agregar</button></td>
          </tr>
        `;
      }).join('');
      tbody.querySelectorAll('button[data-obs]').forEach(b => {
        b.addEventListener('click', () => openObs(b.dataset.obs));
      });
    }

    [q, estadoSel, asegSel, fDesde, fHasta, fProxSel].forEach(el => el.addEventListener('input', applyAndRender));

    document.getElementById('form-nuevo').addEventListener('submit', (e) => {
      e.preventDefault();
      const item = {
        id: genId('SIN_'),
        cliente: document.getElementById('f_cliente').value.trim(),
        dni: document.getElementById('f_dni').value.trim(),
        estado: document.getElementById('f_estado').value.trim(),
        aseguradoEn: document.getElementById('f_asegurado').value.trim(),
        contra: document.getElementById('f_contra').value.trim(),
        numeroReclamo: document.getElementById('f_num').value.trim(),
        presupuesto: document.getElementById('f_presupuesto').value.trim(),
        indemnizacion: document.getElementById('f_indemnizacion').value.trim(),
        honorarios: document.getElementById('f_honorarios').value.trim(),
        observacion: document.getElementById('f_observacion').value.trim(),
        fechaRevision: document.getElementById('f_prox').value || ''
      };
      const added = getLocalAdded();
      added.unshift(item);
      saveLSArray(LS_ADDED_KEY, added);
      renderEstados(baseData);
      applyAndRender();
      e.target.reset();
    });

    document.getElementById('btn_export_json').addEventListener('click', () => {
      const data = exportMergedForDownload(viewData, getLocalObsMap(), 'observaciones', '_obsMerged');
      exportJSON('planilla_siniestros.json', data);
    });
    document.getElementById('btn_export_csv').addEventListener('click', () => {
      const data = exportMergedForDownload(viewData, getLocalObsMap(), 'observaciones', '_obsMerged');
      exportCSV('planilla_siniestros.csv', data, {
        cliente: 'Cliente',
        dni: 'DNI',
        estado: 'Estado',
        aseguradoEn: 'Asegurado en',
        contra: 'Contra',
        numeroReclamo: 'N° Reclamo',
        presupuesto: 'Presupuesto',
        indemnizacion: 'Indemnización',
        honorarios: 'Honorarios',
        observacion: 'Observación',
        fechaRevision: 'Próxima revisión'
      });
    });

    const dlg = document.getElementById('modal');
    const obsList = document.getElementById('obs_list');
    let currentObsId = null;

    function openObs(id) {
      currentObsId = id;
      const item = (viewData.find(x => x.id === id)) || {};
      const list = item._obsMerged || [];
      obsList.innerHTML = list.map(o => `
        <li>
          <div class="obs-head">
            <strong>${escapeHtml(o.fecha || '')}</strong>
            ${o.completed ? '<span class="chip done">Completado</span>' : '<span class="chip">Pendiente</span>'}
            ${o.proximaRevision ? `<span class="chip">${escapeHtml(o.proximaRevision)}</span>` : ''}
          </div>
          <div class="obs-body">${escapeHtml(o.texto || '')}</div>
        </li>
      `).join('') || '<li class="muted">Sin observaciones</li>';

      dlg.showModal();
    }

    document.getElementById('obs_guardar').addEventListener('click', () => {
      if (!currentObsId) return;
      const rec = {
        id: genId('OBS_'),
        fecha: document.getElementById('obs_fecha').value || todayYmd(),
        texto: document.getElementById('obs_texto').value.trim(),
        proximaRevision: document.getElementById('obs_prox').value || '',
        completed: document.getElementById('obs_done').checked
      };
      if (!rec.texto) return;

      const map = getLocalObsMap();
      map[currentObsId] = map[currentObsId] || [];
      map[currentObsId].unshift(rec);
      saveLSMap(LS_OBS_KEY, map);
      applyAndRender();
      openObs(currentObsId);
      document.getElementById('obs_texto').value = '';
      document.getElementById('obs_prox').value = '';
      document.getElementById('obs_done').checked = false;
    });
  </script>
</body>
</html>
